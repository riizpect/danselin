<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julklapp Escape Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 50%, #0a1a0a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Snowflakes animation */
        .snowflake {
            position: fixed;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            animation: fall linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            user-select: none;
        }

        h2 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff6b6b);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.9em;
        }

        .puzzle-container {
            background: rgba(20, 20, 30, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .puzzle-description {
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 1.1em;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            margin-bottom: 15px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        button {
            padding: 12px 24px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        /* Level 2: Hotspots */
        .hotspot-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .hotspot {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            border: 3px solid rgba(255, 215, 0, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            z-index: 10;
        }

        .hotspot:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        .hotspot.found {
            background: rgba(76, 175, 80, 0.5);
            border-color: #4caf50;
        }

        .hotspot.wrong {
            background: rgba(244, 67, 54, 0.5);
            border-color: #f44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Level 2: Memory Game */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            min-height: 300px;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 80px;
        }

        .memory-card:hover {
            transform: scale(1.05);
            border-color: rgba(255, 215, 0, 0.6);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #3a3a4e, #2a2a3e);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .memory-card.matched {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            cursor: default;
            opacity: 0.7;
        }

        .memory-card .card-back {
            font-size: 1.5em;
            color: rgba(255, 215, 0, 0.5);
        }

        .memory-card .card-front {
            display: none;
        }

        .memory-card.flipped .card-back {
            display: none;
        }

        .memory-card.flipped .card-front {
            display: block;
        }

        /* Level 3: Cipher */
        .cipher-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            letter-spacing: 2px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        /* Level 4: Logic Puzzle */
        .logic-grid {
            display: grid;
            grid-template-columns: 150px 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .logic-header {
            font-weight: bold;
            padding: 10px;
            background: rgba(255, 215, 0, 0.2);
            text-align: center;
            border-radius: 5px;
        }

        .logic-cell {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            text-align: center;
            border-radius: 5px;
        }

        select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            color: #fff;
        }

        /* Level 5: Fish Math Puzzle */
        .fish-math-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 10px;
            margin: 30px auto;
            max-width: 600px;
        }

        .fish-equation {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            border-radius: 5px;
        }

        .fish-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
        }

        .fish-code-input {
            margin: 30px 0;
            text-align: center;
        }

        .fish-code-input input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 5px;
            color: #fff;
        }

        .fish-code-input input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Annoying Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: all;
        }

        .annoying-popup {
            position: fixed;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
            z-index: 10000;
            cursor: pointer;
            font-size: 1.1em;
            text-align: center;
            color: #fff;
            min-width: 250px;
            animation: popupPulse 0.5s ease-out;
            user-select: none;
            pointer-events: all;
        }

        .annoying-popup.moving {
            transition: all 0.3s ease-out;
        }

        @keyframes popupPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .annoying-popup button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: #ffd700;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .annoying-popup button:hover {
            background: #ffed4e;
        }

        .annoying-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            z-index: 10001;
        }

        .annoying-popup .close-btn:hover {
            background: rgba(0,0,0,0.5);
        }
        
        /* Make close button sometimes hard to click on moving popups */
        .annoying-popup.moving .close-btn {
            cursor: crosshair;
        }

        /* Hints */
        .hint-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            border-radius: 5px;
            display: none;
        }

        .hint-container.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            display: none;
            max-width: 300px;
        }

        .admin-panel.show {
            display: block;
        }

        .admin-panel h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .admin-panel button {
            width: 100%;
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Final Reveal - R√§kna fiskar */
        .final-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 40px 20px;
        }

        .fish-count-container {
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            opacity: 0.1;
            pointer-events: none;
            position: relative;
            z-index: 1;
            min-height: 600px;
        }

        .under-construction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .construction-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        .construction-subtitle {
            font-size: 1.3em;
            color: #fff;
            margin-bottom: 40px;
        }

        .construction-game {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            max-width: 500px;
            width: 100%;
        }

        .construction-instruction {
            color: #ffd700;
            font-size: 1.2em;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .construction-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .construction-btn {
            padding: 20px;
            font-size: 1.5em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .construction-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .construction-btn:active {
            transform: scale(0.95);
        }

        .construction-btn.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
            color: #00ff00;
        }

        .construction-btn.wrong {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
            color: #ff0000;
            animation: shake 0.5s;
        }

        .construction-btn.completed {
            background: rgba(0, 255, 0, 0.5);
            border-color: #00ff00;
            color: #00ff00;
            cursor: default;
        }

        .construction-feedback {
            margin-top: 20px;
            font-size: 1.1em;
            min-height: 30px;
        }

        .construction-feedback.correct {
            color: #00ff00;
        }

        .construction-feedback.wrong {
            color: #ff0000;
        }

        .fish-count-question {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .fish-count-text {
            color: #fff;
            font-size: 1.5em;
            line-height: 1.6;
            margin: 20px 0;
            font-weight: bold;
        }

        .fish-count-timer {
            color: #ff6b6b;
            font-size: 2.5em;
            font-weight: bold;
            margin: 20px 0;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .fish-arena {
            width: 100%;
            height: 400px;
            background: linear-gradient(180deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .swimming-fish {
            position: absolute;
            font-size: 2.5em;
            user-select: none;
            pointer-events: none;
        }



        @keyframes swim {
            0% {
                transform: translateX(-100px) translateY(0);
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
                opacity: 0;
            }
        }

        .fish-count-phase {
            color: #ffd700;
            font-size: 1.1em;
            margin: 15px 0;
            font-weight: bold;
        }

        .fish-count-input-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
        }

        .fish-count-input {
            padding: 15px 25px;
            font-size: 1.5em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            text-align: center;
            font-weight: bold;
            width: 150px;
        }

        .fish-count-input:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .fish-count-submit {
            padding: 15px 30px;
            font-size: 1.3em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .fish-count-submit:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.05);
        }

        .fish-count-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .fish-count-feedback {
            text-align: center;
            margin: 20px 0;
            min-height: 50px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .fish-count-feedback.correct {
            color: #4caf50;
        }

        .fish-count-feedback.wrong {
            color: #ff6b6b;
        }

        .fish-count-feedback.timeout {
            color: #ffaa00;
        }

        .fish-count-round {
            color: #ffd700;
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .gift-box-large-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
        }

        .gift-box-large-container.show {
            display: flex;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .gift-box-large {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f, #ff8c8c);
            border: 5px solid #ffd700;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            cursor: pointer;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.6),
                        0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            transition: all 0.3s;
            animation: largeBoxPulse 2s ease-in-out infinite;
        }

        @keyframes largeBoxPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 50px rgba(255, 215, 0, 0.6), 0 20px 60px rgba(0, 0, 0, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 70px rgba(255, 215, 0, 0.8), 0 25px 70px rgba(0, 0, 0, 0.6); }
        }

        .gift-box-large:hover {
            transform: scale(1.1);
        }

        .gift-box-large.opening {
            animation: openBox 1s ease-out forwards;
        }

        @keyframes openBox {
            0% { transform: scale(1) rotateY(0deg); }
            50% { transform: scale(1.2) rotateY(90deg); }
            100% { transform: scale(1) rotateY(0deg); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .open-instruction {
            margin-top: 20px;
            color: #ffd700;
            font-size: 1.2em;
            text-align: center;
            min-height: 30px;
        }

        /* F√§rgsekvens-spel */
        .color-sequence-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            display: none;
        }

        .color-sequence-container.active {
            display: block;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
            position: relative;
        }

        .color-button {
            aspect-ratio: 1;
            border: 5px solid #fff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 0 rgba(255, 255, 255, 0.5);
        }

        .color-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .color-button:active {
            transform: scale(0.95);
        }

        .color-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .color-button.flash {
            animation: colorFlash 0.4s;
        }

        .color-button.pressed {
            transform: scale(0.9);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.6);
        }

        .color-button.moving {
            animation: colorMove 3s ease-in-out infinite;
        }

        .color-button.distraction {
            animation: distractionBlink 0.3s;
        }

        @keyframes colorFlash {
            0%, 100% { 
                transform: scale(1);
                filter: brightness(1) saturate(1);
            }
            50% { 
                transform: scale(1.15);
                filter: brightness(1.8) saturate(1.5);
                box-shadow: 0 0 50px rgba(255, 255, 255, 1),
                            0 0 80px currentColor;
            }
        }

        @keyframes colorMove {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(10px, -5px) rotate(2deg);
            }
            50% {
                transform: translate(-8px, 8px) rotate(-2deg);
            }
            75% {
                transform: translate(5px, 5px) rotate(1deg);
            }
        }

        @keyframes distractionBlink {
            0%, 100% {
                filter: brightness(1) saturate(1);
                transform: scale(1);
            }
            25% {
                filter: brightness(1.5) saturate(1.3);
                transform: scale(1.05);
            }
            50% {
                filter: brightness(2) saturate(1.8);
                transform: scale(1.1);
            }
            75% {
                filter: brightness(1.5) saturate(1.3);
                transform: scale(1.05);
            }
        }

        /* STARKARE, KLARARE F√ÑRGER */
        .color-red { 
            background: linear-gradient(135deg, #ff0000, #cc0000);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }
        .color-blue { 
            background: linear-gradient(135deg, #0066ff, #0044cc);
            box-shadow: 0 6px 20px rgba(0, 102, 255, 0.5);
        }
        .color-yellow { 
            background: linear-gradient(135deg, #ffdd00, #ffaa00);
            box-shadow: 0 6px 20px rgba(255, 221, 0, 0.5);
        }
        .color-green { 
            background: linear-gradient(135deg, #00ff00, #00cc00);
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.5);
        }

        .sequence-instruction {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 15px 0;
            min-height: 50px;
        }

        .sequence-level {
            text-align: center;
            color: #fff;
            font-size: 1.1em;
            margin: 10px 0;
        }

        /* Presentkort (visas efter √∂ppning) */
        .gift-card-container {
            display: none;
            width: 100%;
            max-width: 600px;
        }

        .gift-card-container.show {
            display: block;
            animation: cardReveal 1.5s ease-out;
        }

        .gift-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 50px 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.4), 
                        0 20px 60px rgba(0, 0, 0, 0.5),
                        inset 0 0 30px rgba(255, 215, 0, 0.1);
            position: relative;
            animation: cardReveal 1.5s ease-out;
            text-align: center;
        }

        @keyframes cardReveal {
            from {
                opacity: 0;
                transform: scale(0.8) rotateY(-10deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        .gift-card::before {
            content: 'üéÅ';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4em;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .gift-card-header {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .gift-card-title {
            font-size: 2.8em;
            color: #ffd700;
            margin: 0 0 10px 0;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8),
                         2px 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            letter-spacing: 2px;
        }

        .gift-card-subtitle {
            font-size: 1.3em;
            color: #fff;
            margin: 10px 0 30px 0;
            opacity: 0.9;
        }

        .gift-card-content {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
        }

        .gift-info-row {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .gift-info-icon {
            font-size: 2em;
            margin-right: 20px;
            min-width: 50px;
            text-align: center;
        }

        .gift-info-text {
            flex: 1;
            color: #fff;
            font-size: 1.2em;
            line-height: 1.6;
        }

        .gift-info-label {
            color: #ffd700;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .gift-card-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 215, 0, 0.3);
        }

        .gift-message {
            font-size: 1.8em;
            color: #ffd700;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .gift-card {
                padding: 30px 20px;
            }

            .gift-card-title {
                font-size: 2em;
            }

            .gift-info-row {
                flex-direction: column;
                text-align: center;
            }

            .gift-info-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .gift-info-text {
                text-align: center;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.4em;
            }

            .puzzle-container {
                padding: 20px;
            }

            .hotspot-container {
                height: 300px;
            }

            .hotspot {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .logic-grid {
                grid-template-columns: 100px 1fr 1fr;
                font-size: 0.9em;
                gap: 10px;
            }

            .memory-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .memory-card {
                font-size: 2em;
                min-height: 60px;
            }

            .timing-btn {
                width: 60px;
                height: 60px;
                font-size: 1.2em;
            }

            .admin-panel {
                max-width: 90%;
                right: 5%;
                left: 5%;
            }
        }

        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
            color: #f44336;
        }

        /* Fake Loading Screen */
        .fake-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        
        .fake-loading-screen.show {
            display: flex;
        }

        .fake-loading-bar-container {
            width: 300px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .fake-loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .fake-loading-bar.going-wrong {
            animation: loadingWrong 2s infinite;
        }

        @keyframes loadingWrong {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px); }
            100% { transform: translateX(0); }
        }

        /* Fake Captcha */
        .fake-captcha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 25000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fake-captcha-box {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            max-width: 500px;
            text-align: center;
            color: #fff;
        }

        .fake-captcha-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .fake-captcha-image {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            transition: all 0.3s;
        }

        .fake-captcha-image:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .fake-captcha-image.selected {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.3);
        }

        /* Fake Countdown */
        .fake-countdown {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 107, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #ffd700;
            z-index: 5000;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        /* Fake Saving Message */
        .fake-saving-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #4caf50;
            z-index: 5000;
            color: #fff;
            display: none;
        }

        .fake-saving-message.show {
            display: block;
            animation: savingPulse 2s infinite;
        }

        @keyframes savingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <!-- Snowflakes -->
    <div id="snowflakes"></div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar" ondblclick="showSecretInput()" title="Dubbelklicka f√∂r test-l√§ge">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <!-- Secret Test Input (hidden) -->
        <div id="secretInput" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px; border: 2px solid #ffd700; border-radius: 10px; z-index: 2000;">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Test-l√§ge</h3>
            <input type="text" id="secretCodeInput" placeholder="Skriv kod: test123" style="width: 200px; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.5); border: 1px solid #ffd700; border-radius: 5px; color: #fff;">
            <br>
            <button onclick="checkSecretCode()" style="margin-right: 10px; padding: 10px 20px; background: #ffd700; color: #000; border: none; border-radius: 5px; cursor: pointer;">Hoppa till niv√•</button>
            <button onclick="hideSecretInput()" style="padding: 10px 20px; background: #666; color: #fff; border: none; border-radius: 5px; cursor: pointer;">St√§ng</button>
        </div>

        <!-- View 0: Start -->
        <div class="view active" id="view0">
            <h1 id="title">üéÑ Julklapp Escape Room üéÑ</h1>
            <div class="puzzle-container">
                <p class="puzzle-description" style="text-align: center; font-size: 1.3em;">
                    V√§lkommen! Du har 5 utmaningar att l√∂sa f√∂r att l√•sa upp din julklapp.<br>
                    Varje niv√• blir lite sv√•rare, men allt √§r r√§ttvist.<br>
                    Anv√§nd ledtr√•dar om du fastnar!
                </p>
                <button onclick="startGame()" style="display: block; margin: 30px auto;">Starta √§ventyret</button>
            </div>
        </div>
        
        <!-- Fake Loading Screen -->
        <div id="fakeLoadingScreen" class="fake-loading-screen">
            <h2>Laddar...</h2>
            <div class="fake-loading-bar-container">
                <div class="fake-loading-bar" id="fakeLoadingBar"></div>
            </div>
            <p id="fakeLoadingText">Initierar system...</p>
            <button id="fakeLoadingButton" onclick="skipFakeLoading()" style="display: none; margin-top: 20px;">Forts√§tt</button>
        </div>
        
        <!-- Fake Captcha -->
        <div id="fakeCaptcha" class="fake-captcha-overlay" style="display: none;">
            <div class="fake-captcha-box">
                <h3>Verifiera att du √§r m√§nniska</h3>
                <p>V√§lj alla bilder med trafikljus:</p>
                <div class="fake-captcha-grid" id="fakeCaptchaGrid">
                    <!-- Images will be added by JavaScript -->
                </div>
                <p id="fakeCaptchaMessage" style="color: #ff6b6b; margin-top: 10px;"></p>
                <button onclick="checkFakeCaptcha()" style="margin-top: 15px;">Verifiera</button>
            </div>
        </div>

        <!-- View 1: Level 1 - Word Puzzle -->
        <div class="view" id="view1">
            <h2>Niv√• 1: Ordg√•ta</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    <strong>Ledtr√•d:</strong> Vem √§r den svenska f√∂rfattaren som skrev boken "Nils Holgerssons underbara resa genom Sverige" 
                    och som var den f√∂rsta kvinnan att f√• Nobelpriset i litteratur?<br>
                    <em>(Svara med efternamnet, sm√• bokst√§ver, svenska tecken √§r ok)</em>
                </p>
                <input type="text" id="wordInput" placeholder="Skriv svaret h√§r..." onkeypress="if(event.key==='Enter') checkWord()">
                <button onclick="checkWord()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(1)">Ledtr√•d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B√∂rja om fr√•n b√∂rjan</button>
                <div class="hint-container" id="hint1"></div>
                <div id="message1"></div>
            </div>
        </div>

        <!-- View 2: Level 2 - Memory Game -->
        <div class="view" id="view2">
            <h2>Niv√• 2: Memory</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Hitta alla par! V√§nd upp tv√• kort i taget och matcha dem. N√§r alla par √§r hittade f√•r du en kod.
                </p>
                <div class="memory-grid" id="memoryGrid"></div>
                <div style="margin-top: 20px;">
                    <strong>Hittade par:</strong> <span id="pairsFound">0</span> / <span id="totalPairs">0</span>
                </div>
                <button class="btn-secondary" onclick="showHint(2)">Ledtr√•d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B√∂rja om fr√•n b√∂rjan</button>
                <div class="hint-container" id="hint2"></div>
                <div id="message2"></div>
            </div>
        </div>

        <!-- View 3: Level 3 - Cipher -->
        <div class="view" id="view3">
            <h2>Niv√• 3: Avkodning</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Nedan finns ett krypterat ord. Avkoda det med ROT16 (Caesar-chiffer med skift 16).
                    <br><br>
                    Svaret blir ditt l√∂senord (ett ord relaterat till fiske).
                </p>
                <div class="cipher-text" id="cipherText"></div>
                <input type="text" id="cipherInput" placeholder="Skriv det avkodade l√∂senordet h√§r..." onkeypress="if(event.key==='Enter') checkCipher()">
                <button onclick="checkCipher()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(3)">Ledtr√•d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B√∂rja om fr√•n b√∂rjan</button>
                <div class="hint-container" id="hint3"></div>
                <div id="message3"></div>
            </div>
        </div>

        <!-- View 4: Level 4 - Logic Puzzle -->
        <div class="view" id="view4">
            <h2>Niv√• 4: Fiskelogik</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Fyra fiskare f√•ngar fyra olika fisketyper med fyra olika metoder. Matcha r√§tt fiskare med r√§tt fisk och metod baserat p√• ledtr√•darna:
                    <br><br>
                    <strong>Ledtr√•dar:</strong><br>
                    1. Erik fiskar inte abborre eller g√§dda.<br>
                    2. Lisa anv√§nder inte flugfiske eller grundfiske.<br>
                    3. Olle fiskar inte lax eller ruda.<br>
                    4. Sara anv√§nder inte spinnfiske eller flugfiske.<br>
                    5. Den som fiskar lax anv√§nder inte grundfiske.<br>
                    6. Den som fiskar abborre anv√§nder inte isfiske.<br>
                    7. Den som fiskar g√§dda anv√§nder inte flugfiske.<br>
                    8. Den som fiskar ruda anv√§nder inte spinnfiske.<br>
                    9. Den som anv√§nder flugfiske fiskar inte abborre eller g√§dda.<br>
                    10. Den som anv√§nder spinnfiske fiskar inte lax eller ruda.<br>
                    11. Den som anv√§nder grundfiske fiskar inte lax eller abborre.<br>
                    12. Den som anv√§nder isfiske fiskar inte g√§dda eller abborre.<br>
                    13. Exakt en av (Erik, Olle) fiskar lax eller ruda.<br>
                    14. Exakt en av (Lisa, Sara) anv√§nder grundfiske eller isfiske.<br>
                    15. Erik anv√§nder antingen flugfiske eller spinnfiske.<br>
                    16. Olle anv√§nder antingen grundfiske eller isfiske.<br>
                    17. Den som anv√§nder flugfiske fiskar inte ruda.<br>
                </p>
                <div class="logic-grid" id="logicGrid"></div>
                <button onclick="checkLogic()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(4)">Ledtr√•d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B√∂rja om fr√•n b√∂rjan</button>
                <div class="hint-container" id="hint4"></div>
                <div id="message4"></div>
            </div>
        </div>

        <!-- View 5: Level 5 - Fish Math Puzzle -->
        <div class="view" id="view5">
            <h2>Niv√• 5: Fiskmatematik</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Varje fisk representerar en siffra (0-9). L√∂s ekvationerna nedan f√∂r att ta reda p√• vilken siffra varje fisk representerar.
                    N√§r du vet alla siffror, ange koden i r√§tt ordning.
                </p>
                <div class="fish-math-container" id="fishMathContainer">
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> + <span class="fish-name">Abborre</span> = 12
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">G√§dda</span> - <span class="fish-name">Ruda</span> = 3
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> √ó 2 = <span class="fish-name">G√§dda</span>
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Abborre</span> + <span class="fish-name">Ruda</span> = 15
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> + <span class="fish-name">G√§dda</span> = 18
                    </div>
                </div>
                <div class="fish-code-input">
                    <p><strong>Koden √§r summan av alla fyra fiskar:</strong></p>
                    <input type="text" id="fishCodeInput" placeholder="Ange 4-siffrig kod" maxlength="4" style="font-size: 1.5em; padding: 10px; text-align: center; width: 200px;">
                </div>
                <button onclick="checkFishMath()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(5)">Ledtr√•d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B√∂rja om fr√•n b√∂rjan</button>
                <div class="hint-container" id="hint5"></div>
                <div id="message5"></div>
            </div>
        </div>

        <!-- View 6: Final -->
        <div class="view" id="view6">
            <div class="final-container">
                <h1 class="gift-card-title" style="margin-bottom: 20px;">üéâ Grattis! üéâ</h1>
                <p class="gift-card-subtitle" style="margin-bottom: 30px;">Du har l√∂st alla utmaningar! Nu ska du lista ut vad som ligger i paketen!</p>
                
                <!-- R√§kna fiskar (i bakgrunden) -->
                <div class="fish-count-container" id="fishCountContainer" style="position: relative;">
                    <!-- Under uppbyggnad overlay -->
                    <div class="under-construction-overlay" id="constructionOverlay">
                        <div class="construction-title">üîß Under Uppbyggnad üîß</div>
                        <div class="construction-subtitle">Detta omr√•de h√•ller p√• att byggas...</div>
                        
                        <div class="construction-game">
                            <div class="construction-instruction" id="constructionInstruction">
                                Klicka p√• knapparna i r√§tt ordning: 1 ‚Üí 2 ‚Üí 3 ‚Üí 4
                            </div>
                            <div class="construction-buttons-grid" id="constructionButtons">
                                <!-- Knappar skapas dynamiskt -->
                            </div>
                            <div class="construction-feedback" id="constructionFeedback"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Stort paket (visas n√§r r√§tt paket hittats) -->
                <div class="gift-box-large-container" id="giftBoxLargeContainer">
                    <div class="gift-box-large" id="giftBoxLarge" onclick="handleGiftBoxClick(event)">üéÅ</div>
                    <div class="open-instruction" id="openInstruction">Dubbelklicka p√• paketet f√∂r att b√∂rja!</div>
                    
                    <!-- F√§rgsekvens-spel (visas efter dubbelklick) -->
                    <div class="color-sequence-container" id="colorSequenceContainer">
                        <div class="sequence-level" id="sequenceLevel">Niv√• 1</div>
                        <div class="sequence-instruction" id="sequenceInstruction">Titta noga p√• sekvensen!</div>
                        <div class="color-grid">
                            <div class="color-button color-red" id="colorRed" data-color="red"></div>
                            <div class="color-button color-blue" id="colorBlue" data-color="blue"></div>
                            <div class="color-button color-yellow" id="colorYellow" data-color="yellow"></div>
                            <div class="color-button color-green" id="colorGreen" data-color="green"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Presentkort (visas efter √∂ppning) -->
                <div class="gift-card-container" id="giftCardContainer">
                    <div class="gift-card">
                        <div class="gift-card-header">
                            <h1 class="gift-card-title">üéâ Grattis! üéâ</h1>
                            <p class="gift-card-subtitle">Du har l√∂st alla utmaningar!</p>
                        </div>
                        
                        <div class="gift-card-content">
                            <div class="gift-info-row">
                                <div class="gift-info-icon">üé£</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Present</span>
                                    Flugbindning f√∂r nyb√∂rjare
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">üìÖ</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Datum</span>
                                    20 januari 2026
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">üïê</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Tid</span>
                                    18:00 - 20:30
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">üìç</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Plats</span>
                                    Residensgatan 7, V√§nersborg
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">‚ú®</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Antal tillf√§llen</span>
                                    10 tillf√§llen
                                </div>
                            </div>
                        </div>
                        
                        <div class="gift-card-footer">
                            <div class="gift-message">God Jul Dan! ‚ù§Ô∏è</div>
                            <p style="color: #fff; margin-top: 15px; opacity: 0.8;">Fr√•n Monica</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="restartGame()" style="background: #666; margin-top: 30px;">B√∂rja om fr√•n b√∂rjan</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <h3>üîß Admin Panel</h3>
        <button onclick="goToLevel(0)">Start</button>
        <button onclick="goToLevel(1)">Niv√• 1</button>
        <button onclick="goToLevel(2)">Niv√• 2</button>
        <button onclick="goToLevel(3)">Niv√• 3</button>
        <button onclick="goToLevel(4)">Niv√• 4</button>
        <button onclick="goToLevel(5)">Niv√• 5</button>
        <button onclick="goToLevel(6)">Final</button>
        <button onclick="resetProgress()" class="btn-secondary">Nollst√§ll Progress</button>
        <button onclick="showAnswers()" class="btn-secondary">Visa Facit</button>
        <button onclick="toggleAdmin()" style="background: #666;">St√§ng</button>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Alla svar och konstanter
        // ============================================
        const CONFIG = {
            // Level 1: Word Puzzle
            wordAnswer: "lagerl√∂f",
            
            // Level 2: Memory Game
            memoryPairs: ["üéÑ", "üéÖ", "‚≠ê", "üéÅ", "ü¶å", "üîî"], // 6 par = 12 kort
            memoryCode: "2468", // Kod n√§r alla par √§r hittade
            
            // Level 3: Cipher
            cipherText: "Syetvscxnbr√•", // "Flugfiskaren" in ROT16 med svenska alfabetet (A-Z, √Ö, √Ñ, √ñ)
            cipherAnswer: "flugfiskaren",
            
            // Level 4: Logic Puzzle - Fishing
            // Correct mapping: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G√§dda+Grundfiske, Sara=Ruda+Isfiske
            logicAnswer: {
                erik: { fish: "lax", method: "flugfiske" },
                lisa: { fish: "abborre", method: "spinnfiske" },
                olle: { fish: "g√§dda", method: "grundfiske" },
                sara: { fish: "ruda", method: "isfiske" }
            },
            logicCode: "2468", // Will be generated from correct answers
            
            // Level 5: Fish Math Puzzle
            // Lax = 6, Abborre = 6, G√§dda = 12, Ruda = 9
            // Summa: 6 + 6 + 12 + 9 = 33
            fishMathAnswer: "33"
        };

        // ============================================
        // GAME STATE
        // ============================================
        let currentLevel = 0;
        let titleClickCount = 0;
        let adminMode = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Check if first visit
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                // Show fake loading screen
                showFakeLoadingScreen();
                localStorage.setItem('hasVisited', 'true');
                return;
            }
            
            // Load progress from localStorage
            const savedLevel = localStorage.getItem('escapeRoomLevel');
            if (savedLevel) {
                currentLevel = parseInt(savedLevel);
            }
            
            // Setup title click for admin
            document.getElementById('title').addEventListener('click', handleTitleClick);
            
            // Initialize views
            showView(currentLevel);
            updateProgress();
            
            // Initialize level-specific features
            if (currentLevel === 2) initMemoryGame();
            if (currentLevel === 4) initLogicPuzzle();
            if (currentLevel === 5) initFishMath();
            if (currentLevel === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            
            // Create snowflakes
            createSnowflakes();
            
            // Start background music
            startBackgroundMusic();
            
            // Setup click sounds
            setupClickSounds();
            
            // Start fake countdown
            startFakeCountdown();
            
            // Random fake saving messages
            startFakeSavingMessages();
        }

        // ============================================
        // PROGRESS & NAVIGATION
        // ============================================
        function updateProgress() {
            const progress = (currentLevel / 6) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = Math.round(progress) + '%';
        }

        function showView(level) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show current view
            const view = document.getElementById('view' + level);
            if (view) {
                view.classList.add('active');
            }
            
            currentLevel = level;
            localStorage.setItem('escapeRoomLevel', level);
            updateProgress();
            
            // Stop popups on final view
            if (level === 6) {
                stopAnnoyingPopups();
                setTimeout(() => initFishCountTest(), 100);
            } else if (level > 0 && !popupInterval) {
                // Start popups if game is active
                startAnnoyingPopups();
            }
            
            // Initialize level-specific features when switching views
            if (level === 2) {
                setTimeout(() => initMemoryGame(), 100); // Small delay to ensure DOM is ready
            } else {
                // Stop memory swapping if leaving level 2
                stopMemoryCardSwapping();
            }
            
            if (level === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            } else if (level === 4) {
                setTimeout(() => initLogicPuzzle(), 100);
            } else if (level === 5) {
                setTimeout(() => initFishMath(), 100);
            }
            
            // Setup troll features for this level
            setTimeout(() => {
                setupTrollFeatures(level);
            }, 500);
            
            // Start captcha interval only if we're entering a game level for the first time
            // (it will continue running even when switching between levels)
            if (level > 0 && level < 6) {
                if (!captchaIntervalStarted) {
                    startCaptchaInterval();
                }
            } else {
                stopCaptchaInterval();
                captchaIntervalStarted = false; // Reset so it can start again if needed
            }
        }
        
        function setupTrollFeatures(level) {
            if (level === 0 || level === 6) return;
            
            // 20% chance to show "You've already completed this level" message
            if (Math.random() < 0.2) {
                setTimeout(() => {
                    const msg = showMessage('message' + level, 'Du har redan klarat denna niv√•!', 'success');
                    setTimeout(() => {
                        showMessage('message' + level, '', '');
                    }, 2000);
                }, 1000);
            }
            
            // Setup moving buttons (especially "Kontrollera" buttons)
            setupMovingButtons(level);
            
            // Setup button swapping
            setupButtonSwapping(level);
            
            // Setup fake hint button
            setupFakeHintButton(level);
            
            // Setup fake level complete (only once per level)
            if (!fakeLevelCompleteShown[level] && Math.random() < 0.3) {
                setTimeout(() => {
                    showFakeLevelComplete(level);
                    fakeLevelCompleteShown[level] = true;
                }, 3000 + Math.random() * 5000);
            }
        }
        
        function setupMovingButtons(level) {
            const checkButtons = document.querySelectorAll(`#view${level} button[onclick*="check"]`);
            checkButtons.forEach(btn => {
                let moveCount = 0;
                const moveInterval = setInterval(() => {
                    if (moveCount > 5) {
                        clearInterval(moveInterval);
                        return;
                    }
                    moveCount++;
                    
                    // Move button slightly when user hovers
                    btn.addEventListener('mouseenter', function() {
                        if (Math.random() < 0.4) { // 40% chance
                            const rect = btn.getBoundingClientRect();
                            const newX = rect.left + (Math.random() - 0.5) * 100;
                            const newY = rect.top + (Math.random() - 0.5) * 50;
                            btn.style.position = 'relative';
                            btn.style.left = (newX - rect.left) + 'px';
                            btn.style.top = (newY - rect.top) + 'px';
                            btn.style.transition = 'all 0.1s';
                            
                            setTimeout(() => {
                                btn.style.left = '0';
                                btn.style.top = '0';
                            }, 200);
                        }
                    }, { once: true });
                }, 2000);
            });
        }
        
        function setupButtonSwapping(level) {
            const view = document.getElementById('view' + level);
            if (!view) return;
            
            const buttons = Array.from(view.querySelectorAll('button'));
            const hintBtn = buttons.find(b => b.textContent.includes('Ledtr√•d'));
            const checkBtn = buttons.find(b => b.textContent.includes('Kontrollera'));
            
            if (hintBtn && checkBtn && Math.random() < 0.15) { // 15% chance
                // Swap their positions
                const hintParent = hintBtn.parentNode;
                const checkParent = checkBtn.parentNode;
                
                if (hintParent === checkParent) {
                    // Same parent, swap order
                    const temp = hintBtn.nextSibling;
                    hintBtn.parentNode.insertBefore(checkBtn, hintBtn);
                    if (temp) {
                        checkBtn.parentNode.insertBefore(hintBtn, temp);
                    } else {
                        checkBtn.parentNode.appendChild(hintBtn);
                    }
                }
            }
        }
        
        function setupFakeHintButton(level) {
            const view = document.getElementById('view' + level);
            if (!view) return;
            
            const realHintBtn = view.querySelector('button[onclick*="showHint"]');
            if (!realHintBtn) return;
            
            // Create fake hint button
            const fakeBtn = document.createElement('button');
            fakeBtn.className = 'btn-secondary';
            fakeBtn.textContent = 'Ledtr√•d';
            fakeBtn.style.marginLeft = '10px';
            fakeBtn.onclick = () => showFakeHint(level);
            
            // Insert after real hint button
            realHintBtn.parentNode.insertBefore(fakeBtn, realHintBtn.nextSibling);
        }
        
        function showFakeLevelComplete(level) {
            if (level === 0 || level === 6) return;
            
            const msgDiv = document.getElementById('message' + level);
            if (!msgDiv) return;
            
            msgDiv.textContent = 'üéâ Niv√• klar! üéâ';
            msgDiv.className = 'message success';
            
            setTimeout(() => {
                msgDiv.textContent = 'Bara skojade! Forts√§tt spela! üòÑ';
                msgDiv.className = 'message error';
                
                setTimeout(() => {
                    msgDiv.textContent = '';
                    msgDiv.className = 'message';
                }, 2000);
            }, 1000);
        }

        function startGame() {
            showView(1);
            startAnnoyingPopups();
        }

        // ============================================
        // LEVEL 1: WORD PUZZLE
        // ============================================
        function checkWord() {
            const input = document.getElementById('wordInput').value.toLowerCase().trim();
            const normalized = normalizeSwedish(input);
            const answer = normalizeSwedish(CONFIG.wordAnswer);
            
            if (normalized === answer) {
                showMessage('message1', 'Korrekt! Du kan g√• vidare.', 'success');
                setTimeout(() => showView(2), 1500);
            } else {
                showMessage('message1', 'Fel svar. F√∂rs√∂k igen!', 'error');
            }
        }

        function normalizeSwedish(str) {
            return str.toLowerCase()
                .replace(/√•/g, 'a')
                .replace(/√§/g, 'a')
                .replace(/√∂/g, 'o')
                .trim();
        }

        // ============================================
        // LEVEL 2: MEMORY GAME
        // ============================================
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let canFlip = true;
        let memorySwapInterval = null;

        function initMemoryGame() {
            const grid = document.getElementById('memoryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            memoryCards = [];
            flippedCards = [];
            matchedPairs = 0;
            canFlip = true;
            
            // Create pairs of cards
            const cards = [];
            CONFIG.memoryPairs.forEach((emoji, index) => {
                cards.push({ emoji, id: index });
                cards.push({ emoji, id: index }); // Add pair
            });
            
            // Shuffle cards
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            // Create card elements
            cards.forEach((card, index) => {
                const cardElem = document.createElement('div');
                cardElem.className = 'memory-card';
                cardElem.dataset.cardId = card.id;
                cardElem.dataset.index = index;
                
                const back = document.createElement('div');
                back.className = 'card-back';
                back.textContent = '?';
                
                const front = document.createElement('div');
                front.className = 'card-front';
                front.textContent = card.emoji;
                
                cardElem.appendChild(back);
                cardElem.appendChild(front);
                cardElem.onclick = () => handleMemoryClick(cardElem);
                
                grid.appendChild(cardElem);
                memoryCards.push(cardElem);
            });
            
            // Update total pairs display
            document.getElementById('totalPairs').textContent = CONFIG.memoryPairs.length;
            document.getElementById('pairsFound').textContent = '0';
            
            // Start swapping cards every 10 seconds
            startMemoryCardSwapping();
        }
        
        function startMemoryCardSwapping() {
            // Clear any existing interval
            if (memorySwapInterval) {
                clearInterval(memorySwapInterval);
            }
            
            // Swap two unmatched cards every 3 seconds (make it really hard!)
            memorySwapInterval = setInterval(() => {
                swapTwoUnmatchedCards();
            }, 3000); // 3 seconds - very challenging!
        }
        
        function stopMemoryCardSwapping() {
            if (memorySwapInterval) {
                clearInterval(memorySwapInterval);
                memorySwapInterval = null;
            }
        }
        
        function swapTwoUnmatchedCards() {
            // Get all unmatched cards (not matched, not currently flipped)
            const unmatchedCards = Array.from(memoryCards).filter(card => {
                return !card.classList.contains('matched') && 
                       !card.classList.contains('flipped');
            });
            
            // Need at least 2 cards to swap
            if (unmatchedCards.length < 2) {
                return;
            }
            
            // Pick two random unmatched cards
            const index1 = Math.floor(Math.random() * unmatchedCards.length);
            let index2 = Math.floor(Math.random() * unmatchedCards.length);
            while (index2 === index1) {
                index2 = Math.floor(Math.random() * unmatchedCards.length);
            }
            
            const card1 = unmatchedCards[index1];
            const card2 = unmatchedCards[index2];
            
            // Get their positions
            const rect1 = card1.getBoundingClientRect();
            const rect2 = card2.getBoundingClientRect();
            
            // Calculate the distance and direction
            const deltaX = rect2.left - rect1.left;
            const deltaY = rect2.top - rect1.top;
            
            // Temporarily disable pointer events during animation
            card1.style.pointerEvents = 'none';
            card2.style.pointerEvents = 'none';
            
            // Add transition for smooth animation
            card1.style.transition = 'transform 1.5s ease-in-out';
            card2.style.transition = 'transform 1.5s ease-in-out';
            
            // Move cards to swap positions
            card1.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            card2.style.transform = `translate(${-deltaX}px, ${-deltaY}px)`;
            
            // After animation completes, swap them in DOM and reset
            setTimeout(() => {
                // Swap the cards in the DOM
                const parent = card1.parentNode;
                const next1 = card1.nextSibling;
                const next2 = card2.nextSibling;
                
                if (next1 === card2) {
                    // card1 is right before card2
                    parent.insertBefore(card2, card1);
                } else if (next2 === card1) {
                    // card2 is right before card1
                    parent.insertBefore(card1, card2);
                } else {
                    // They're not adjacent
                    parent.insertBefore(card1, next2);
                    parent.insertBefore(card2, next1);
                }
                
                // Reset transforms and transitions
                card1.style.transform = '';
                card2.style.transform = '';
                card1.style.transition = '';
                card2.style.transition = '';
                
                // Re-enable pointer events
                setTimeout(() => {
                    card1.style.pointerEvents = '';
                    card2.style.pointerEvents = '';
                }, 100);
            }, 1500); // Wait for animation to complete
        }

        function handleMemoryClick(card) {
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            card.classList.add('flipped');
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                canFlip = false;
                const [card1, card2] = flippedCards;
                
                if (card1.dataset.cardId === card2.dataset.cardId) {
                    // Match!
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        matchedPairs++;
                        document.getElementById('pairsFound').textContent = matchedPairs;
                        
                        flippedCards = [];
                        canFlip = true;
                        
                        if (matchedPairs === CONFIG.memoryPairs.length) {
                            stopMemoryCardSwapping();
                            showMessage('message2', `Korrekt! Koden √§r: ${CONFIG.memoryCode}`, 'success');
                            setTimeout(() => showView(3), 2000);
                        }
                    }, 500);
                } else {
                    // No match
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                        canFlip = true;
                    }, 1000);
                }
            }
        }

        // ============================================
        // LEVEL 3: CIPHER
        // ============================================
        function checkCipher() {
            const input = document.getElementById('cipherInput').value.toLowerCase().trim();
            const normalized = normalizeSwedish(input);
            const answer = normalizeSwedish(CONFIG.cipherAnswer);
            
            if (normalized === answer) {
                // 30% chance to show fake error message
                if (Math.random() < 0.3) {
                    showMessage('message3', 'Fel svar. F√∂rs√∂k igen!', 'error');
                    setTimeout(() => {
                        showMessage('message3', 'Korrekt! Du kan g√• vidare.', 'success');
                        setTimeout(() => showView(4), 1500);
                    }, 1000);
                } else {
                    showMessage('message3', 'Korrekt! Du kan g√• vidare.', 'success');
                    setTimeout(() => showView(4), 1500);
                }
            } else {
                showMessage('message3', 'Fel svar. F√∂rs√∂k igen!', 'error');
            }
        }

        // ============================================
        // LEVEL 4: LOGIC PUZZLE
        // ============================================
        function initLogicPuzzle() {
            const grid = document.getElementById('logicGrid');
            grid.innerHTML = '';
            
            const fishers = ['Erik', 'Lisa', 'Olle', 'Sara'];
            const fishes = ['Lax', 'Abborre', 'G√§dda', 'Ruda'];
            const methods = ['Flugfiske', 'Spinnfiske', 'Grundfiske', 'Isfiske'];
            
            // Header row
            const headers = ['Fiskare', 'Fisk', 'Metod'];
            headers.forEach(header => {
                const cell = document.createElement('div');
                cell.className = 'logic-header';
                cell.textContent = header;
                grid.appendChild(cell);
            });
            
            // Create rows for each fisher
            fishers.forEach(fisher => {
                // Fisher name
                const fisherCell = document.createElement('div');
                fisherCell.className = 'logic-header';
                fisherCell.textContent = fisher;
                grid.appendChild(fisherCell);
                
                // Fish select
                const fishCell = document.createElement('div');
                fishCell.className = 'logic-cell';
                const fishSelect = document.createElement('select');
                fishSelect.id = `logic-${fisher.toLowerCase()}-fish`;
                fishSelect.innerHTML = '<option value="">V√§lj fisk...</option>';
                fishes.forEach(fish => {
                    fishSelect.innerHTML += `<option value="${fish.toLowerCase()}">${fish}</option>`;
                });
                fishCell.appendChild(fishSelect);
                grid.appendChild(fishCell);
                
                // Method select
                const methodCell = document.createElement('div');
                methodCell.className = 'logic-cell';
                const methodSelect = document.createElement('select');
                methodSelect.id = `logic-${fisher.toLowerCase()}-method`;
                methodSelect.innerHTML = '<option value="">V√§lj metod...</option>';
                methods.forEach(method => {
                    methodSelect.innerHTML += `<option value="${method.toLowerCase()}">${method}</option>`;
                });
                methodCell.appendChild(methodSelect);
                grid.appendChild(methodCell);
            });
        }

        function checkLogic() {
            const fishers = ['erik', 'lisa', 'olle', 'sara'];
            let allCorrect = true;
            let allFilled = true;
            
            // Verify all answers are correct
            fishers.forEach(fisher => {
                const correct = CONFIG.logicAnswer[fisher];
                const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                const methodSelect = document.getElementById(`logic-${fisher}-method`);
                
                if (!fishSelect || !methodSelect) {
                    allFilled = false;
                    return;
                }
                
                const selectedFish = fishSelect.value.trim().toLowerCase();
                const selectedMethod = methodSelect.value.trim().toLowerCase();
                
                if (!selectedFish || !selectedMethod) {
                    allFilled = false;
                    return;
                }
                
                // Normalize for comparison (handle Swedish characters)
                const normalizedSelectedFish = normalizeSwedish(selectedFish);
                const normalizedCorrectFish = normalizeSwedish(correct.fish);
                const normalizedSelectedMethod = normalizeSwedish(selectedMethod);
                const normalizedCorrectMethod = normalizeSwedish(correct.method);
                
                if (normalizedSelectedFish !== normalizedCorrectFish || normalizedSelectedMethod !== normalizedCorrectMethod) {
                    allCorrect = false;
                }
            });
            
            if (!allFilled) {
                showMessage('message4', 'V√§lj b√•de fisk och metod f√∂r alla fiskare!', 'error');
            } else if (allCorrect) {
                // Use the code from CONFIG
                const code = CONFIG.logicCode;
                showMessage('message4', `Korrekt! Koden √§r: ${code}`, 'success');
                // Show troll popup after completing level 4 (only first time)
                setTimeout(() => {
                    showRestartTrollPopup();
                }, 1500);
            } else {
                showMessage('message4', 'Inte helt r√§tt. Kontrollera dina val!', 'error');
            }
        }

        // ============================================
        // LEVEL 5: FISH MATH PUZZLE
        // ============================================
        function initFishMath() {
            // Clear any previous input
            const input = document.getElementById('fishCodeInput');
            if (input) {
                input.value = '';
            }
            showMessage('message5', '', '');
        }

        function checkFishMath() {
            const input = document.getElementById('fishCodeInput').value.trim();
            
            if (!input) {
                showMessage('message5', 'Ange en kod!', 'error');
                return;
            }
            
            if (input === CONFIG.fishMathAnswer) {
                // 30% chance to show fake error message
                if (Math.random() < 0.3) {
                    showMessage('message5', 'Fel kod! Kontrollera dina ber√§kningar.', 'error');
                    setTimeout(() => {
                        showMessage('message5', 'Korrekt! Du har klarat alla niv√•er!', 'success');
                        setTimeout(() => showView(6), 2000);
                    }, 1000);
                } else {
                    showMessage('message5', 'Korrekt! Du har klarat alla niv√•er!', 'success');
                    setTimeout(() => showView(6), 2000);
                }
            } else {
                showMessage('message5', 'Fel kod! Kontrollera dina ber√§kningar.', 'error');
            }
        }

        // ============================================
        // HINTS SYSTEM
        // ============================================
        const hints = {
            1: {
                step1: "T√§nk p√• en svensk f√∂rfattare som vann Nobelpriset i litteratur 1909...",
                step2: "Hennes f√∂rnamn √§r Selma och efternamnet b√∂rjar p√• L. Hon skrev om Nils Holgersson. Svaret √§r efternamnet: lagerl√∂f"
            },
            2: {
                step1: "Hitta alla par! V√§nd upp tv√• kort i taget och matcha dem. N√§r alla par √§r hittade f√•r du en kod.",
                step2: "N√§r du hittat alla 6 par kommer koden att visas: 2468"
            },
            3: {
                step1: "ROT16 med svenska alfabetet (29 bokst√§ver: A-Z, √Ö, √Ñ, √ñ). F√∂r att avkoda, skifta 16 steg fram√•t. S √§r position 19, 19+16=35, 35-29=6, position 6 √§r F.",
                step2: "Svenska alfabetet: A(1), B(2), C(3)...S(19)...Y(25), Z(26), √Ö(27), √Ñ(28), √ñ(29). F√∂r att avkoda 'Syetvscxnbr√•', g√• 16 steg fram√•t fr√•n varje bokstav: S(19)+16=35‚ÜíF(6), y(25)+16=41‚Üíl(12), e(5)+16=21‚Üíu(21), t(20)+16=36‚Üíg(7), v(22)+16=38‚Üíf(6), s(19)+16=35‚Üíi(9), c(3)+16=19‚Üís(19), x(24)+16=40‚Üík(11), n(14)+16=30‚Üía(1), b(2)+16=18‚Üír(18), r(18)+16=34‚Üíe(5), √•(27)+16=43‚Üín(14). Svaret √§r 'flugfiskaren'!"
            },
            4: {
                step1: "B√∂rja med ledtr√•d 1 och 3: Erik fiskar lax eller ruda, Olle fiskar abborre eller g√§dda. Fr√•n ledtr√•d 13: Exakt en av (Erik, Olle) fiskar lax eller ruda, s√• Erik fiskar lax/ruda och Olle fiskar abborre/g√§dda. Fr√•n ledtr√•d 16: Olle anv√§nder grundfiske eller isfiske. Fr√•n ledtr√•d 11: Grundfiske fiskar g√§dda eller ruda. Fr√•n ledtr√•d 3: Olle fiskar inte ruda, s√• om Olle anv√§nder grundfiske fiskar han g√§dda.",
                step2: "Fr√•n ledtr√•d 12: Isfiske fiskar lax eller ruda. Fr√•n ledtr√•d 3: Olle fiskar inte lax eller ruda, s√• Olle kan inte anv√§nda isfiske. D√§rf√∂r anv√§nder Olle grundfiske och fiskar g√§dda. Fr√•n ledtr√•d 15: Erik anv√§nder flugfiske eller spinnfiske. Fr√•n ledtr√•d 10: Spinnfiske fiskar inte lax/ruda, s√• Erik anv√§nder flugfiske. Fr√•n ledtr√•d 9: Flugfiske fiskar lax eller ruda. Fr√•n ledtr√•d 17: Flugfiske fiskar inte ruda, s√• Erik fiskar lax med flugfiske. Fr√•n ledtr√•d 10: Spinnfiske fiskar abborre eller g√§dda. G√§dda √§r taget, s√• spinnfiske fiskar abborre. Fr√•n ledtr√•d 2: Lisa anv√§nder spinnfiske eller isfiske. Fr√•n ledtr√•d 6: Abborre anv√§nder inte isfiske, s√• Lisa anv√§nder spinnfiske och fiskar abborre. Fr√•n ledtr√•d 4: Sara anv√§nder grundfiske eller isfiske. Grundfiske √§r taget, s√• Sara anv√§nder isfiske. Fr√•n ledtr√•d 12: Isfiske fiskar lax eller ruda. Lax √§r taget, s√• Sara fiskar ruda. Slutsats: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G√§dda+Grundfiske, Sara=Ruda+Isfiske. Koden: 2468"
            },
            5: {
                step1: "Fr√•n ekvation 3: Lax √ó 2 = G√§dda, s√• G√§dda √§r dubbelt s√• stor som Lax. Fr√•n ekvation 5: Lax + G√§dda = 18. Om G√§dda = 2√óLax, d√• Lax + 2√óLax = 18, allts√• 3√óLax = 18. Vad √§r Lax?",
                step2: "Lax = 6 (fr√•n 3√óLax = 18). G√§dda = 12 (fr√•n Lax √ó 2). Fr√•n ekvation 1: Lax + Abborre = 12, s√• Abborre = 6. Fr√•n ekvation 4: Abborre + Ruda = 15, s√• Ruda = 9. Kontroll: G√§dda - Ruda = 12 - 9 = 3 ‚úì. Summan: Lax(6) + Abborre(6) + G√§dda(12) + Ruda(9) = 33. Koden √§r 33."
            }
        };

        let hintStates = {};

        function showHint(level) {
            const hintDiv = document.getElementById('hint' + level);
            if (!hintStates[level]) {
                hintStates[level] = 1;
            } else {
                hintStates[level] = 2;
            }
            
            // Always show fake/troll hints instead of real ones
            if (hintStates[level] === 1) {
                const fakeMessage = fakeHintMessages[Math.floor(Math.random() * fakeHintMessages.length)];
                hintDiv.textContent = fakeMessage;
            } else {
                const fakeMessage2 = fakeHintMessagesStep2[Math.floor(Math.random() * fakeHintMessagesStep2.length)];
                hintDiv.textContent = fakeMessage2;
            }
            
            hintDiv.classList.add('show');
        }
        
        function showFakeHint(level) {
            const hintDiv = document.getElementById('hint' + level);
            const fakeMessage = fakeHintMessages[Math.floor(Math.random() * fakeHintMessages.length)];
            hintDiv.textContent = fakeMessage;
            hintDiv.classList.add('show');
            setTimeout(() => {
                hintDiv.classList.remove('show');
                hintDiv.textContent = '';
            }, 3000);
        }

        // ============================================
        // FINAL REVEAL - R√§kna fiskar (STRESSIGT!)
        // ============================================
        let currentFishRound = 0;
        let fishTimer = null;
        let fishTimeLeft = 15; // Mer tid nu!
        let fishAnswered = false;
        let fishInterval = null;
        let correctFishCount = 0;
        let fishPhase = 'showing'; // 'showing' eller 'counting'
        
        // 5 rundor med olika antal fiskar (fler nu, och de simmar bara en g√•ng)
        const fishRounds = [
            { count: 8, text: "R√§kna fiskarna!" },
            { count: 12, text: "R√§kna fiskarna!" },
            { count: 18, text: "R√§kna fiskarna!" },
            { count: 24, text: "R√§kna fiskarna!" },
            { count: 30, text: "R√§kna fiskarna!" }
        ];
        
        const fishEmojis = ['üêü', 'üê†', 'üê°', 'ü¶à', 'üêã'];
        
        // ============================================
        // UNDER UPPBYGGNAD SPEL
        // ============================================
        let constructionSequence = [];
        let constructionCurrentStep = 0;
        let constructionButtons = [];

        function initFishCountTest() {
            const container = document.getElementById('fishCountContainer');
            if (!container) return;
            
            // Starta fiskr√§kningsspelet i bakgrunden (osynligt)
            currentFishRound = 0;
            fishAnswered = false;
            correctFishCount = 0;
            showFishRound(0); // K√∂r i bakgrunden
            
            // D√∂lj stort paket och presentkort
            document.getElementById('giftBoxLargeContainer').classList.remove('show');
            document.getElementById('giftCardContainer').classList.remove('show');
            
            // Visa "Under uppbyggnad"-skylten med spel
            initConstructionGame();
        }

        function initConstructionGame() {
            const overlay = document.getElementById('constructionOverlay');
            const buttonsContainer = document.getElementById('constructionButtons');
            const instruction = document.getElementById('constructionInstruction');
            const feedback = document.getElementById('constructionFeedback');
            
            if (!overlay || !buttonsContainer) return;
            
            // Visa overlay
            overlay.style.display = 'flex';
            
            // √Öterst√§ll spel
            constructionSequence = [1, 2, 3, 4];
            constructionCurrentStep = 0;
            constructionButtons = [];
            
            // Skapa knappar i slumpm√§ssig ordning
            const buttonNumbers = [1, 2, 3, 4];
            // Blanda arrayen
            for (let i = buttonNumbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [buttonNumbers[i], buttonNumbers[j]] = [buttonNumbers[j], buttonNumbers[i]];
            }
            
            buttonsContainer.innerHTML = '';
            feedback.textContent = '';
            feedback.className = 'construction-feedback';
            
            buttonNumbers.forEach((num, index) => {
                const btn = document.createElement('button');
                btn.className = 'construction-btn';
                btn.textContent = num;
                btn.dataset.number = num;
                btn.onclick = () => handleConstructionClick(num, btn);
                buttonsContainer.appendChild(btn);
                constructionButtons.push(btn);
            });
            
            instruction.textContent = 'Klicka p√• knapparna i r√§tt ordning: 1 ‚Üí 2 ‚Üí 3 ‚Üí 4';
        }

        function handleConstructionClick(number, buttonElement) {
            const expectedNumber = constructionSequence[constructionCurrentStep];
            const feedback = document.getElementById('constructionFeedback');
            
            if (number === expectedNumber) {
                // R√§tt!
                buttonElement.classList.add('correct');
                buttonElement.classList.add('completed');
                buttonElement.disabled = true;
                constructionCurrentStep++;
                
                if (constructionCurrentStep === constructionSequence.length) {
                    // Alla steg klara!
                    feedback.textContent = 'Perfekt! Omr√•det √§r nu klart! üéâ';
                    feedback.className = 'construction-feedback correct';
                    
                    // D√∂lj overlay efter 1.5 sekunder och g√• vidare
                    setTimeout(() => {
                        const overlay = document.getElementById('constructionOverlay');
                        if (overlay) {
                            overlay.style.display = 'none';
                        }
                        showFinalGiftBox();
                    }, 1500);
                } else {
                    feedback.textContent = `Bra! N√§sta: ${constructionSequence[constructionCurrentStep]}`;
                    feedback.className = 'construction-feedback correct';
                }
            } else {
                // Fel!
                buttonElement.classList.add('wrong');
                feedback.textContent = 'Fel! B√∂rja om fr√•n b√∂rjan.';
                feedback.className = 'construction-feedback wrong';
                
                // √Öterst√§ll alla knappar
                setTimeout(() => {
                    constructionCurrentStep = 0;
                    constructionButtons.forEach(btn => {
                        btn.classList.remove('correct', 'wrong', 'completed');
                        btn.disabled = false;
                    });
                    feedback.textContent = '';
                    feedback.className = 'construction-feedback';
                }, 1000);
            }
        }
        
        function showFishRound(roundIndex) {
            const container = document.getElementById('fishCountContainer');
            if (!container || roundIndex >= fishRounds.length) {
                // Alla rundor klara - visa stort paket!
                showFinalGiftBox();
                return;
            }
            
            const round = fishRounds[roundIndex];
            currentFishRound = roundIndex;
            fishTimeLeft = 15;
            fishAnswered = false;
            fishPhase = 'showing';
            
            container.innerHTML = `
                <div class="fish-count-question">
                    <div class="fish-count-round">Runda ${roundIndex + 1} av ${fishRounds.length}</div>
                    <div class="fish-count-phase" id="fishPhase">Titta p√• fiskarna...</div>
                    <div class="fish-count-text">${round.text}</div>
                    <div class="fish-count-timer" id="fishTimer" style="display: none;"></div>
                    
                    <div class="fish-arena" id="fishArena"></div>
                    
                    <div class="fish-count-input-container" id="fishInputContainer" style="display: none;">
                        <input type="number" class="fish-count-input" id="fishInput" placeholder="?" min="0" max="50" autofocus>
                        <button class="fish-count-submit" onclick="submitFishAnswer()">Svara</button>
                    </div>
                    
                    <div class="fish-count-feedback" id="fishFeedback"></div>
                </div>
            `;
            
            // Skapa fiskar som simmar en g√•ng (ingen loop)
            // Tiden b√∂rjar EFTER att alla fiskar har simmat f√∂rbi
            createSwimmingFish(round.count, true, roundIndex);
        }
        
        function startCountingPhase() {
            fishPhase = 'counting';
            fishTimeLeft = 15;
            
            const phaseEl = document.getElementById('fishPhase');
            const timerEl = document.getElementById('fishTimer');
            const inputContainer = document.getElementById('fishInputContainer');
            const arena = document.getElementById('fishArena');
            
            // Stoppa alla fisk-animationer och ta bort dem fr√•n sk√§rmen
            if (arena) {
                const allFish = arena.querySelectorAll('.swimming-fish');
                allFish.forEach(fish => {
                    // Stoppa animationen helt
                    fish.style.animation = 'none';
                    fish.style.animationName = 'none';
                    fish.style.animationPlayState = 'paused';
                    fish.style.opacity = '0';
                    fish.style.display = 'none';
                    fish.style.visibility = 'hidden';
                });
                // Rensa arenan helt
                arena.innerHTML = '';
            }
            
            if (phaseEl) phaseEl.textContent = 'R√§kna fiskarna nu!';
            if (timerEl) {
                timerEl.style.display = 'block';
                timerEl.textContent = fishTimeLeft;
            }
            if (inputContainer) inputContainer.style.display = 'flex';
            
            // Starta timer
            startFishTimer();
            
            // Fokusera p√• input
            setTimeout(() => {
                const input = document.getElementById('fishInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitFishAnswer();
                        }
                    });
                }
            }, 100);
        }
        
        function createSwimmingFish(count, shouldSwim = true, roundIndex) {
            const arena = document.getElementById('fishArena');
            if (!arena) return;
            
            // Rensa gamla fiskar
            arena.innerHTML = '';
            
            const arenaRect = arena.getBoundingClientRect();
            let fishFinished = 0;
            const totalFish = count;
            
            for (let i = 0; i < count; i++) {
                const fish = document.createElement('div');
                fish.className = 'swimming-fish';
                fish.textContent = fishEmojis[Math.floor(Math.random() * fishEmojis.length)];
                
                // Slumpm√§ssig startposition (vertikal)
                const startY = Math.random() * (arenaRect.height - 60);
                fish.style.top = startY + 'px';
                
                // Olika storlekar
                const size = 0.8 + Math.random() * 0.4; // 0.8-1.2x
                fish.style.transform = `scale(${size})`;
                
                // Fiskarna simmar fr√•n v√§nster till h√∂ger - BARA EN G√ÖNG!
                if (shouldSwim) {
                    // Olika hastigheter och animation-delays
                    const speed = 3 + Math.random() * 2; // 3-5 sekunder
                    const delay = Math.random() * 3; // 0-3 sekunder delay (sprid ut dem)
                    
                    // S√§tt animation-egenskaperna SEPARAT f√∂r att s√§kerst√§lla att det inte loopar
                    fish.style.animationName = 'swim';
                    fish.style.animationDuration = `${speed}s`;
                    fish.style.animationTimingFunction = 'linear';
                    fish.style.animationDelay = `${delay}s`;
                    fish.style.animationIterationCount = '1'; // BARA EN G√ÖNG!
                    fish.style.animationFillMode = 'forwards';
                    fish.style.animationPlayState = 'running';
                    
                    // N√§r animationen √§r klar, r√§kna upp och stoppa animationen
                    const handleAnimationEnd = () => {
                        // Stoppa animationen explicit
                        fish.style.animation = 'none';
                        fish.style.animationName = 'none';
                        fish.style.opacity = '0';
                        fish.style.display = 'none';
                        
                        // Ta bort event listener s√• den inte triggas igen
                        fish.removeEventListener('animationend', handleAnimationEnd);
                        
                        fishFinished++;
                        // N√§r alla fiskar har simmat f√∂rbi, starta r√§kningsfasen!
                        if (fishFinished === totalFish) {
                            startCountingPhase();
                        }
                    };
                    
                    fish.addEventListener('animationend', handleAnimationEnd, { once: true });
                }
                
                arena.appendChild(fish);
            }
        }
        
        function startFishTimer() {
            if (fishTimer) {
                clearInterval(fishTimer);
            }
            
            fishTimer = setInterval(() => {
                if (fishPhase !== 'counting') return;
                
                fishTimeLeft--;
                const timerEl = document.getElementById('fishTimer');
                if (timerEl) {
                    timerEl.textContent = fishTimeLeft;
                    
                    if (fishTimeLeft <= 0) {
                        // Tiden √§r ute!
                        clearInterval(fishTimer);
                        if (!fishAnswered) {
                            const feedbackEl = document.getElementById('fishFeedback');
                            feedbackEl.textContent = `‚è±Ô∏è Tiden √§r ute! R√§tt svar var ${fishRounds[currentFishRound].count}`;
                            feedbackEl.className = 'fish-count-feedback timeout';
                            
                            // Disable input
                            const input = document.getElementById('fishInput');
                            const submitBtn = document.querySelector('.fish-count-submit');
                            if (input) input.disabled = true;
                            if (submitBtn) submitBtn.disabled = true;
                            
                            setTimeout(() => {
                                showFishRound(currentFishRound + 1);
                            }, 2000);
                        }
                    }
                }
            }, 1000);
        }
        
        function submitFishAnswer() {
            if (fishAnswered) return;
            
            const input = document.getElementById('fishInput');
            const feedbackEl = document.getElementById('fishFeedback');
            const submitBtn = document.querySelector('.fish-count-submit');
            
            if (!input || !feedbackEl) return;
            
            const answer = parseInt(input.value);
            const correctAnswer = fishRounds[currentFishRound].count;
            
            fishAnswered = true;
            clearInterval(fishTimer);
            
            // Disable input
            input.disabled = true;
            if (submitBtn) submitBtn.disabled = true;
            
            if (answer === correctAnswer) {
                correctFishCount++;
                feedbackEl.textContent = `‚úÖ R√§tt! Det var ${correctAnswer} fiskar!`;
                feedbackEl.className = 'fish-count-feedback correct';
            } else {
                feedbackEl.textContent = `‚ùå Fel! Det var ${correctAnswer} fiskar, inte ${answer || 0}`;
                feedbackEl.className = 'fish-count-feedback wrong';
            }
            
            // G√• vidare efter 2 sekunder
            setTimeout(() => {
                showFishRound(currentFishRound + 1);
            }, 2000);
        }
        
        function showFinalGiftBox() {
            // Alla fr√•gor besvarade - visa stort paket f√∂r √∂ppning!
            const container = document.getElementById('negationTestContainer');
            container.innerHTML = '';
            container.style.display = 'none';
            
            document.getElementById('giftBoxLargeContainer').classList.add('show');
            document.getElementById('giftBoxLarge').style.display = 'block';
            document.getElementById('openInstruction').style.display = 'block';
            document.getElementById('openInstruction').textContent = 'Dubbelklicka p√• paketet f√∂r att √∂ppna!';
            
            // Reset state f√∂r f√§rgsekvens-spel
            sequenceGameStarted = false;
            sequenceLevel = 1;
            sequence = [];
            playerSequence = [];
            colorPositions = [0, 1, 2, 3];
            stopColorEffects();
        }
        
        
        // √ñppningssekvens: F√§rgsekvens-spel (Simon Says) - MYCKET SV√ÖRARE!
        let sequenceGameStarted = false;
        let sequenceLevel = 1;
        let sequence = [];
        let playerSequence = [];
        let isShowingSequence = false;
        let isPlayerTurn = false;
        const colors = ['red', 'blue', 'yellow', 'green'];
        const MAX_SEQUENCE_LEVEL = 7; // Fler niv√•er!
        let colorPositions = [0, 1, 2, 3]; // Positioner f√∂r f√§rgerna
        let movementInterval = null;
        let distractionInterval = null;
        let colorButtonMap = {}; // Mappar f√§rg -> knapp element
        
        function handleGiftBoxClick(e) {
            const now = Date.now();
            const timeSinceLastClick = now - lastClickTime;
            const isDoubleClick = timeSinceLastClick < 300;
            lastClickTime = now;
            
            // Troll-effekter varje g√•ng man klickar!
            applyTrollEffects();
            
            if (!sequenceGameStarted && isDoubleClick) {
                // Starta f√§rgsekvens-spelet!
                startSequenceGame();
            }
        }
        
        function startSequenceGame() {
            sequenceGameStarted = true;
            sequenceLevel = 1;
            sequence = [];
            playerSequence = [];
            
            document.getElementById('giftBoxLarge').style.display = 'none';
            document.getElementById('openInstruction').style.display = 'none';
            document.getElementById('colorSequenceContainer').classList.add('active');
            
            // S√§tt upp f√§rgknapp-mappning
            setupColorButtonMap();
            
            // Starta kontinuerlig r√∂relse
            startColorMovement();
            
            // Starta distraktionsblinkningar
            startDistractionBlinks();
            
            // Starta f√∂rsta niv√•n
            startSequenceLevel();
        }
        
        function setupColorButtonMap() {
            colorButtonMap = {
                'red': document.getElementById('colorRed'),
                'blue': document.getElementById('colorBlue'),
                'yellow': document.getElementById('colorYellow'),
                'green': document.getElementById('colorGreen')
            };
        }
        
        function startColorMovement() {
            // F√§rgerna kan r√∂ra sig lite n√§r det √§r spelarens tur (men inte byta position automatiskt)
            // Positionbytet sker bara efter sekvensen!
            movementInterval = setInterval(() => {
                if (isPlayerTurn && !isShowingSequence) {
                    // Liten subtil r√∂relse, men INTE positionbyte (det sker bara efter sekvensen)
                    const buttons = document.querySelectorAll('.color-button');
                    buttons.forEach(btn => {
                        if (Math.random() < 0.1) { // 10% chans f√∂r liten r√∂relse
                            btn.classList.add('moving');
                            setTimeout(() => {
                                btn.classList.remove('moving');
                            }, 3000);
                        }
                    });
                }
            }, 3000);
        }
        
        function shuffleColorPositions() {
            // Blanda positionerna - TYDLIG VISUELL ANIMATION!
            const grid = document.querySelector('.color-grid');
            const buttons = Array.from(grid.querySelectorAll('.color-button'));
            
            // Fisher-Yates shuffle av positioner
            const positions = [0, 1, 2, 3];
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }
            
            colorPositions = positions;
            
            // TYDLIG VISUELL FLYTT - knapparna flyttas med stor animation!
            buttons.forEach((btn, index) => {
                const newIndex = colorPositions[index];
                
                // F√∂rst: g√∂r knappen st√∂rre och lite transparent (visar att den flyttas)
                btn.style.transform = 'scale(1.2)';
                btn.style.opacity = '0.7';
                btn.style.zIndex = '10';
                btn.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Flytta position
                btn.style.order = newIndex;
                
                // Efter animation: √•terst√§ll
                setTimeout(() => {
                    btn.style.transform = '';
                    btn.style.opacity = '';
                    btn.style.zIndex = '';
                    btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }, 600);
            });
        }
        
        function startDistractionBlinks() {
            // Distraktionsblinkningar - INTE under sekvensen, bara innan och efter!
            distractionInterval = setInterval(() => {
                // Bara n√§r det INTE √§r sekvensen som visas
                if (!isShowingSequence) {
                    const buttons = document.querySelectorAll('.color-button');
                    const randomButton = buttons[Math.floor(Math.random() * buttons.length)];
                    
                    // Glitch/blink effekt
                    randomButton.classList.add('distraction');
                    setTimeout(() => {
                        randomButton.classList.remove('distraction');
                    }, 200);
                }
            }, 600 + Math.random() * 800); // Var 0.6-1.4 sekunder
        }
        
        function doGlitchEffect() {
            // Glitch-effekt innan sekvensen b√∂rjar
            const buttons = document.querySelectorAll('.color-button');
            let glitchCount = 0;
            const maxGlitches = 3;
            
            const glitchInterval = setInterval(() => {
                buttons.forEach(btn => {
                    if (Math.random() < 0.4) {
                        btn.classList.add('distraction');
                        setTimeout(() => {
                            btn.classList.remove('distraction');
                        }, 150);
                    }
                });
                
                glitchCount++;
                if (glitchCount >= maxGlitches) {
                    clearInterval(glitchInterval);
                }
            }, 200);
        }
        
        function stopColorEffects() {
            if (movementInterval) {
                clearInterval(movementInterval);
                movementInterval = null;
            }
            if (distractionInterval) {
                clearInterval(distractionInterval);
                distractionInterval = null;
            }
        }
        
        function startSequenceLevel() {
            const instruction = document.getElementById('sequenceInstruction');
            const levelDisplay = document.getElementById('sequenceLevel');
            
            levelDisplay.textContent = `Niv√• ${sequenceLevel} av ${MAX_SEQUENCE_LEVEL}`;
            instruction.textContent = 'F√∂rbereder...';
            
            // L√§gg till en ny f√§rg till sekvensen
            sequence.push(colors[Math.floor(Math.random() * colors.length)]);
            
            // GLITCH-EFFEKT INNAN!
            doGlitchEffect();
            
            // Visa sekvensen (INGEN positionbyte innan!)
            setTimeout(() => {
                instruction.textContent = 'Titta N O G A p√• sekvensen!';
                isShowingSequence = true;
                isPlayerTurn = false;
                disableAllButtons();
                
                setTimeout(() => {
                    showSequence(0);
                }, 500);
            }, 600);
        }
        
        function showSequence(index) {
            if (index >= sequence.length) {
                // Sekvensen √§r klar - GLITCH EFFEKT EFTER!
                doGlitchEffect();
                
                // EFTER sekvensen - BYT POSITION P√Ö F√ÑRGERNA! (f√∂rvirrande!)
                setTimeout(() => {
                    shuffleColorPositions();
                    
                    // Efter positionbytet, nu √§r det spelarens tur
                    setTimeout(() => {
                        isShowingSequence = false;
                        isPlayerTurn = true;
                        playerSequence = [];
                        enableAllButtons();
                        
                        const instruction = document.getElementById('sequenceInstruction');
                        instruction.textContent = 'Upprepa sekvensen! (F√§rgerna har flyttat sig!)';
                    }, 700); // Efter positionbytet √§r klar
                }, 600); // Efter glitch
                return;
            }
            
            const color = sequence[index];
            // Hitta r√§tt knapp baserat p√• f√§rg (inte position!)
            const button = colorButtonMap[color];
            
            if (!button) return;
            
            // Flash-knappen - STARKARE!
            button.classList.add('flash');
            playColorSound(color);
            
            setTimeout(() => {
                button.classList.remove('flash');
                
                // SNABBARE paus mellan f√§rgerna (sv√•rare!)
                setTimeout(() => {
                    showSequence(index + 1);
                }, 200); // Snabbare! (tidigare 300)
            }, 400); // Snabbare flash! (tidigare 600)
        }
        
        function handleColorClick(color) {
            if (!isPlayerTurn || isShowingSequence) return;
            
            // Hitta r√§tt knapp baserat p√• f√§rg (inte position!)
            const button = colorButtonMap[color];
            if (!button) return;
            
            button.classList.add('pressed');
            playColorSound(color);
            
            setTimeout(() => {
                button.classList.remove('pressed');
            }, 200);
            
            playerSequence.push(color);
            
            // Kolla om sekvensen √§r korrekt s√• l√•ngt
            const currentIndex = playerSequence.length - 1;
            if (playerSequence[currentIndex] !== sequence[currentIndex]) {
                // Fel! B√∂rja om
                wrongSequence();
                return;
            }
            
            // EFTER att spelaren klickat r√§tt - BYT POSITION P√Ö F√ÑRGERNA! (ibland)
            // Men inte om det var sista f√§rgen i sekvensen
            if (playerSequence.length < sequence.length) {
                // 60% chans att f√§rgerna flyttar sig efter varje klick!
                if (Math.random() < 0.6) {
                    setTimeout(() => {
                        // Byt position p√• en eller flera andra f√§rger (inte den som just klickades)
                        shuffleSomeColors(color);
                    }, 400); // Efter en kort delay
                }
            }
            
            // Om spelaren har klickat hela sekvensen korrekt
            if (playerSequence.length === sequence.length) {
                if (sequenceLevel >= MAX_SEQUENCE_LEVEL) {
                    // Alla niv√•er klara!
                    stopColorEffects();
                    openGiftBox();
                } else {
                    // N√§sta niv√•
                    sequenceLevel++;
                    playerSequence = [];
                    disableAllButtons();
                    
                    const instruction = document.getElementById('sequenceInstruction');
                    instruction.textContent = 'R√§tt! F√∂rbereder n√§sta niv√•...';
                    
                    setTimeout(() => {
                        startSequenceLevel();
                    }, 1500);
                }
            }
        }
        
        function shuffleSomeColors(clickedColor) {
            // Byt position p√• 1-2 andra f√§rger (inte den som just klickades)
            const otherColors = colors.filter(c => c !== clickedColor);
            const numToShuffle = Math.random() < 0.5 ? 1 : 2; // 1 eller 2 f√§rger
            
            // Blanda positionerna
            const grid = document.querySelector('.color-grid');
            const buttons = Array.from(grid.querySelectorAll('.color-button'));
            
            // V√§lj slumpm√§ssiga f√§rger att flytta (utom den som klickades)
            const colorsToShuffle = [];
            const shuffled = [...otherColors];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            for (let i = 0; i < numToShuffle && i < shuffled.length; i++) {
                colorsToShuffle.push(shuffled[i]);
            }
            
            // Hitta knapparna f√∂r dessa f√§rger och byt deras positioner
            const buttonsToMove = colorsToShuffle.map(c => colorButtonMap[c]).filter(b => b);
            
            if (buttonsToMove.length > 0) {
                // Blanda positionerna f√∂r dessa knappar
                const currentOrders = buttonsToMove.map(btn => parseInt(btn.style.order) || Array.from(buttons).indexOf(btn));
                const newOrders = [...currentOrders];
                
                // Fisher-Yates shuffle
                for (let i = newOrders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newOrders[i], newOrders[j]] = [newOrders[j], newOrders[i]];
                }
                
                // Flytta knapparna
                buttonsToMove.forEach((btn, index) => {
                    const newOrder = newOrders[index];
                    btn.style.order = newOrder;
                    btn.style.transform = 'scale(1.15)';
                    btn.style.opacity = '0.8';
                    btn.style.zIndex = '10';
                    btn.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        btn.style.transform = '';
                        btn.style.opacity = '';
                        btn.style.zIndex = '';
                        btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    }, 500);
                });
            }
        }
        
        function wrongSequence() {
            isPlayerTurn = false;
            disableAllButtons();
            
            const instruction = document.getElementById('sequenceInstruction');
            instruction.textContent = 'Fel! B√∂rjar om fr√•n b√∂rjan...';
            instruction.style.color = '#ff6b6b';
            
            // B√∂rja om fr√•n niv√• 1
            setTimeout(() => {
                sequenceLevel = 1;
                sequence = [];
                playerSequence = [];
                colorPositions = [0, 1, 2, 3]; // √Öterst√§ll positioner
                instruction.style.color = '#ffd700';
                startSequenceLevel();
            }, 2000);
        }
        
        function disableAllButtons() {
            document.querySelectorAll('.color-button').forEach(btn => {
                btn.classList.add('disabled');
            });
        }
        
        function enableAllButtons() {
            document.querySelectorAll('.color-button').forEach(btn => {
                btn.classList.remove('disabled');
            });
        }
        
        function playColorSound(color) {
            // Enkelt ljud f√∂r varje f√§rg
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Olika frekvenser f√∂r olika f√§rger
            const frequencies = {
                red: 300,
                blue: 400,
                yellow: 500,
                green: 600
            };
            
            oscillator.frequency.value = frequencies[color];
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }
        
        // Setup event listeners f√∂r f√§rgknapparna (k√∂rs n√§r spelet startar)
        function setupColorButtons() {
            document.getElementById('colorRed').addEventListener('click', () => handleColorClick('red'));
            document.getElementById('colorBlue').addEventListener('click', () => handleColorClick('blue'));
            document.getElementById('colorYellow').addEventListener('click', () => handleColorClick('yellow'));
            document.getElementById('colorGreen').addEventListener('click', () => handleColorClick('green'));
        }
        
        // S√§tt upp event listeners direkt (knapparna finns redan i HTML)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupColorButtons);
        } else {
            setupColorButtons();
        }
        
        function applyTrollEffects() {
            const largeBox = document.getElementById('giftBoxLarge');
            const instruction = document.getElementById('openInstruction');
            
            // Slumpm√§ssiga troll-effekter
            const trollEffect = Math.floor(Math.random() * 6);
            
            switch(trollEffect) {
                case 0:
                    // Paketet r√∂r sig
                    const randomX = (Math.random() - 0.5) * 100;
                    const randomY = (Math.random() - 0.5) * 100;
                    largeBox.style.transform = `translate(${randomX}px, ${randomY}px)`;
                    setTimeout(() => {
                        largeBox.style.transform = '';
                    }, 500);
                    break;
                case 1:
                    // Paketet √§ndrar storlek
                    largeBox.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        largeBox.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            largeBox.style.transform = '';
                        }, 300);
                    }, 300);
                    break;
                case 2:
                    // Falskt "√∂ppnar..." meddelande
                    const oldText = instruction.textContent;
                    instruction.textContent = '√ñppnar...';
                    instruction.style.color = '#4caf50';
                    setTimeout(() => {
                        instruction.textContent = oldText;
                        instruction.style.color = '#ffd700';
                    }, 1000);
                    break;
                case 3:
                    // Paketet roterar
                    largeBox.style.transform = 'rotate(180deg)';
                    setTimeout(() => {
                        largeBox.style.transform = 'rotate(0deg)';
                    }, 500);
                    break;
                case 4:
                    // Falskt felmeddelande
                    const oldText2 = instruction.textContent;
                    instruction.textContent = 'Fel! F√∂rs√∂k igen!';
                    instruction.style.color = '#ff6b6b';
                    setTimeout(() => {
                        instruction.textContent = oldText2;
                        instruction.style.color = '#ffd700';
                    }, 800);
                    break;
                case 5:
                    // Paketet "hoppar"
                    largeBox.style.transform = 'translateY(-30px)';
                    setTimeout(() => {
                        largeBox.style.transform = '';
                    }, 400);
                    break;
            }
        }
        
        function createCornerMarkers() {
            const largeBox = document.getElementById('giftBoxLarge');
            const corners = [
                { position: 'top-left', x: 0, y: 0 },
                { position: 'top-right', x: 100, y: 0 },
                { position: 'bottom-right', x: 100, y: 100 },
                { position: 'bottom-left', x: 0, y: 100 }
            ];
            
            // R√§tt ordning: top-left, bottom-right, top-right, bottom-left
            const correctOrder = [0, 2, 1, 3];
            let currentCornerIndex = 0;
            
            corners.forEach((corner, index) => {
                const marker = document.createElement('div');
                marker.className = 'corner-marker';
                marker.style.position = 'absolute';
                marker.style.left = corner.x + '%';
                marker.style.top = corner.y + '%';
                marker.style.width = '30px';
                marker.style.height = '30px';
                marker.style.border = '2px solid #ffd700';
                marker.style.borderRadius = '50%';
                marker.style.background = 'rgba(255, 215, 0, 0.3)';
                marker.style.cursor = 'pointer';
                marker.style.transform = 'translate(-50%, -50%)';
                marker.dataset.cornerIndex = index;
                marker.onclick = (e) => {
                    e.stopPropagation();
                    if (parseInt(marker.dataset.cornerIndex) === correctOrder[currentCornerIndex]) {
                        // R√§tt h√∂rn!
                        marker.style.background = 'rgba(76, 175, 80, 0.5)';
                        currentCornerIndex++;
                        if (currentCornerIndex === 4) {
                            // Alla h√∂rn klickade i r√§tt ordning!
                            setTimeout(() => {
                                openGiftBox();
                            }, 500);
                        }
                    } else {
                        // Fel h√∂rn - b√∂rja om
                        currentCornerIndex = 0;
                        document.querySelectorAll('.corner-marker').forEach(m => {
                            m.style.background = 'rgba(255, 215, 0, 0.3)';
                        });
                    }
                };
                largeBox.appendChild(marker);
            });
        }
        
        function startGiftBoxTrollEffects() {
            // Kontinuerliga troll-effekter var 3-5 sekunder
            giftBoxTrollInterval = setInterval(() => {
                if (giftBoxOpenStep < 3) { // Bara n√§r paketet inte √§r √∂ppnat
                    const largeBox = document.getElementById('giftBoxLarge');
                    const troll = Math.floor(Math.random() * 4);
                    
                    switch(troll) {
                        case 0:
                            // Paketet "pulsar"
                            largeBox.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                largeBox.style.transform = '';
                            }, 300);
                            break;
                        case 1:
                            // Paketet "skakar"
                            largeBox.style.animation = 'shake 0.5s';
                            setTimeout(() => {
                                largeBox.style.animation = '';
                            }, 500);
                            break;
                        case 2:
                            // Paketet blir lite transparent
                            largeBox.style.opacity = '0.7';
                            setTimeout(() => {
                                largeBox.style.opacity = '1';
                            }, 500);
                            break;
                        case 3:
                            // Paketet "hoppar" lite
                            largeBox.style.transform = 'translateY(-10px)';
                            setTimeout(() => {
                                largeBox.style.transform = '';
                            }, 400);
                            break;
                    }
                }
            }, 3000 + Math.random() * 2000); // Var 3-5 sekunder
        }
        
        function stopGiftBoxTrollEffects() {
            if (giftBoxTrollInterval) {
                clearInterval(giftBoxTrollInterval);
                giftBoxTrollInterval = null;
            }
        }
        
        function updateOpenInstruction() {
            const instruction = document.getElementById('openInstruction');
            if (!sequenceGameStarted) {
                instruction.textContent = 'Dubbelklicka p√• paketet f√∂r att b√∂rja!';
            }
        }
        
        function openGiftBox() {
            // Stoppa troll-effekter
            stopGiftBoxTrollEffects();
            
            // Stoppa f√§rgr√∂relser och distraktionsblinkningar
            stopColorEffects();
            
            // Ta bort f√§rgsekvens-spel
            document.getElementById('colorSequenceContainer').classList.remove('active');
            
            const largeBox = document.getElementById('giftBoxLarge');
            largeBox.style.display = 'block';
            largeBox.classList.add('opening');
            
            setTimeout(() => {
                document.getElementById('giftBoxLargeContainer').classList.remove('show');
                document.getElementById('giftCardContainer').classList.add('show');
            }, 1000);
        }

        // ============================================
        // ADMIN PANEL
        // ============================================
        function handleTitleClick() {
            titleClickCount++;
            if (titleClickCount >= 7) {
                toggleAdmin();
                titleClickCount = 0;
            }
        }

        function toggleAdmin() {
            adminMode = !adminMode;
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('show', adminMode);
        }

        // Secret test code input
        const SECRET_KEY = 'test123'; // Hemlig kod f√∂r att hoppa mellan niv√•er

        function showSecretInput() {
            document.getElementById('secretInput').style.display = 'block';
            document.getElementById('secretCodeInput').focus();
        }

        function hideSecretInput() {
            document.getElementById('secretInput').style.display = 'none';
            document.getElementById('secretCodeInput').value = '';
        }

        function checkSecretCode() {
            const input = document.getElementById('secretCodeInput').value;
            if (input === SECRET_KEY) {
                const level = prompt('Vilken niv√•? (0=Start, 1-5=Niv√•er, 6=Final):');
                const levelNum = parseInt(level);
                if (!isNaN(levelNum) && levelNum >= 0 && levelNum <= 6) {
                    goToLevel(levelNum);
                    hideSecretInput();
                }
            } else {
                alert('Fel kod!');
            }
        }

        // Allow Enter key in secret input
        document.addEventListener('DOMContentLoaded', function() {
            const secretInput = document.getElementById('secretCodeInput');
            if (secretInput) {
                secretInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkSecretCode();
                    }
                });
            }
        });

        function goToLevel(level) {
            // Set current level to bypass puzzle checks
            currentLevel = level;
            showView(level);
            if (level === 2) initMemoryGame();
            if (level === 4) initLogicPuzzle();
            if (level === 5) initFishMath();
            if (level === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            // Update progress
            updateProgress();
        }

        function resetProgress() {
            localStorage.removeItem('escapeRoomLevel');
            currentLevel = 0;
            
            // Reset captcha interval flag
            stopCaptchaInterval();
            captchaIntervalStarted = false;
            
            showView(0);
            alert('Progress nollst√§lld!');
        }

        function restartGame() {
            if (confirm('√Ñr du s√§ker p√• att du vill b√∂rja om fr√•n b√∂rjan? All progress kommer att f√∂rsvinna.')) {
                localStorage.removeItem('escapeRoomLevel');
                currentLevel = 0;
                hintStates = {};
                
                // Reset captcha interval flag so it can start again
                stopCaptchaInterval();
                captchaIntervalStarted = false;
                
                // Reset all inputs
                const wordInput = document.getElementById('wordInput');
                if (wordInput) wordInput.value = '';
                
                const cipherInput = document.getElementById('cipherInput');
                if (cipherInput) cipherInput.value = '';
                
                const fishCodeInput = document.getElementById('fishCodeInput');
                if (fishCodeInput) fishCodeInput.value = '';
                
                // Reset all messages
                for (let i = 1; i <= 5; i++) {
                    showMessage('message' + i, '', '');
                }
                
                // Reset hints
                for (let i = 1; i <= 5; i++) {
                    const hintDiv = document.getElementById('hint' + i);
                    if (hintDiv) {
                        hintDiv.classList.remove('show');
                        hintDiv.textContent = '';
                    }
                }
                
                // Reset memory game
                stopMemoryCardSwapping();
                matchedPairs = 0;
                flippedCards = [];
                canFlip = true;
                const memoryGrid = document.getElementById('memoryGrid');
                if (memoryGrid) {
                    memoryGrid.innerHTML = '';
                }
                
                // Reset logic puzzle selects
                const fishers = ['erik', 'lisa', 'olle', 'sara'];
                fishers.forEach(fisher => {
                    const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                    const methodSelect = document.getElementById(`logic-${fisher}-method`);
                    if (fishSelect) fishSelect.value = '';
                    if (methodSelect) methodSelect.value = '';
                });
                
                stopAnnoyingPopups();
                stopCaptchaInterval();
                popupCount = 0;
                fakeLevelCompleteShown = {}; // Reset fake level complete
                if (fakeCountdownInterval) {
                    clearInterval(fakeCountdownInterval);
                    const countdown = document.getElementById('fakeCountdown');
                    if (countdown) countdown.remove();
                }
                backgroundMusicPlaying = false;
                showView(0);
            }
        }

        function showAnswers() {
            const answers = `
FACIT:
Niv√• 1: ${CONFIG.wordAnswer}
Niv√• 2: Hitta alla par i memory-spelet. Koden √§r: 2468
Niv√• 3: ${CONFIG.cipherAnswer} (ROT16 av "${CONFIG.cipherText}")
Niv√• 4: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G√§dda+Grundfiske, Sara=Ruda+Isfiske (Kod: 2468)
Niv√• 5: Lax=6, Abborre=6, G√§dda=12, Ruda=9. Summa=33
            `;
            alert(answers);
        }

        // ============================================
        // ANNOYING POPUPS SYSTEM
        // ============================================
        let popupInterval = null;
        let popupCount = 0;
        let nextPopupTimeout = null;
        let isPopupOpen = false;
        
        // ============================================
        // TROLL FEATURES
        // ============================================
        const fakeHintMessages = [
            "T√§nk p√• f√§rgen bl√•!",
            "Svaret √§r 42!",
            "Klicka tre g√•nger p√• titeln!",
            "Prova att v√§nda sk√§rmen upp och ner!",
            "Svaret finns i fr√•gan!",
            "T√§nk utanf√∂r boxen!",
            "Anv√§nd kraften, Luke!",
            "Koden √§r alltid 0000!",
            "Titta i spegeln!",
            "Svaret √§r i luften!",
            "Prova att blinka tre g√•nger!",
            "Svaret √§r bakl√§nges!",
            "T√§nk p√• en siffra mellan 1 och 10!",
            "Klicka p√• alla knappar samtidigt!",
            "Svaret √§r i konsolen (F12)!",
            "Prova att sjunga svaret!",
            "T√§nk positivt!",
            "Svaret √§r alltid 'test'!",
            "Klicka snabbt 100 g√•nger!",
            "Svaret finns i URL:en!",
            "Prova att v√§nda p√• tangentbordet!",
            "T√§nk p√• din favoritf√§rg!",
            "Svaret √§r samma som fr√•gan!",
            "Klicka med v√§nster hand om du √§r h√∂gerh√§nt!",
            "Svaret √§r det f√∂rsta du t√§nker p√•!"
        ];
        
        const fakeHintMessagesStep2 = [
            "Hmm, det hj√§lpte inte? Prova igen!",
            "Oj, det var fel ledtr√•d. F√∂rs√∂k √§nd√•!",
            "Bara skojade! Du f√•r klura sj√§lv!",
            "Haha, trodde du att jag skulle hj√§lpa dig?",
            "N√§, den ledtr√•den var inte s√• bra. Forts√§tt gissa!",
            "Oj, det var en distraktion. Ignorera det!",
            "Haha, bara testade om du lyssnade!",
            "N√§, den hj√§lper inte. Du f√•r t√§nka sj√§lv!",
            "Bara skojade igen! Ingen hj√§lp h√§r!",
            "Hmm, det var inte r√§tt ledtr√•d. F√∂rs√∂k √§nd√•!"
        ];
        
        let buttonSwapInterval = null;
        let fakeLevelCompleteShown = {};
        let fakeCountdownInterval = null;
        let fakeCountdownTime = 300; // 5 minutes
        let backgroundMusicPlaying = false;
        let audioContext = null;
        let captchaInterval = null;
        let captchaAttempts = 0;
        let captchaIntervalStarted = false;

        const annoyingMessages = [
            "Har du kollat under s√§ngen?",
            "Vet du vad klockan √§r?",
            "T√§nk om allt √§r en dr√∂m?",
            "Har du gl√∂mt n√•got?",
            "Vad √§r meningen med livet?",
            "Klicka h√§r f√∂r gratis pengar!",
            "Systemfel: Kontakta support",
            "Din session har g√•tt ut. Logga in igen.",
            "Varning: Virus uppt√§ckt!",
            "Uppdatering kr√§vs. Starta om nu?",
            "Fel 404: Hj√§rnan hittades inte",
            "Har du sett mina nycklar?",
            "Vad √§r 2+2? (Svara snabbt!)",
            "Du har vunnit en bil! Klicka h√§r!",
            "Systemet har uppt√§ckt misst√§nkt aktivitet.",
            "Vill du spara dina √§ndringar?",
            "Din dator kommer att st√§ngas av om 5 sekunder...",
            "N√•gon f√∂rs√∂ker hacka ditt konto!",
            "Grattis! Du √§r anv√§ndare #1,000,000!",
            "Varning: Batteriet √§r l√•gt (0%)"
        ];

        function createAnnoyingPopup(message, isMoving = false, hasClose = true) {
            // Don't create if another popup is already open
            if (isPopupOpen) {
                return;
            }
            
            isPopupOpen = true;
            popupCount++;
            
            // Create overlay to block interaction
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.id = 'popupOverlay' + popupCount;
            overlay.onclick = function(e) {
                // Prevent closing by clicking overlay - must click button
                e.stopPropagation();
            };
            document.body.appendChild(overlay);
            
            const popup = document.createElement('div');
            popup.className = 'annoying-popup' + (isMoving ? ' moving' : '');
            popup.id = 'annoyingPopup' + popupCount;
            
            // Center popup or random position
            if (isMoving) {
                const x = Math.random() * (window.innerWidth - 300);
                const y = Math.random() * (window.innerHeight - 200);
                popup.style.left = x + 'px';
                popup.style.top = y + 'px';
            } else {
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            }
            
            // Create illogical button options
            const buttonOptions = [
                { text: "Ja", action: "close" },
                { text: "Nej", action: "close" },
                { text: "Kanske", action: "close" },
                { text: "Avbryt", action: "close" },
                { text: "Forts√§tt", action: "close" },
                { text: "St√§ng", action: "close" },
                { text: "OK", action: "close" },
                { text: "Acceptera", action: "close" },
                { text: "Avvisa", action: "close" },
                { text: "Ignorera", action: "close" }
            ];
            
            // Random button text (all close the popup, but confusing)
            const buttonText = buttonOptions[Math.floor(Math.random() * buttonOptions.length)].text;
            
            // Sometimes add fake buttons that don't work
            const hasFakeButtons = Math.random() > 0.5;
            let buttonsHTML = '';
            
            if (hasFakeButtons) {
                // Add 2-3 fake buttons and 1 real one
                const fakeButtons = ['St√§ng', 'Avbryt', 'OK', 'Forts√§tt', 'Ignorera'].filter(b => b !== buttonText);
                const shuffled = fakeButtons.sort(() => Math.random() - 0.5).slice(0, 2);
                
                buttonsHTML = `
                    <button onclick="this.style.opacity='0.5'; this.disabled=true; setTimeout(() => { this.style.opacity='1'; this.disabled=false; }, 500);" style="margin: 5px;">${shuffled[0]}</button>
                    <button onclick="this.style.opacity='0.5'; this.disabled=true; setTimeout(() => { this.style.opacity='1'; this.disabled=false; }, 500);" style="margin: 5px;">${shuffled[1]}</button>
                    <button onclick="closeAnnoyingPopup(${popupCount})" style="margin: 5px;">${buttonText}</button>
                `;
            } else {
                buttonsHTML = `<button onclick="closeAnnoyingPopup(${popupCount})" style="margin: 5px;">${buttonText}</button>`;
            }
            
            popup.innerHTML = `
                ${hasClose ? '<button class="close-btn" onclick="closeAnnoyingPopup(' + popupCount + ')">√ó</button>' : ''}
                <div style="margin-bottom: 15px;">${message}</div>
                <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                    ${buttonsHTML}
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Make it move if isMoving
            if (isMoving) {
                let moveInterval = setInterval(() => {
                    if (!document.getElementById('annoyingPopup' + popupCount)) {
                        clearInterval(moveInterval);
                        return;
                    }
                    const newX = Math.random() * (window.innerWidth - 300);
                    const newY = Math.random() * (window.innerHeight - 200);
                    popup.style.left = newX + 'px';
                    popup.style.top = newY + 'px';
                }, 1000);
                
                // Keep moving indefinitely until closed
            }
            
            // NO AUTO-CLOSE - user must click to close
        }

        function closeAnnoyingPopup(id) {
            const popup = document.getElementById('annoyingPopup' + id);
            const overlay = document.getElementById('popupOverlay' + id);
            
            if (popup) {
                // Cleanup event listeners
                if (popup._cleanup) {
                    popup._cleanup();
                }
                
                popup.style.animation = 'popupPulse 0.3s ease-out reverse';
                setTimeout(() => {
                    popup.remove();
                    if (overlay) overlay.remove();
                    isPopupOpen = false;
                    
                    // Schedule next popup after 60 seconds (1 minute)
                    if (nextPopupTimeout) {
                        clearTimeout(nextPopupTimeout);
                    }
                    nextPopupTimeout = setTimeout(() => {
                        if (currentLevel > 0 && currentLevel < 6 && !isPopupOpen) {
                            const isMoving = Math.random() > 0.7;
                            const message = annoyingMessages[Math.floor(Math.random() * annoyingMessages.length)];
                            createAnnoyingPopup(message, isMoving, true);
                        }
                    }, 60000); // 60 seconds = 1 minute
                }, 300);
            } else if (overlay) {
                overlay.remove();
                isPopupOpen = false;
            }
        }

        function showRestartTrollPopup() {
            // Check if troll popup has already been shown (first time only)
            const hasShownTroll = localStorage.getItem('hasShownTrollPopup');
            if (hasShownTroll === 'true') {
                // Skip troll popup, go directly to level 5
                setTimeout(() => showView(5), 500);
                return;
            }
            
            // Don't create if another popup is already open
            if (isPopupOpen) {
                return;
            }
            
            // Mark as shown
            localStorage.setItem('hasShownTrollPopup', 'true');
            
            isPopupOpen = true;
            popupCount++;
            
            // Create overlay to block interaction
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.id = 'popupOverlayTroll';
            overlay.onclick = function(e) {
                e.stopPropagation();
            };
            document.body.appendChild(overlay);
            
            const popup = document.createElement('div');
            popup.className = 'annoying-popup moving';
            popup.id = 'annoyingPopupTroll';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '20000';
            
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 1.2em;">
                    <strong>Vill du b√∂rja om fr√•n b√∂rjan?</strong>
                </div>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                    <button onclick="handleTrollRestart()" style="font-size: 1.1em; padding: 15px 30px;">Ja</button>
                    <button onclick="handleTrollRestart()" style="font-size: 1.1em; padding: 15px 30px;">Ja</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Make it move around
            let moveCount = 0;
            const moveInterval = setInterval(() => {
                moveCount++;
                const newX = 50 + (Math.random() - 0.5) * 20; // 40-60%
                const newY = 50 + (Math.random() - 0.5) * 20; // 40-60%
                popup.style.left = newX + '%';
                popup.style.top = newY + '%';
                
                if (moveCount > 20) {
                    clearInterval(moveInterval);
                }
            }, 500);
        }

        function handleTrollRestart() {
            // Actually restart the game!
            const popup = document.getElementById('annoyingPopupTroll');
            const overlay = document.getElementById('popupOverlayTroll');
            if (popup) {
                popup.remove();
            }
            if (overlay) {
                overlay.remove();
            }
            
            isPopupOpen = false;
            
            // Reset everything and restart
            localStorage.removeItem('escapeRoomLevel');
            localStorage.removeItem('hasShownTrollPopup'); // Reset so it shows again next time
            currentLevel = 0;
            hintStates = {};
            popupCount = 0;
            
            // Reset all inputs
            const wordInput = document.getElementById('wordInput');
            if (wordInput) wordInput.value = '';
            
            const cipherInput = document.getElementById('cipherInput');
            if (cipherInput) cipherInput.value = '';
            
            const fishCodeInput = document.getElementById('fishCodeInput');
            if (fishCodeInput) fishCodeInput.value = '';
            
            // Reset all messages
            for (let i = 1; i <= 5; i++) {
                showMessage('message' + i, '', '');
            }
            
            // Reset hints
            for (let i = 1; i <= 5; i++) {
                const hintDiv = document.getElementById('hint' + i);
                if (hintDiv) {
                    hintDiv.classList.remove('show');
                    hintDiv.textContent = '';
                }
            }
            
            // Reset memory game
            matchedPairs = 0;
            flippedCards = [];
            canFlip = true;
            const memoryGrid = document.getElementById('memoryGrid');
            if (memoryGrid) {
                memoryGrid.innerHTML = '';
            }
            
            // Reset logic puzzle selects
            const fishers = ['erik', 'lisa', 'olle', 'sara'];
            fishers.forEach(fisher => {
                const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                const methodSelect = document.getElementById(`logic-${fisher}-method`);
                if (fishSelect) fishSelect.value = '';
                if (methodSelect) methodSelect.value = '';
            });
            
            // Stop all popups
            stopAnnoyingPopups();
            
            // Go back to start
            showView(0);
        }

        function startAnnoyingPopups() {
            // Stop any existing interval
            if (popupInterval) {
                clearInterval(popupInterval);
            }
            
            // Clear any pending popup timeout
            if (nextPopupTimeout) {
                clearTimeout(nextPopupTimeout);
            }
            
            // Show first popup immediately (only if no popup is open)
            if (currentLevel > 0 && currentLevel < 6 && !isPopupOpen) {
                const isMoving = Math.random() > 0.7; // 30% chance of moving popup
                const message = annoyingMessages[Math.floor(Math.random() * annoyingMessages.length)];
                createAnnoyingPopup(message, isMoving, true);
            }
            
            // Don't use interval anymore - popups are scheduled when previous one closes
        }

        function stopAnnoyingPopups() {
            if (popupInterval) {
                clearInterval(popupInterval);
                popupInterval = null;
            }
            stopCaptchaInterval();
            // Close all existing popups
            document.querySelectorAll('.annoying-popup').forEach(popup => popup.remove());
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showMessage(elementId, message, type) {
            const elem = document.getElementById(elementId);
            if (!message) {
                elem.innerHTML = '';
                elem.className = 'message';
                return;
            }
            elem.innerHTML = message;
            elem.className = 'message ' + type;
        }

        function createSnowflakes() {
            const container = document.getElementById('snowflakes');
            const flakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
            
            for (let i = 0; i < 50; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = flakes[Math.floor(Math.random() * flakes.length)];
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.animationDelay = Math.random() * 2 + 's';
                flake.style.opacity = Math.random() * 0.5 + 0.3;
                container.appendChild(flake);
            }
        }

        // ============================================
        // FAKE LOADING SCREEN
        // ============================================
        function showFakeLoadingScreen() {
            const loadingScreen = document.getElementById('fakeLoadingScreen');
            const loadingBar = document.getElementById('fakeLoadingBar');
            const loadingText = document.getElementById('fakeLoadingText');
            const loadingButton = document.getElementById('fakeLoadingButton');
            
            loadingScreen.style.display = 'flex';
            
            let progress = 0;
            let goingWrong = false;
            
            const loadingInterval = setInterval(() => {
                if (progress < 100) {
                    if (Math.random() < 0.3 && progress > 30 && progress < 90) {
                        // Go backwards sometimes
                        progress = Math.max(0, progress - Math.random() * 20);
                        goingWrong = true;
                        loadingBar.classList.add('going-wrong');
                        loadingText.textContent = '√Öterst√§ller...';
                    } else {
                        progress += Math.random() * 15;
                        progress = Math.min(100, progress);
                        goingWrong = false;
                        loadingBar.classList.remove('going-wrong');
                        
                        const messages = [
                            'Initierar system...',
                            'Laddar komponenter...',
                            'Verifierar data...',
                            'Kontrollerar anslutning...',
                            'S√§kerhetskontroll...',
                            'N√§stan klar...',
                            'Finaliserar...'
                        ];
                        loadingText.textContent = messages[Math.floor(Math.random() * messages.length)];
                    }
                    
                    loadingBar.style.width = progress + '%';
                } else {
                    clearInterval(loadingInterval);
                    loadingText.textContent = 'Laddning klar!';
                    loadingButton.style.display = 'block';
                }
            }, 300);
        }
        
        function skipFakeLoading() {
            document.getElementById('fakeLoadingScreen').classList.remove('show');
            
            // Now do the real init
            const savedLevel = localStorage.getItem('escapeRoomLevel');
            if (savedLevel) {
                currentLevel = parseInt(savedLevel);
            }
            
            document.getElementById('title').addEventListener('click', handleTitleClick);
            showView(currentLevel);
            updateProgress();
            
            if (currentLevel === 2) initMemoryGame();
            if (currentLevel === 4) initLogicPuzzle();
            if (currentLevel === 5) initFishMath();
            if (currentLevel === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            
            createSnowflakes();
            startBackgroundMusic();
            setupClickSounds();
            startFakeCountdown();
            startFakeSavingMessages();
        }
        
        // ============================================
        // FAKE COUNTDOWN
        // ============================================
        function startFakeCountdown() {
            // Create countdown element
            const countdown = document.createElement('div');
            countdown.className = 'fake-countdown';
            countdown.id = 'fakeCountdown';
            countdown.textContent = 'Tid kvar: 5:00';
            document.body.appendChild(countdown);
            
            let time = 300; // 5 minutes
            fakeCountdownInterval = setInterval(() => {
                time--;
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                countdown.textContent = `Tid kvar: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (time <= 0) {
                    time = 300; // Reset
                }
            }, 1000);
        }
        
        // ============================================
        // FAKE SAVING MESSAGES
        // ============================================
        function startFakeSavingMessages() {
            setInterval(() => {
                if (currentLevel > 0 && currentLevel < 6 && Math.random() < 0.15) {
                    showFakeSavingMessage();
                }
            }, 20000 + Math.random() * 30000); // Every 20-50 seconds
        }
        
        function showFakeSavingMessage() {
            const savingMsg = document.createElement('div');
            savingMsg.className = 'fake-saving-message show';
            savingMsg.textContent = 'Sparar... var god v√§nta';
            document.body.appendChild(savingMsg);
            
            // Never actually save, just show the message
            setTimeout(() => {
                savingMsg.remove();
            }, 5000);
        }
        
        // ============================================
        // AUDIO FUNCTIONS
        // ============================================
        function setupClickSounds() {
            // Create audio context for generating sounds
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio not supported');
                return;
            }
            
            // Add click sounds to all buttons
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && Math.random() < 0.3) {
                    playRandomClickSound();
                }
            });
        }
        
        function playRandomClickSound() {
            if (!audioContext) return;
            
            const sounds = ['beep', 'boop', 'plop', 'ping', 'pop'];
            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Different frequencies for different sounds
            const frequencies = {
                'beep': 440,
                'boop': 330,
                'plop': 220,
                'ping': 880,
                'pop': 550
            };
            
            oscillator.frequency.value = frequencies[sound] || 440;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        function startBackgroundMusic() {
            if (backgroundMusicPlaying) return;
            
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                
                // Christmas melody: "Jingle Bells" simplified
                // Notes: E E E, E E E, E G C D E
                const melody = [
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 400 }, // E (long)
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 400 }, // E (long)
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 392.00, duration: 200 }, // G
                    { freq: 261.63, duration: 200 }, // C
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 329.63, duration: 600 }, // E (long)
                    // Rest
                    { freq: 0, duration: 200 },
                    // Repeat with variation
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 400 }, // D (long)
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 400 }, // D (long)
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 246.94, duration: 200 }, // B
                    { freq: 261.63, duration: 600 }, // C (long)
                ];
                
                let melodyIndex = 0;
                
                function playNote() {
                    if (!backgroundMusicPlaying || !audioContext) return;
                    
                    const note = melody[melodyIndex];
                    
                    if (note.freq > 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = note.freq;
                        oscillator.type = 'triangle'; // Softer sound
                        
                        gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.duration / 1000);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + note.duration / 1000);
                    }
                    
                    melodyIndex = (melodyIndex + 1) % melody.length;
                    
                    setTimeout(playNote, note.duration);
                }
                
                backgroundMusicPlaying = true;
                playNote();
            } catch (e) {
                console.log('Background music not supported');
            }
        }
        
        // ============================================
        // FAKE CAPTCHA
        // ============================================
        function showFakeCaptcha() {
            const captcha = document.getElementById('fakeCaptcha');
            const grid = document.getElementById('fakeCaptchaGrid');
            grid.innerHTML = '';
            
            // Create 9 boxes with emoji "images" (no actual traffic lights)
            const emojis = ['üöó', 'üå≥', 'üè†', '‚òÅÔ∏è', '‚≠ê', 'üåô', 'üéÑ', '‚ùÑÔ∏è', 'üéÅ'];
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'fake-captcha-image';
                box.dataset.index = i;
                box.textContent = emojis[i];
                box.onclick = function() {
                    this.classList.toggle('selected');
                };
                grid.appendChild(box);
            }
            
            captcha.style.display = 'flex';
            captchaAttempts = 0;
        }
        
        function checkFakeCaptcha() {
            const selected = document.querySelectorAll('.fake-captcha-image.selected');
            const message = document.getElementById('fakeCaptchaMessage');
            captchaAttempts++;
            
            // Always fail first 2 attempts, then allow to proceed
            if (captchaAttempts < 3) {
                message.textContent = 'Felaktig verifiering. F√∂rs√∂k igen.';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    document.querySelectorAll('.fake-captcha-image').forEach(box => {
                        box.classList.remove('selected');
                    });
                    message.textContent = '';
                }, 2000);
            } else {
                // After 3 attempts, allow to proceed
                message.textContent = 'Verifiering lyckades!';
                message.style.color = '#4caf50';
                
                setTimeout(() => {
                    document.getElementById('fakeCaptcha').style.display = 'none';
                    message.textContent = '';
                    message.style.color = '#ff6b6b';
                }, 1500);
            }
        }
        
        function startCaptchaInterval() {
            // Only start once, not every time we switch levels
            if (captchaIntervalStarted) {
                return;
            }
            
            captchaIntervalStarted = true;
            
            // Show captcha immediately (first time only, after loading screen)
            setTimeout(() => {
                if (currentLevel > 0 && currentLevel < 6) {
                    showFakeCaptcha();
                }
            }, 2000);
            
            // Then show every 3 minutes (180000 ms)
            captchaInterval = setInterval(() => {
                if (currentLevel > 0 && currentLevel < 6) {
                    showFakeCaptcha();
                }
            }, 180000); // 3 minutes
        }
        
        function stopCaptchaInterval() {
            if (captchaInterval) {
                clearInterval(captchaInterval);
                captchaInterval = null;
            }
            // Don't reset captchaIntervalStarted here - we want it to stay stopped
        }

        // ============================================
        // START GAME
        // ============================================
        init();
    </script>
</body>
</html>


