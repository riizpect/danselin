<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julklapp Escape Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 50%, #0a1a0a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Snowflakes animation */
        .snowflake {
            position: fixed;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            animation: fall linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            user-select: none;
        }

        h2 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff6b6b);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.9em;
        }

        .puzzle-container {
            background: rgba(20, 20, 30, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .puzzle-description {
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 1.1em;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            margin-bottom: 15px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        button {
            padding: 12px 24px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        /* Level 2: Hotspots */
        .hotspot-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .hotspot {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            border: 3px solid rgba(255, 215, 0, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            z-index: 10;
        }

        .hotspot:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        .hotspot.found {
            background: rgba(76, 175, 80, 0.5);
            border-color: #4caf50;
        }

        .hotspot.wrong {
            background: rgba(244, 67, 54, 0.5);
            border-color: #f44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Level 2: Memory Game */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            min-height: 300px;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 80px;
        }

        .memory-card:hover {
            transform: scale(1.05);
            border-color: rgba(255, 215, 0, 0.6);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #3a3a4e, #2a2a3e);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .memory-card.matched {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            cursor: default;
            opacity: 0.7;
        }

        .memory-card .card-back {
            font-size: 1.5em;
            color: rgba(255, 215, 0, 0.5);
        }

        .memory-card .card-front {
            display: none;
        }

        .memory-card.flipped .card-back {
            display: none;
        }

        .memory-card.flipped .card-front {
            display: block;
        }

        /* Level 3: Cipher */
        .cipher-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            letter-spacing: 2px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        /* Level 4: Logic Puzzle */
        .logic-grid {
            display: grid;
            grid-template-columns: 150px 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .logic-header {
            font-weight: bold;
            padding: 10px;
            background: rgba(255, 215, 0, 0.2);
            text-align: center;
            border-radius: 5px;
        }

        .logic-cell {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            text-align: center;
            border-radius: 5px;
        }

        select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            color: #fff;
        }

        /* Level 5: Fish Math Puzzle */
        .fish-math-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 10px;
            margin: 30px auto;
            max-width: 600px;
        }

        .fish-equation {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            border-radius: 5px;
        }

        .fish-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
        }

        .fish-code-input {
            margin: 30px 0;
            text-align: center;
        }

        .fish-code-input input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 5px;
            color: #fff;
        }

        .fish-code-input input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Annoying Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: all;
        }

        .annoying-popup {
            position: fixed;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 20px 30px;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
            z-index: 10000;
            cursor: pointer;
            font-size: 1.1em;
            text-align: center;
            color: #fff;
            min-width: 250px;
            animation: popupPulse 0.5s ease-out;
            user-select: none;
            pointer-events: all;
        }

        .annoying-popup.moving {
            transition: all 0.3s ease-out;
        }

        @keyframes popupPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .annoying-popup button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: #ffd700;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .annoying-popup button:hover {
            background: #ffed4e;
        }

        .annoying-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            z-index: 10001;
        }

        .annoying-popup .close-btn:hover {
            background: rgba(0,0,0,0.5);
        }
        
        /* Make close button sometimes hard to click on moving popups */
        .annoying-popup.moving .close-btn {
            cursor: crosshair;
        }

        /* Hints */
        .hint-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            border-radius: 5px;
            display: none;
        }

        .hint-container.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            display: none;
            max-width: 300px;
        }

        .admin-panel.show {
            display: block;
        }

        .admin-panel h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .admin-panel button {
            width: 100%;
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Final Reveal - R칛kna fiskar */
        .final-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 40px 20px;
        }
        
        /* D칬lj bara "Grattis!"-texten permanent */
        .final-container h1,
        .final-container p.gift-card-subtitle {
            display: none !important;
        }

        .fish-count-container {
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            position: relative;
            z-index: 1;
            min-height: 600px;
        }

        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border: 4px solid #ff0000;
            padding: 40px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: errorPulse 1s ease-in-out infinite;
        }

        .error-overlay.show {
            display: flex;
        }

        @keyframes errorPulse {
            0%, 100% { border-color: #ff0000; }
            50% { border-color: #ff6666; }
        }

        .under-construction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .construction-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        .construction-subtitle {
            font-size: 1.3em;
            color: #fff;
            margin-bottom: 40px;
        }

        .construction-game {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            max-width: 500px;
            width: 100%;
        }

        .construction-instruction {
            color: #ffd700;
            font-size: 1.2em;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .construction-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .construction-btn {
            padding: 20px;
            font-size: 1.5em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .construction-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .construction-btn:active {
            transform: scale(0.95);
        }

        .construction-btn.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
            color: #00ff00;
        }

        .construction-btn.wrong {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
            color: #ff0000;
            animation: shake 0.5s;
        }

        .construction-btn.completed {
            background: rgba(0, 255, 0, 0.5);
            border-color: #00ff00;
            color: #00ff00;
            cursor: default;
        }

        .construction-feedback {
            margin-top: 20px;
            font-size: 1.1em;
            min-height: 30px;
        }

        .construction-feedback.correct {
            color: #00ff00;
        }

        .construction-feedback.wrong {
            color: #ff0000;
        }

        .fish-count-question {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .fish-count-text {
            color: #fff;
            font-size: 2.5em;
            line-height: 1.6;
            margin: 20px 0;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .fish-count-timer {
            color: #ff6b6b;
            font-size: 2.5em;
            font-weight: bold;
            margin: 20px 0;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .fish-arena {
            width: 100%;
            height: 400px;
            background: linear-gradient(180deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .swimming-fish {
            position: absolute;
            font-size: 2.5em;
            user-select: none;
            pointer-events: none;
        }



        @keyframes swim {
            0% {
                transform: translateX(-100px) translateY(0);
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
                opacity: 0;
            }
        }

        @keyframes swimRight {
            0% {
                transform: translateX(-100px) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
                opacity: 0;
            }
        }

        @keyframes swimLeft {
            0% {
                transform: translateX(calc(100vw + 100px)) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-100px) translateY(0);
                opacity: 0;
            }
        }

        @keyframes swimUp {
            0% {
                transform: translateX(0) translateY(calc(100vh + 100px));
                opacity: 1;
            }
            100% {
                transform: translateX(0) translateY(-100px);
                opacity: 0;
            }
        }

        @keyframes swimDown {
            0% {
                transform: translateX(0) translateY(-100px);
                opacity: 1;
            }
            100% {
                transform: translateX(0) translateY(calc(100vh + 100px));
                opacity: 0;
            }
        }

        @keyframes swimDiagonal1 {
            0% {
                transform: translateX(-100px) translateY(calc(100vh + 100px));
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(-100px);
                opacity: 0;
            }
        }

        @keyframes swimDiagonal2 {
            0% {
                transform: translateX(calc(100vw + 100px)) translateY(-100px);
                opacity: 1;
            }
            100% {
                transform: translateX(-100px) translateY(calc(100vh + 100px));
                opacity: 0;
            }
        }

        @keyframes swimDiagonal3 {
            0% {
                transform: translateX(-100px) translateY(-100px);
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 100px)) translateY(calc(100vh + 100px));
                opacity: 0;
            }
        }

        @keyframes swimDiagonal4 {
            0% {
                transform: translateX(calc(100vw + 100px)) translateY(calc(100vh + 100px));
                opacity: 1;
            }
            100% {
                transform: translateX(-100px) translateY(-100px);
                opacity: 0;
            }
        }

        .fish-count-phase {
            color: #ffd700;
            font-size: 1.1em;
            margin: 15px 0;
            font-weight: bold;
        }

        .fish-count-input-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
        }

        .fish-count-input {
            padding: 15px 25px;
            font-size: 1.5em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            text-align: center;
            font-weight: bold;
            width: 150px;
        }

        .fish-count-input:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .fish-count-submit {
            padding: 15px 30px;
            font-size: 1.3em;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .fish-count-submit:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.05);
        }

        .fish-count-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .fish-count-feedback {
            text-align: center;
            margin: 20px 0;
            min-height: 50px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .fish-count-feedback.correct {
            color: #4caf50;
        }

        .fish-count-feedback.wrong {
            color: #ff6b6b;
        }

        .fish-count-feedback.timeout {
            color: #ffaa00;
        }

        .fish-count-round {
            color: #ffd700;
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .gift-box-large-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
            position: relative;
            z-index: 10;
        }

        .gift-box-large-container.show {
            display: flex;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .gift-box-large {
            width: 350px;
            height: 350px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 25%, #ff8c8c 50%, #ff6b6b 75%, #ee5a6f 100%);
            border: 8px solid #ffd700;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8em;
            cursor: pointer;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.8),
                0 0 100px rgba(255, 107, 107, 0.4),
                0 25px 80px rgba(0, 0, 0, 0.6),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.3s ease;
            animation: largeBoxPulse 2s ease-in-out infinite;
            overflow: hidden;
        }

        .gift-box-large::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes largeBoxPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 
                    0 0 60px rgba(255, 215, 0, 0.8),
                    0 0 100px rgba(255, 107, 107, 0.4),
                    0 25px 80px rgba(0, 0, 0, 0.6),
                    inset 0 0 30px rgba(255, 255, 255, 0.2);
            }
            50% { 
                transform: scale(1.08); 
                box-shadow: 
                    0 0 80px rgba(255, 215, 0, 1),
                    0 0 120px rgba(255, 107, 107, 0.6),
                    0 30px 100px rgba(0, 0, 0, 0.7),
                    inset 0 0 40px rgba(255, 255, 255, 0.3);
            }
        }

        .gift-box-large:hover {
            transform: scale(1.1);
        }

        .gift-box-large.opening {
            animation: openBox 1s ease-out forwards;
        }

        @keyframes openBox {
            0% { transform: scale(1) rotateY(0deg); }
            50% { transform: scale(1.2) rotateY(90deg); }
            100% { transform: scale(1) rotateY(0deg); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes errorFlash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .open-instruction {
            margin-top: 20px;
            color: #ffd700;
            font-size: 1.2em;
            text-align: center;
            min-height: 30px;
        }

        .open-package-btn {
            margin-top: 20px;
            padding: 20px 40px;
            font-size: 1.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: #fff;
            border: 4px solid #ffd700;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            animation: buttonPulse 2s ease-in-out infinite;
        }

        .open-package-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(255, 215, 0, 1);
            background: linear-gradient(135deg, #ff8c8c, #ff6b6b);
        }

        .open-package-btn:active {
            transform: scale(0.95);
        }

        @keyframes buttonPulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            }
            50% { 
                box-shadow: 0 0 50px rgba(255, 215, 0, 1);
            }
        }

        /* F칛rgsekvens-spel */
        .color-sequence-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            display: none;
        }

        .color-sequence-container.active {
            display: block;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
            position: relative;
        }

        .color-button {
            aspect-ratio: 1;
            border: 5px solid #fff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 
                        0 0 0 0 rgba(255, 255, 255, 0.5);
        }

        .color-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .color-button:active {
            transform: scale(0.95);
        }

        .color-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .color-button.flash {
            animation: colorFlash 0.6s ease-out;
            z-index: 10;
        }

        .color-button.pressed {
            transform: scale(0.9);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.6);
        }

        .color-button.moving {
            animation: colorMove 3s ease-in-out infinite;
        }

        .color-button.distraction {
            animation: distractionBlink 0.2s;
            opacity: 0.7;
        }

        @keyframes colorFlash {
            0% { 
                transform: scale(1);
                filter: brightness(1) saturate(1);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            }
            20% {
                transform: scale(1.3);
                filter: brightness(2.5) saturate(2);
                box-shadow: 0 0 60px rgba(255, 255, 255, 1),
                            0 0 100px currentColor,
                            0 0 150px currentColor,
                            inset 0 0 40px rgba(255, 255, 255, 0.8);
            }
            50% {
                transform: scale(1.25);
                filter: brightness(2.2) saturate(1.8);
                box-shadow: 0 0 50px rgba(255, 255, 255, 1),
                            0 0 90px currentColor,
                            0 0 140px currentColor,
                            inset 0 0 35px rgba(255, 255, 255, 0.7);
            }
            80% {
                transform: scale(1.2);
                filter: brightness(1.5) saturate(1.3);
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.8),
                            0 0 70px currentColor;
            }
            100% { 
                transform: scale(1);
                filter: brightness(1) saturate(1);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            }
        }

        @keyframes colorMove {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(10px, -5px) rotate(2deg);
            }
            50% {
                transform: translate(-8px, 8px) rotate(-2deg);
            }
            75% {
                transform: translate(5px, 5px) rotate(1deg);
            }
        }

        @keyframes distractionBlink {
            0%, 100% {
                filter: brightness(0.6) saturate(0.5) hue-rotate(180deg);
                transform: scale(0.95);
                opacity: 0.6;
            }
            50% {
                filter: brightness(0.8) saturate(0.7) hue-rotate(180deg);
                transform: scale(0.98);
                opacity: 0.7;
            }
            50% {
                filter: brightness(2) saturate(1.8);
                transform: scale(1.1);
            }
            75% {
                filter: brightness(1.5) saturate(1.3);
                transform: scale(1.05);
            }
        }

        /* STARKARE, KLARARE F츿RGER */
        .color-red { 
            background: linear-gradient(135deg, #ff0000, #cc0000);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }
        .color-blue { 
            background: linear-gradient(135deg, #0066ff, #0044cc);
            box-shadow: 0 6px 20px rgba(0, 102, 255, 0.5);
        }
        .color-yellow { 
            background: linear-gradient(135deg, #ffdd00, #ffaa00);
            box-shadow: 0 6px 20px rgba(255, 221, 0, 0.5);
        }
        .color-green { 
            background: linear-gradient(135deg, #00ff00, #00cc00);
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.5);
        }

        .sequence-instruction {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 15px 0;
            min-height: 50px;
        }

        .sequence-level {
            text-align: center;
            color: #fff;
            font-size: 1.1em;
            margin: 10px 0;
        }

        /* Presentkort (visas efter 칬ppning) */
        .gift-card-container {
            display: none;
            width: 100%;
            max-width: 600px;
        }

        .gift-card-container.show {
            display: block;
            animation: cardReveal 1.5s ease-out;
        }

        .gift-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 50px 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.4), 
                        0 20px 60px rgba(0, 0, 0, 0.5),
                        inset 0 0 30px rgba(255, 215, 0, 0.1);
            position: relative;
            animation: cardReveal 1.5s ease-out;
            text-align: center;
        }

        @keyframes cardReveal {
            from {
                opacity: 0;
                transform: scale(0.8) rotateY(-10deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        .gift-card::before {
            content: '游꾸';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4em;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .gift-card-header {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .gift-card-title {
            font-size: 2.8em;
            color: #ffd700;
            margin: 0 0 10px 0;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8),
                         2px 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            letter-spacing: 2px;
        }

        .gift-card-subtitle {
            font-size: 1.3em;
            color: #fff;
            margin: 10px 0 30px 0;
            opacity: 0.9;
        }

        .gift-card-content {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
        }

        .gift-info-row {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .gift-info-icon {
            font-size: 2em;
            margin-right: 20px;
            min-width: 50px;
            text-align: center;
        }

        .gift-info-text {
            flex: 1;
            color: #fff;
            font-size: 1.2em;
            line-height: 1.6;
        }

        .gift-info-label {
            color: #ffd700;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .gift-card-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 215, 0, 0.3);
        }

        .gift-message {
            font-size: 1.8em;
            color: #ffd700;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .gift-card {
                padding: 30px 20px;
            }

            .gift-card-title {
                font-size: 2em;
            }

            .gift-info-row {
                flex-direction: column;
                text-align: center;
            }

            .gift-info-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .gift-info-text {
                text-align: center;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.4em;
            }

            .puzzle-container {
                padding: 20px;
            }

            .hotspot-container {
                height: 300px;
            }

            .hotspot {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .logic-grid {
                grid-template-columns: 100px 1fr 1fr;
                font-size: 0.9em;
                gap: 10px;
            }

            .memory-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .memory-card {
                font-size: 2em;
                min-height: 60px;
            }

            .timing-btn {
                width: 60px;
                height: 60px;
                font-size: 1.2em;
            }

            .admin-panel {
                max-width: 90%;
                right: 5%;
                left: 5%;
            }
        }

        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
            color: #f44336;
        }

        /* Fake Loading Screen */
        .fake-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        
        .fake-loading-screen.show {
            display: flex;
        }

        .fake-loading-bar-container {
            width: 300px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .fake-loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .fake-loading-bar.going-wrong {
            animation: loadingWrong 2s infinite;
        }

        @keyframes loadingWrong {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px); }
            100% { transform: translateX(0); }
        }

        /* Fake Captcha */
        .fake-captcha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 25000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fake-captcha-box {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            max-width: 500px;
            text-align: center;
            color: #fff;
        }

        .fake-captcha-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .fake-captcha-image {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            transition: all 0.3s;
        }

        .fake-captcha-image:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .fake-captcha-image.selected {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.3);
        }

        /* Fake Countdown */
        .fake-countdown {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 107, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #ffd700;
            z-index: 5000;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        /* Fake Saving Message */
        .fake-saving-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #4caf50;
            z-index: 5000;
            color: #fff;
            display: none;
        }

        .fake-saving-message.show {
            display: block;
            animation: savingPulse 2s infinite;
        }

        @keyframes savingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <!-- Snowflakes -->
    <div id="snowflakes"></div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar" ondblclick="showSecretInput()" title="Dubbelklicka f칬r test-l칛ge">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <!-- Secret Test Input (hidden) -->
        <div id="secretInput" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 30px; border: 3px solid #ffd700; border-radius: 15px; z-index: 2000; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="color: #ffd700; margin-bottom: 20px; font-size: 1.5em; text-align: center;">游댢 Test-l칛ge 游댢</h3>
            <div style="margin-bottom: 20px;">
                <input type="text" id="secretCodeInput" placeholder="Ange kod..." style="width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.5); border: 2px solid #ffd700; border-radius: 8px; color: #fff; font-size: 1em; box-sizing: border-box;">
                <button onclick="checkSecretCode()" style="width: 100%; padding: 12px; background: #ffd700; color: #000; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; margin-bottom: 10px;">Verifiera kod</button>
            </div>
            <div id="levelSelection" style="display: none;">
                <h4 style="color: #ffd700; margin-bottom: 15px; font-size: 1.2em;">V칛lj niv친 att hoppa till:</h4>
                <div style="display: grid; gap: 10px;">
                    <button onclick="goToLevel(0)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 0: Start</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Startsidan</span>
                    </button>
                    <button onclick="goToLevel(1)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 1: Ordg친ta</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Gissa ordet med ledtr친dar</span>
                    </button>
                    <button onclick="goToLevel(2)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 2: Memory</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Hitta alla par i memory-spelet</span>
                    </button>
                    <button onclick="goToLevel(3)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 3: Avkodning</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Dekryptera texten (ROT16)</span>
                    </button>
                    <button onclick="goToLevel(4)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 4: Fiskelogik</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Matcha fiskare med fisk och metod</span>
                    </button>
                    <button onclick="goToLevel(5)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 5: Fiskmatematik</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">L칬s ekvationer f칬r att hitta siffror</span>
                    </button>
                    <button onclick="goToLevel(6)" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Niv친 6: Final</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">R칛kna fiskar och 칬ppna paketet</span>
                    </button>
                    <button onclick="goToSimonSays()" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Simon Says (F칛rgsekvens)</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">F칬lj f칛rgsekvensen - 7 niv친er</span>
                    </button>
                    <button onclick="goToSimonSaysLevel7()" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ff00ff; border-radius: 8px; color: #ff00ff; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Simon Says - Niv친 7 (Sista niv친n)</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Starta direkt p친 sista niv친n</span>
                    </button>
                    <button onclick="simulateSimonSaysComplete()" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #00ff00; border-radius: 8px; color: #00ff00; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Simulera Simon Says klar</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">G친 direkt till "Vill du b칬rja om?"</span>
                    </button>
                    <button onclick="goToGiftCard()" style="padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; cursor: pointer; text-align: left; font-size: 1em;">
                        <strong>Presentkort</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">Visa presentkortet med information</span>
                    </button>
                </div>
            </div>
            <button onclick="hideSecretInput()" style="width: 100%; margin-top: 15px; padding: 12px; background: #666; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">St칛ng</button>
        </div>

        <!-- View 0: Start -->
        <div class="view active" id="view0">
            <h1 id="title">游꾻 Julklapp Escape Room 游꾻</h1>
            <div class="puzzle-container">
                <p class="puzzle-description" style="text-align: center; font-size: 1.3em;">
                    V칛lkommen! Du har 5 utmaningar att l칬sa f칬r att l친sa upp din julklapp.<br>
                    Varje niv친 blir lite sv친rare, men allt 칛r r칛ttvist.<br>
                    Anv칛nd ledtr친dar om du fastnar!
                </p>
                <button onclick="startGame()" style="display: block; margin: 30px auto;">Starta 칛ventyret</button>
            </div>
        </div>
        
        <!-- Fake Loading Screen -->
        <div id="fakeLoadingScreen" class="fake-loading-screen">
            <h2>Laddar...</h2>
            <div class="fake-loading-bar-container">
                <div class="fake-loading-bar" id="fakeLoadingBar"></div>
            </div>
            <p id="fakeLoadingText">Initierar system...</p>
            <button id="fakeLoadingButton" onclick="skipFakeLoading()" style="display: none; margin-top: 20px;">Forts칛tt</button>
        </div>
        
        <!-- Fake Captcha -->
        <div id="fakeCaptcha" class="fake-captcha-overlay" style="display: none;">
            <div class="fake-captcha-box">
                <h3>Verifiera att du 칛r m칛nniska</h3>
                <p>V칛lj alla bilder med trafikljus:</p>
                <div class="fake-captcha-grid" id="fakeCaptchaGrid">
                    <!-- Images will be added by JavaScript -->
                </div>
                <p id="fakeCaptchaMessage" style="color: #ff6b6b; margin-top: 10px;"></p>
                <button onclick="checkFakeCaptcha()" style="margin-top: 15px;">Verifiera</button>
            </div>
        </div>

        <!-- View 1: Level 1 - Word Puzzle -->
        <div class="view" id="view1">
            <h2>Niv친 1: Ordg친ta</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    <strong>Ledtr친d:</strong> Vem 칛r den svenska f칬rfattaren som skrev boken "Nils Holgerssons underbara resa genom Sverige" 
                    och som var den f칬rsta kvinnan att f친 Nobelpriset i litteratur?<br>
                    <em>(Svara med efternamnet, sm친 bokst칛ver, svenska tecken 칛r ok)</em>
                </p>
                <input type="text" id="wordInput" placeholder="Skriv svaret h칛r..." onkeypress="if(event.key==='Enter') checkWord()">
                <button onclick="checkWord()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(1)">Ledtr친d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B칬rja om fr친n b칬rjan</button>
                <div class="hint-container" id="hint1"></div>
                <div id="message1"></div>
            </div>
        </div>

        <!-- View 2: Level 2 - Memory Game -->
        <div class="view" id="view2">
            <h2>Niv친 2: Memory</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Hitta alla par! V칛nd upp tv친 kort i taget och matcha dem. N칛r alla par 칛r hittade f친r du en kod.
                </p>
                <div class="memory-grid" id="memoryGrid"></div>
                <div style="margin-top: 20px;">
                    <strong>Hittade par:</strong> <span id="pairsFound">0</span> / <span id="totalPairs">0</span>
                </div>
                <button class="btn-secondary" onclick="showHint(2)">Ledtr친d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B칬rja om fr친n b칬rjan</button>
                <div class="hint-container" id="hint2"></div>
                <div id="message2"></div>
            </div>
        </div>

        <!-- View 3: Level 3 - Cipher -->
        <div class="view" id="view3">
            <h2>Niv친 3: Avkodning</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Nedan finns ett krypterat ord. Avkoda det med ROT16 (Caesar-chiffer med skift 16).
                    <br><br>
                    Svaret blir ditt l칬senord (ett ord relaterat till fiske).
                </p>
                <div class="cipher-text" id="cipherText"></div>
                <input type="text" id="cipherInput" placeholder="Skriv det avkodade l칬senordet h칛r..." onkeypress="if(event.key==='Enter') checkCipher()">
                <button onclick="checkCipher()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(3)">Ledtr친d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B칬rja om fr친n b칬rjan</button>
                <div class="hint-container" id="hint3"></div>
                <div id="message3"></div>
            </div>
        </div>

        <!-- View 4: Level 4 - Logic Puzzle -->
        <div class="view" id="view4">
            <h2>Niv친 4: Fiskelogik</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Fyra fiskare f친ngar fyra olika fisketyper med fyra olika metoder. Matcha r칛tt fiskare med r칛tt fisk och metod baserat p친 ledtr친darna:
                    <br><br>
                    <strong>Ledtr친dar:</strong><br>
                    1. Erik fiskar inte abborre eller g칛dda.<br>
                    2. Lisa anv칛nder inte flugfiske eller grundfiske.<br>
                    3. Olle fiskar inte lax eller ruda.<br>
                    4. Sara anv칛nder inte spinnfiske eller flugfiske.<br>
                    5. Den som fiskar lax anv칛nder inte grundfiske.<br>
                    6. Den som fiskar abborre anv칛nder inte isfiske.<br>
                    7. Den som fiskar g칛dda anv칛nder inte flugfiske.<br>
                    8. Den som fiskar ruda anv칛nder inte spinnfiske.<br>
                    9. Den som anv칛nder flugfiske fiskar inte abborre eller g칛dda.<br>
                    10. Den som anv칛nder spinnfiske fiskar inte lax eller ruda.<br>
                    11. Den som anv칛nder grundfiske fiskar inte lax eller abborre.<br>
                    12. Den som anv칛nder isfiske fiskar inte g칛dda eller abborre.<br>
                    13. Exakt en av (Erik, Olle) fiskar lax eller ruda.<br>
                    14. Exakt en av (Lisa, Sara) anv칛nder grundfiske eller isfiske.<br>
                    15. Erik anv칛nder antingen flugfiske eller spinnfiske.<br>
                    16. Olle anv칛nder antingen grundfiske eller isfiske.<br>
                    17. Den som anv칛nder flugfiske fiskar inte ruda.<br>
                </p>
                <div class="logic-grid" id="logicGrid"></div>
                <button onclick="checkLogic()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(4)">Ledtr친d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B칬rja om fr친n b칬rjan</button>
                <div class="hint-container" id="hint4"></div>
                <div id="message4"></div>
            </div>
        </div>

        <!-- View 5: Level 5 - Fish Math Puzzle -->
        <div class="view" id="view5">
            <h2>Niv친 5: Fiskmatematik</h2>
            <div class="puzzle-container">
                <p class="puzzle-description">
                    Varje fisk representerar en siffra (0-9). L칬s ekvationerna nedan f칬r att ta reda p친 vilken siffra varje fisk representerar.
                    N칛r du vet alla siffror, ange koden i r칛tt ordning.
                </p>
                <div class="fish-math-container" id="fishMathContainer">
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> + <span class="fish-name">Abborre</span> = 12
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">G칛dda</span> - <span class="fish-name">Ruda</span> = 3
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> 칑 2 = <span class="fish-name">G칛dda</span>
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Abborre</span> + <span class="fish-name">Ruda</span> = 15
                    </div>
                    <div class="fish-equation">
                        <span class="fish-name">Lax</span> + <span class="fish-name">G칛dda</span> = 18
                    </div>
                </div>
                <div class="fish-code-input">
                    <p><strong>Koden 칛r summan av alla fyra fiskar:</strong></p>
                    <input type="text" id="fishCodeInput" placeholder="Ange 4-siffrig kod" maxlength="4" style="font-size: 1.5em; padding: 10px; text-align: center; width: 200px;">
                </div>
                <button onclick="checkFishMath()">Kontrollera</button>
                <button class="btn-secondary" onclick="showHint(5)">Ledtr친d</button>
                <button onclick="restartGame()" style="background: #666; margin-top: 10px;">B칬rja om fr친n b칬rjan</button>
                <div class="hint-container" id="hint5"></div>
                <div id="message5"></div>
            </div>
        </div>

        <!-- View 6: Final -->
        <div class="view" id="view6">
            <div class="final-container">
                <h1 class="gift-card-title" style="margin-bottom: 20px; display: none !important;">游꿀 Grattis! 游꿀</h1>
                <p class="gift-card-subtitle" style="margin-bottom: 30px; display: none !important;">Du har l칬st alla utmaningar! Nu ska du lista ut vad som ligger i paketen!</p>
                
                <!-- R칛kna fiskar (buggigt) -->
                <div class="fish-count-container" id="fishCountContainer"></div>
                
                <!-- Error overlay (fullsk칛rm) -->
                <div class="error-overlay" id="errorOverlay">
                    <div class="construction-title" style="color: #ff0000; font-size: 3em; margin-bottom: 20px;">
                        丘멆잺 UNDER UPPBYGGNAD 丘멆잺
                    </div>
                    <div class="construction-subtitle" style="color: #ff6666; font-size: 2em; margin-bottom: 30px;">
                        ERROR. FEL.
                    </div>
                    
                    <div class="construction-game">
                        <div class="construction-instruction" id="errorInstruction">
                            Klicka p친 knapparna i r칛tt ordning: 1  2  3  4
                        </div>
                        <div class="construction-buttons-grid" id="errorButtons">
                            <!-- Knappar skapas dynamiskt -->
                        </div>
                        <div class="construction-feedback" id="errorFeedback"></div>
                    </div>
                </div>
                
                <!-- Stort paket (visas n칛r r칛tt paket hittats) -->
                <div class="gift-box-large-container" id="giftBoxLargeContainer">
                    <div class="gift-box-large" id="giftBoxLarge">游꾸</div>
                    <div class="open-instruction" id="openInstruction">Klicka p친 knappen f칬r att 칬ppna paketet!</div>
                    <button class="open-package-btn" id="openPackageBtn" onclick="handleOpenPackage()">칐ppna Paketet 游꾸</button>
                    
                    <!-- F칛rgsekvens-spel (visas efter dubbelklick) -->
                    <div class="color-sequence-container" id="colorSequenceContainer">
                        <div class="sequence-level" id="sequenceLevel">Niv친 1</div>
                        <div class="sequence-instruction" id="sequenceInstruction">Titta noga p친 sekvensen!</div>
                        <div class="color-grid">
                            <div class="color-button color-red" id="colorRed" data-color="red"></div>
                            <div class="color-button color-blue" id="colorBlue" data-color="blue"></div>
                            <div class="color-button color-yellow" id="colorYellow" data-color="yellow"></div>
                            <div class="color-button color-green" id="colorGreen" data-color="green"></div>
                        </div>
                        <button class="continue-button" id="continueButton" onclick="handleContinueAfterSequence()" style="display: none; margin-top: 20px; padding: 15px 30px; font-size: 1.2em; background: linear-gradient(135deg, #4caf50, #45a049); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); transition: all 0.3s ease;">Forts칛tt </button>
                    </div>
                </div>
                
                <!-- Presentkort (visas efter 칬ppning) -->
                <div class="gift-card-container" id="giftCardContainer">
                    <div class="gift-card">
                        <div class="gift-card-header">
                            <h1 class="gift-card-title">游꿀 Grattis! 游꿀</h1>
                            <p class="gift-card-subtitle">Du har l칬st alla utmaningar!</p>
                        </div>
                        
                        <div class="gift-card-content">
                            <div class="gift-info-row">
                                <div class="gift-info-icon">游꿖</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Present</span>
                                    Flugbindning f칬r nyb칬rjare
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">游늰</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Datum</span>
                                    20 januari 2026
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">游뎷</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Tid</span>
                                    18:00 - 20:30
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">游늸</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Plats</span>
                                    Residensgatan 7, V칛nersborg
                                </div>
                            </div>
                            
                            <div class="gift-info-row">
                                <div class="gift-info-icon">九</div>
                                <div class="gift-info-text">
                                    <span class="gift-info-label">Antal tillf칛llen</span>
                                    10 tillf칛llen
                                </div>
                            </div>
                        </div>
                        
                        <div class="gift-card-footer">
                            <div class="gift-message">God Jul Dan! 仇벒잺</div>
                            <p style="color: #fff; margin-top: 15px; opacity: 0.8;">Fr친n Tomten</p>
                        </div>
                    </div>
                </div>
                
                <!-- "Vill du b칬rja om?" fr친ga -->
                <div class="restart-question-container" id="restartQuestionContainer" style="display: none; text-align: center; padding: 50px 20px; margin-top: 40px;">
                    <h1 style="color: #ffd700; font-size: 2.5em; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Vill du b칬rja om?</h1>
                    <button id="restartQuestionButton" onclick="handleRestartQuestionClick()" style="padding: 20px 50px; font-size: 1.5em; background: linear-gradient(135deg, #4caf50, #45a049); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 20px rgba(76, 175, 80, 0.5); transition: all 0.3s ease;">Ja</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <h3>游댢 Admin Panel</h3>
        <button onclick="goToLevel(0)">Start</button>
        <button onclick="goToLevel(1)">Niv친 1</button>
        <button onclick="goToLevel(2)">Niv친 2</button>
        <button onclick="goToLevel(3)">Niv친 3</button>
        <button onclick="goToLevel(4)">Niv친 4</button>
        <button onclick="goToLevel(5)">Niv친 5</button>
        <button onclick="goToLevel(6)">Final</button>
        <button onclick="resetProgress()" class="btn-secondary">Nollst칛ll Progress</button>
        <button onclick="showAnswers()" class="btn-secondary">Visa Facit</button>
        <button onclick="toggleAdmin()" style="background: #666;">St칛ng</button>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Alla svar och konstanter
        // ============================================
        const CONFIG = {
            // Level 1: Word Puzzle
            wordAnswer: "lagerl칬f",
            
            // Level 2: Memory Game
            memoryPairs: ["游꾻", "游꾼", "救", "游꾸", "游붋", "游댒"], // 6 par = 12 kort
            memoryCode: "2468", // Kod n칛r alla par 칛r hittade
            
            // Level 3: Cipher
            cipherText: "Syetvscxnbr친", // "Flugfiskaren" in ROT16 med svenska alfabetet (A-Z, 칀, 츿, 칐)
            cipherAnswer: "flugfiskaren",
            
            // Level 4: Logic Puzzle - Fishing
            // Correct mapping: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G칛dda+Grundfiske, Sara=Ruda+Isfiske
            logicAnswer: {
                erik: { fish: "lax", method: "flugfiske" },
                lisa: { fish: "abborre", method: "spinnfiske" },
                olle: { fish: "g칛dda", method: "grundfiske" },
                sara: { fish: "ruda", method: "isfiske" }
            },
            logicCode: "2468", // Will be generated from correct answers
            
            // Level 5: Fish Math Puzzle
            // Lax = 6, Abborre = 6, G칛dda = 12, Ruda = 9
            // Summa: 6 + 6 + 12 + 9 = 33
            fishMathAnswer: "33"
        };

        // ============================================
        // GAME STATE
        // ============================================
        let currentLevel = 0;
        let titleClickCount = 0;
        let adminMode = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Check if first visit
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                // Show fake loading screen
                showFakeLoadingScreen();
                localStorage.setItem('hasVisited', 'true');
                return;
            }
            
            // Load progress from localStorage
            const savedLevel = localStorage.getItem('escapeRoomLevel');
            if (savedLevel) {
                currentLevel = parseInt(savedLevel);
            }
            
            // Setup title click for admin
            document.getElementById('title').addEventListener('click', handleTitleClick);
            
            // Initialize views
            showView(currentLevel);
            updateProgress();
            
            // Initialize level-specific features
            if (currentLevel === 2) initMemoryGame();
            if (currentLevel === 4) initLogicPuzzle();
            if (currentLevel === 5) initFishMath();
            if (currentLevel === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            
            // Create snowflakes
            createSnowflakes();
            
            // Start background music
            startBackgroundMusic();
            
            // Setup click sounds
            setupClickSounds();
            
            // Start fake countdown
            startFakeCountdown();
            
            // Random fake saving messages
            startFakeSavingMessages();
        }

        // ============================================
        // PROGRESS & NAVIGATION
        // ============================================
        function updateProgress() {
            const progress = (currentLevel / 6) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = Math.round(progress) + '%';
        }

        function showView(level) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show current view
            const view = document.getElementById('view' + level);
            if (view) {
                view.classList.add('active');
            }
            
            currentLevel = level;
            localStorage.setItem('escapeRoomLevel', level);
            updateProgress();
            
            // Stop popups on final view
            if (level === 6) {
                stopAnnoyingPopups();
                // Initiera fiskr칛kningsspelet bara om vi inte kommer fr친n simulateSimonSaysComplete
                // (detta hanteras i handleContinueAfterSequence ist칛llet)
                if (!window.skipFishCountInit) {
                    setTimeout(() => initFishCountTest(), 100);
                }
                window.skipFishCountInit = false; // Reset flag
            } else if (level > 0 && !popupInterval) {
                // Start popups if game is active
                startAnnoyingPopups();
            }
            
            // Initialize level-specific features when switching views
            if (level === 2) {
                setTimeout(() => initMemoryGame(), 100); // Small delay to ensure DOM is ready
            } else {
                // Stop memory swapping if leaving level 2
                stopMemoryCardSwapping();
            }
            
            if (level === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            } else if (level === 4) {
                setTimeout(() => initLogicPuzzle(), 100);
            } else if (level === 5) {
                setTimeout(() => initFishMath(), 100);
            }
            
            // Setup troll features for this level
            setTimeout(() => {
                setupTrollFeatures(level);
            }, 500);
            
            // Start captcha interval only if we're entering a game level for the first time
            // (it will continue running even when switching between levels)
            if (level > 0 && level < 6) {
                if (!captchaIntervalStarted) {
                    startCaptchaInterval();
                }
            } else {
                stopCaptchaInterval();
                captchaIntervalStarted = false; // Reset so it can start again if needed
            }
        }
        
        function setupTrollFeatures(level) {
            if (level === 0 || level === 6) return;
            
            // 20% chance to show "You've already completed this level" message
            if (Math.random() < 0.2) {
                setTimeout(() => {
                    const msg = showMessage('message' + level, 'Du har redan klarat denna niv친!', 'success');
                    setTimeout(() => {
                        showMessage('message' + level, '', '');
                    }, 2000);
                }, 1000);
            }
            
            // Setup moving buttons (especially "Kontrollera" buttons)
            setupMovingButtons(level);
            
            // Setup button swapping
            setupButtonSwapping(level);
            
            // Setup fake hint button
            setupFakeHintButton(level);
            
            // Setup fake level complete (only once per level)
            if (!fakeLevelCompleteShown[level] && Math.random() < 0.3) {
                setTimeout(() => {
                    showFakeLevelComplete(level);
                    fakeLevelCompleteShown[level] = true;
                }, 3000 + Math.random() * 5000);
            }
        }
        
        function setupMovingButtons(level) {
            const checkButtons = document.querySelectorAll(`#view${level} button[onclick*="check"]`);
            checkButtons.forEach(btn => {
                let moveCount = 0;
                const moveInterval = setInterval(() => {
                    if (moveCount > 5) {
                        clearInterval(moveInterval);
                        return;
                    }
                    moveCount++;
                    
                    // Move button slightly when user hovers
                    btn.addEventListener('mouseenter', function() {
                        if (Math.random() < 0.4) { // 40% chance
                            const rect = btn.getBoundingClientRect();
                            const newX = rect.left + (Math.random() - 0.5) * 100;
                            const newY = rect.top + (Math.random() - 0.5) * 50;
                            btn.style.position = 'relative';
                            btn.style.left = (newX - rect.left) + 'px';
                            btn.style.top = (newY - rect.top) + 'px';
                            btn.style.transition = 'all 0.1s';
                            
                            setTimeout(() => {
                                btn.style.left = '0';
                                btn.style.top = '0';
                            }, 200);
                        }
                    }, { once: true });
                }, 2000);
            });
        }
        
        function setupButtonSwapping(level) {
            const view = document.getElementById('view' + level);
            if (!view) return;
            
            const buttons = Array.from(view.querySelectorAll('button'));
            const hintBtn = buttons.find(b => b.textContent.includes('Ledtr친d'));
            const checkBtn = buttons.find(b => b.textContent.includes('Kontrollera'));
            
            if (hintBtn && checkBtn && Math.random() < 0.15) { // 15% chance
                // Swap their positions
                const hintParent = hintBtn.parentNode;
                const checkParent = checkBtn.parentNode;
                
                if (hintParent === checkParent) {
                    // Same parent, swap order
                    const temp = hintBtn.nextSibling;
                    hintBtn.parentNode.insertBefore(checkBtn, hintBtn);
                    if (temp) {
                        checkBtn.parentNode.insertBefore(hintBtn, temp);
                    } else {
                        checkBtn.parentNode.appendChild(hintBtn);
                    }
                }
            }
        }
        
        function setupFakeHintButton(level) {
            const view = document.getElementById('view' + level);
            if (!view) return;
            
            const realHintBtn = view.querySelector('button[onclick*="showHint"]');
            if (!realHintBtn) return;
            
            // Create fake hint button
            const fakeBtn = document.createElement('button');
            fakeBtn.className = 'btn-secondary';
            fakeBtn.textContent = 'Ledtr친d';
            fakeBtn.style.marginLeft = '10px';
            fakeBtn.onclick = () => showFakeHint(level);
            
            // Insert after real hint button
            realHintBtn.parentNode.insertBefore(fakeBtn, realHintBtn.nextSibling);
        }
        
        function showFakeLevelComplete(level) {
            if (level === 0 || level === 6) return;
            
            const msgDiv = document.getElementById('message' + level);
            if (!msgDiv) return;
            
            msgDiv.textContent = '游꿀 Niv친 klar! 游꿀';
            msgDiv.className = 'message success';
            
            setTimeout(() => {
                msgDiv.textContent = 'Bara skojade! Forts칛tt spela! 游땏';
                msgDiv.className = 'message error';
                
                setTimeout(() => {
                    msgDiv.textContent = '';
                    msgDiv.className = 'message';
                }, 2000);
            }, 1000);
        }

        function startGame() {
            showView(1);
            startAnnoyingPopups();
        }

        // ============================================
        // LEVEL 1: WORD PUZZLE
        // ============================================
        function checkWord() {
            const input = document.getElementById('wordInput').value.toLowerCase().trim();
            const normalized = normalizeSwedish(input);
            const answer = normalizeSwedish(CONFIG.wordAnswer);
            
            if (normalized === answer) {
                showMessage('message1', 'Korrekt! Du kan g친 vidare.', 'success');
                setTimeout(() => showView(2), 1500);
            } else {
                showMessage('message1', 'Fel svar. F칬rs칬k igen!', 'error');
            }
        }

        function normalizeSwedish(str) {
            return str.toLowerCase()
                .replace(/친/g, 'a')
                .replace(/칛/g, 'a')
                .replace(/칬/g, 'o')
                .trim();
        }

        // ============================================
        // LEVEL 2: MEMORY GAME
        // ============================================
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let canFlip = true;
        let memorySwapInterval = null;

        function initMemoryGame() {
            const grid = document.getElementById('memoryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            memoryCards = [];
            flippedCards = [];
            matchedPairs = 0;
            canFlip = true;
            
            // Create pairs of cards
            const cards = [];
            CONFIG.memoryPairs.forEach((emoji, index) => {
                cards.push({ emoji, id: index });
                cards.push({ emoji, id: index }); // Add pair
            });
            
            // Shuffle cards
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            // Create card elements
            cards.forEach((card, index) => {
                const cardElem = document.createElement('div');
                cardElem.className = 'memory-card';
                cardElem.dataset.cardId = card.id;
                cardElem.dataset.index = index;
                
                const back = document.createElement('div');
                back.className = 'card-back';
                back.textContent = '?';
                
                const front = document.createElement('div');
                front.className = 'card-front';
                front.textContent = card.emoji;
                
                cardElem.appendChild(back);
                cardElem.appendChild(front);
                cardElem.onclick = () => handleMemoryClick(cardElem);
                
                grid.appendChild(cardElem);
                memoryCards.push(cardElem);
            });
            
            // Update total pairs display
            document.getElementById('totalPairs').textContent = CONFIG.memoryPairs.length;
            document.getElementById('pairsFound').textContent = '0';
            
            // Start swapping cards every 10 seconds
            startMemoryCardSwapping();
        }
        
        function startMemoryCardSwapping() {
            // Clear any existing interval
            if (memorySwapInterval) {
                clearInterval(memorySwapInterval);
            }
            
            // Swap two unmatched cards every 3 seconds (make it really hard!)
            memorySwapInterval = setInterval(() => {
                swapTwoUnmatchedCards();
            }, 3000); // 3 seconds - very challenging!
        }
        
        function stopMemoryCardSwapping() {
            if (memorySwapInterval) {
                clearInterval(memorySwapInterval);
                memorySwapInterval = null;
            }
        }
        
        function swapTwoUnmatchedCards() {
            // Get all unmatched cards (not matched, not currently flipped)
            const unmatchedCards = Array.from(memoryCards).filter(card => {
                return !card.classList.contains('matched') && 
                       !card.classList.contains('flipped');
            });
            
            // Need at least 2 cards to swap
            if (unmatchedCards.length < 2) {
                return;
            }
            
            // Pick two random unmatched cards
            const index1 = Math.floor(Math.random() * unmatchedCards.length);
            let index2 = Math.floor(Math.random() * unmatchedCards.length);
            while (index2 === index1) {
                index2 = Math.floor(Math.random() * unmatchedCards.length);
            }
            
            const card1 = unmatchedCards[index1];
            const card2 = unmatchedCards[index2];
            
            // Get their positions
            const rect1 = card1.getBoundingClientRect();
            const rect2 = card2.getBoundingClientRect();
            
            // Calculate the distance and direction
            const deltaX = rect2.left - rect1.left;
            const deltaY = rect2.top - rect1.top;
            
            // Temporarily disable pointer events during animation
            card1.style.pointerEvents = 'none';
            card2.style.pointerEvents = 'none';
            
            // Add transition for smooth animation
            card1.style.transition = 'transform 1.5s ease-in-out';
            card2.style.transition = 'transform 1.5s ease-in-out';
            
            // Move cards to swap positions
            card1.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            card2.style.transform = `translate(${-deltaX}px, ${-deltaY}px)`;
            
            // After animation completes, swap them in DOM and reset
            setTimeout(() => {
                // Swap the cards in the DOM
                const parent = card1.parentNode;
                const next1 = card1.nextSibling;
                const next2 = card2.nextSibling;
                
                if (next1 === card2) {
                    // card1 is right before card2
                    parent.insertBefore(card2, card1);
                } else if (next2 === card1) {
                    // card2 is right before card1
                    parent.insertBefore(card1, card2);
                } else {
                    // They're not adjacent
                    parent.insertBefore(card1, next2);
                    parent.insertBefore(card2, next1);
                }
                
                // Reset transforms and transitions
                card1.style.transform = '';
                card2.style.transform = '';
                card1.style.transition = '';
                card2.style.transition = '';
                
                // Re-enable pointer events
                setTimeout(() => {
                    card1.style.pointerEvents = '';
                    card2.style.pointerEvents = '';
                }, 100);
            }, 1500); // Wait for animation to complete
        }

        function handleMemoryClick(card) {
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            card.classList.add('flipped');
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                canFlip = false;
                const [card1, card2] = flippedCards;
                
                if (card1.dataset.cardId === card2.dataset.cardId) {
                    // Match!
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        matchedPairs++;
                        document.getElementById('pairsFound').textContent = matchedPairs;
                        
                        flippedCards = [];
                        canFlip = true;
                        
                        if (matchedPairs === CONFIG.memoryPairs.length) {
                            stopMemoryCardSwapping();
                            showMessage('message2', `Korrekt! Koden 칛r: ${CONFIG.memoryCode}`, 'success');
                            setTimeout(() => showView(3), 2000);
                        }
                    }, 500);
                } else {
                    // No match
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        flippedCards = [];
                        canFlip = true;
                    }, 1000);
                }
            }
        }

        // ============================================
        // LEVEL 3: CIPHER
        // ============================================
        function checkCipher() {
            const input = document.getElementById('cipherInput').value.toLowerCase().trim();
            const normalized = normalizeSwedish(input);
            const answer = normalizeSwedish(CONFIG.cipherAnswer);
            
            if (normalized === answer) {
                // 30% chance to show fake error message
                if (Math.random() < 0.3) {
                    showMessage('message3', 'Fel svar. F칬rs칬k igen!', 'error');
                    setTimeout(() => {
                        showMessage('message3', 'Korrekt! Du kan g친 vidare.', 'success');
                        setTimeout(() => showView(4), 1500);
                    }, 1000);
                } else {
                    showMessage('message3', 'Korrekt! Du kan g친 vidare.', 'success');
                    setTimeout(() => showView(4), 1500);
                }
            } else {
                showMessage('message3', 'Fel svar. F칬rs칬k igen!', 'error');
            }
        }

        // ============================================
        // LEVEL 4: LOGIC PUZZLE
        // ============================================
        function initLogicPuzzle() {
            const grid = document.getElementById('logicGrid');
            grid.innerHTML = '';
            
            const fishers = ['Erik', 'Lisa', 'Olle', 'Sara'];
            const fishes = ['Lax', 'Abborre', 'G칛dda', 'Ruda'];
            const methods = ['Flugfiske', 'Spinnfiske', 'Grundfiske', 'Isfiske'];
            
            // Header row
            const headers = ['Fiskare', 'Fisk', 'Metod'];
            headers.forEach(header => {
                const cell = document.createElement('div');
                cell.className = 'logic-header';
                cell.textContent = header;
                grid.appendChild(cell);
            });
            
            // Create rows for each fisher
            fishers.forEach(fisher => {
                // Fisher name
                const fisherCell = document.createElement('div');
                fisherCell.className = 'logic-header';
                fisherCell.textContent = fisher;
                grid.appendChild(fisherCell);
                
                // Fish select
                const fishCell = document.createElement('div');
                fishCell.className = 'logic-cell';
                const fishSelect = document.createElement('select');
                fishSelect.id = `logic-${fisher.toLowerCase()}-fish`;
                fishSelect.innerHTML = '<option value="">V칛lj fisk...</option>';
                fishes.forEach(fish => {
                    fishSelect.innerHTML += `<option value="${fish.toLowerCase()}">${fish}</option>`;
                });
                fishCell.appendChild(fishSelect);
                grid.appendChild(fishCell);
                
                // Method select
                const methodCell = document.createElement('div');
                methodCell.className = 'logic-cell';
                const methodSelect = document.createElement('select');
                methodSelect.id = `logic-${fisher.toLowerCase()}-method`;
                methodSelect.innerHTML = '<option value="">V칛lj metod...</option>';
                methods.forEach(method => {
                    methodSelect.innerHTML += `<option value="${method.toLowerCase()}">${method}</option>`;
                });
                methodCell.appendChild(methodSelect);
                grid.appendChild(methodCell);
            });
        }

        function checkLogic() {
            const fishers = ['erik', 'lisa', 'olle', 'sara'];
            let allCorrect = true;
            let allFilled = true;
            
            // Verify all answers are correct
            fishers.forEach(fisher => {
                const correct = CONFIG.logicAnswer[fisher];
                const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                const methodSelect = document.getElementById(`logic-${fisher}-method`);
                
                if (!fishSelect || !methodSelect) {
                    allFilled = false;
                    return;
                }
                
                const selectedFish = fishSelect.value.trim().toLowerCase();
                const selectedMethod = methodSelect.value.trim().toLowerCase();
                
                if (!selectedFish || !selectedMethod) {
                    allFilled = false;
                    return;
                }
                
                // Normalize for comparison (handle Swedish characters)
                const normalizedSelectedFish = normalizeSwedish(selectedFish);
                const normalizedCorrectFish = normalizeSwedish(correct.fish);
                const normalizedSelectedMethod = normalizeSwedish(selectedMethod);
                const normalizedCorrectMethod = normalizeSwedish(correct.method);
                
                if (normalizedSelectedFish !== normalizedCorrectFish || normalizedSelectedMethod !== normalizedCorrectMethod) {
                    allCorrect = false;
                }
            });
            
            if (!allFilled) {
                showMessage('message4', 'V칛lj b친de fisk och metod f칬r alla fiskare!', 'error');
            } else if (allCorrect) {
                // Use the code from CONFIG
                const code = CONFIG.logicCode;
                showMessage('message4', `Korrekt! Koden 칛r: ${code}`, 'success');
                // Show troll popup after completing level 4 (only first time)
                // Kontrollera om popupen redan har visats
                const hasBeenShown = localStorage.getItem('restartTrollPopupShown') === 'true';
                if (!hasBeenShown) {
                    setTimeout(() => {
                        showRestartTrollPopup();
                    }, 1500);
                } else {
                    // Om popupen redan har visats, g친 direkt till n칛sta niv친
                    setTimeout(() => {
                        showView(5);
                    }, 1500);
                }
            } else {
                showMessage('message4', 'Inte helt r칛tt. Kontrollera dina val!', 'error');
            }
        }

        // ============================================
        // LEVEL 5: FISH MATH PUZZLE
        // ============================================
        function initFishMath() {
            // Clear any previous input
            const input = document.getElementById('fishCodeInput');
            if (input) {
                input.value = '';
            }
            showMessage('message5', '', '');
        }

        function checkFishMath() {
            const input = document.getElementById('fishCodeInput').value.trim();
            
            if (!input) {
                showMessage('message5', 'Ange en kod!', 'error');
                return;
            }
            
            if (input === CONFIG.fishMathAnswer) {
                // 30% chance to show fake error message
                if (Math.random() < 0.3) {
                    showMessage('message5', 'Fel kod! Kontrollera dina ber칛kningar.', 'error');
                    setTimeout(() => {
                        showMessage('message5', 'Korrekt! Du har klarat alla niv친er!', 'success');
                        setTimeout(() => showView(6), 2000);
                    }, 1000);
                } else {
                    showMessage('message5', 'Korrekt! Du har klarat alla niv친er!', 'success');
                    setTimeout(() => showView(6), 2000);
                }
            } else {
                showMessage('message5', 'Fel kod! Kontrollera dina ber칛kningar.', 'error');
            }
        }

        // ============================================
        // HINTS SYSTEM
        // ============================================
        const hints = {
            1: {
                step1: "T칛nk p친 en svensk f칬rfattare som vann Nobelpriset i litteratur 1909...",
                step2: "Hennes f칬rnamn 칛r Selma och efternamnet b칬rjar p친 L. Hon skrev om Nils Holgersson. Svaret 칛r efternamnet: lagerl칬f"
            },
            2: {
                step1: "Hitta alla par! V칛nd upp tv친 kort i taget och matcha dem. N칛r alla par 칛r hittade f친r du en kod.",
                step2: "N칛r du hittat alla 6 par kommer koden att visas: 2468"
            },
            3: {
                step1: "ROT16 med svenska alfabetet (29 bokst칛ver: A-Z, 칀, 츿, 칐). F칬r att avkoda, skifta 16 steg fram친t. S 칛r position 19, 19+16=35, 35-29=6, position 6 칛r F.",
                step2: "Svenska alfabetet: A(1), B(2), C(3)...S(19)...Y(25), Z(26), 칀(27), 츿(28), 칐(29). F칬r att avkoda 'Syetvscxnbr친', g친 16 steg fram친t fr친n varje bokstav: S(19)+16=35뇑(6), y(25)+16=41뇳(12), e(5)+16=21뇻(21), t(20)+16=36뇮(7), v(22)+16=38뇭(6), s(19)+16=35뇰(9), c(3)+16=19뇹(19), x(24)+16=40뇲(11), n(14)+16=30뇨(1), b(2)+16=18r(18), r(18)+16=34뇬(5), 친(27)+16=43뇵(14). Svaret 칛r 'flugfiskaren'!"
            },
            4: {
                step1: "B칬rja med ledtr친d 1 och 3: Erik fiskar lax eller ruda, Olle fiskar abborre eller g칛dda. Fr친n ledtr친d 13: Exakt en av (Erik, Olle) fiskar lax eller ruda, s친 Erik fiskar lax/ruda och Olle fiskar abborre/g칛dda. Fr친n ledtr친d 16: Olle anv칛nder grundfiske eller isfiske. Fr친n ledtr친d 11: Grundfiske fiskar g칛dda eller ruda. Fr친n ledtr친d 3: Olle fiskar inte ruda, s친 om Olle anv칛nder grundfiske fiskar han g칛dda.",
                step2: "Fr친n ledtr친d 12: Isfiske fiskar lax eller ruda. Fr친n ledtr친d 3: Olle fiskar inte lax eller ruda, s친 Olle kan inte anv칛nda isfiske. D칛rf칬r anv칛nder Olle grundfiske och fiskar g칛dda. Fr친n ledtr친d 15: Erik anv칛nder flugfiske eller spinnfiske. Fr친n ledtr친d 10: Spinnfiske fiskar inte lax/ruda, s친 Erik anv칛nder flugfiske. Fr친n ledtr친d 9: Flugfiske fiskar lax eller ruda. Fr친n ledtr친d 17: Flugfiske fiskar inte ruda, s친 Erik fiskar lax med flugfiske. Fr친n ledtr친d 10: Spinnfiske fiskar abborre eller g칛dda. G칛dda 칛r taget, s친 spinnfiske fiskar abborre. Fr친n ledtr친d 2: Lisa anv칛nder spinnfiske eller isfiske. Fr친n ledtr친d 6: Abborre anv칛nder inte isfiske, s친 Lisa anv칛nder spinnfiske och fiskar abborre. Fr친n ledtr친d 4: Sara anv칛nder grundfiske eller isfiske. Grundfiske 칛r taget, s친 Sara anv칛nder isfiske. Fr친n ledtr친d 12: Isfiske fiskar lax eller ruda. Lax 칛r taget, s친 Sara fiskar ruda. Slutsats: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G칛dda+Grundfiske, Sara=Ruda+Isfiske. Koden: 2468"
            },
            5: {
                step1: "Fr친n ekvation 3: Lax 칑 2 = G칛dda, s친 G칛dda 칛r dubbelt s친 stor som Lax. Fr친n ekvation 5: Lax + G칛dda = 18. Om G칛dda = 2칑Lax, d친 Lax + 2칑Lax = 18, allts친 3칑Lax = 18. Vad 칛r Lax?",
                step2: "Lax = 6 (fr친n 3칑Lax = 18). G칛dda = 12 (fr친n Lax 칑 2). Fr친n ekvation 1: Lax + Abborre = 12, s친 Abborre = 6. Fr친n ekvation 4: Abborre + Ruda = 15, s친 Ruda = 9. Kontroll: G칛dda - Ruda = 12 - 9 = 3 九. Summan: Lax(6) + Abborre(6) + G칛dda(12) + Ruda(9) = 33. Koden 칛r 33."
            }
        };

        let hintStates = {};

        function showHint(level) {
            const hintDiv = document.getElementById('hint' + level);
            if (!hintStates[level]) {
                hintStates[level] = 1;
            } else {
                hintStates[level] = 2;
            }
            
            // Always show fake/troll hints instead of real ones
            if (hintStates[level] === 1) {
                const fakeMessage = fakeHintMessages[Math.floor(Math.random() * fakeHintMessages.length)];
                hintDiv.textContent = fakeMessage;
            } else {
                const fakeMessage2 = fakeHintMessagesStep2[Math.floor(Math.random() * fakeHintMessagesStep2.length)];
                hintDiv.textContent = fakeMessage2;
            }
            
            hintDiv.classList.add('show');
        }
        
        function showFakeHint(level) {
            const hintDiv = document.getElementById('hint' + level);
            const fakeMessage = fakeHintMessages[Math.floor(Math.random() * fakeHintMessages.length)];
            hintDiv.textContent = fakeMessage;
            hintDiv.classList.add('show');
            setTimeout(() => {
                hintDiv.classList.remove('show');
                hintDiv.textContent = '';
            }, 3000);
        }

        // ============================================
        // FINAL REVEAL - R칛kna fiskar (STRESSIGT!)
        // ============================================
        let currentFishRound = 0;
        let fishTimer = null;
        let fishTimeLeft = 15; // Mer tid nu!
        let fishAnswered = false;
        let fishInterval = null;
        let correctFishCount = 0;
        let fishPhase = 'showing'; // 'showing' eller 'counting'
        
        // 5 rundor med olika antal fiskar (fler nu, och de simmar bara en g친ng)
        const fishRounds = [
            { count: 8, text: "R칛kna fiskarna!" },
            { count: 12, text: "R칛kna fiskarna!" },
            { count: 18, text: "R칛kna fiskarna!" },
            { count: 24, text: "R칛kna fiskarna!" },
            { count: 30, text: "R칛kna fiskarna!" }
        ];
        
        const fishEmojis = ['游', '游', '游냐', '游붇', '游낾'];
        
        // ============================================
        // UNDER UPPBYGGNAD SPEL
        // ============================================
        let constructionSequence = [];
        let constructionCurrentStep = 0;
        let constructionButtons = [];

        let errorOverlayTimeout = null;
        let bugInterval = null;

        function initFishCountTest() {
            const container = document.getElementById('fishCountContainer');
            if (!container) return;
            
            // D칬lj error overlay
            const errorOverlay = document.getElementById('errorOverlay');
            if (errorOverlay) {
                errorOverlay.classList.remove('show');
            }
            
            // Starta fiskr칛kningsspelet (synligt, men buggigt)
            currentFishRound = 0;
            fishAnswered = false;
            correctFishCount = 0;
            showFishRound(0);
            
            // D칬lj stort paket och presentkort
            document.getElementById('giftBoxLargeContainer').classList.remove('show');
            document.getElementById('giftCardContainer').classList.remove('show');
            
            // Starta buggar EFTER 10 sekunder (s친 spelet ser normalt ut f칬rst)
            setTimeout(() => {
                startFishBugs();
            }, 10000);
            
            // Efter 40 sekunder, visa error overlay
            if (errorOverlayTimeout) clearTimeout(errorOverlayTimeout);
            errorOverlayTimeout = setTimeout(() => {
                showErrorOverlay();
            }, 40000);
        }

        function startFishBugs() {
            // Stoppa tidigare buggar
            if (bugInterval) clearInterval(bugInterval);
            
            let errorMessageCount = 0;
            const errorMessages = [
                'ERROR: Systemfel!',
                'FEL: Fiskar saknas!',
                'VARNING: Timer fel!',
                'KRITISKT: R칛kning misslyckad!',
                'FEL: Ogiltig input!',
                'ERROR 404: Fiskar hittades inte!',
                'SYSTEMFEL: F칬rs칬k igen!'
            ];
            
            bugInterval = setInterval(() => {
                const container = document.getElementById('fishCountContainer');
                const arena = document.getElementById('fishArena');
                
                // Bugg 1: Fiskar f칬rsvinner slumpm칛ssigt (MER!)
                if (arena) {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.4) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        randomFish.style.opacity = '0';
                        randomFish.style.display = 'none';
                    }
                }
                
                // Bugg 1b: Fiskar dyker upp igen (NY!)
                if (arena && fishPhase === 'showing') {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.2) {
                        const hiddenFish = Array.from(fish).filter(f => f.style.opacity === '0' || f.style.display === 'none');
                        if (hiddenFish.length > 0) {
                            const randomFish = hiddenFish[Math.floor(Math.random() * hiddenFish.length)];
                            randomFish.style.opacity = '1';
                            randomFish.style.display = 'block';
                        }
                    }
                }
                
                // Bugg 2: Timer hoppar
                const timerEl = document.getElementById('fishTimer');
                if (timerEl && fishPhase === 'counting') {
                    if (Math.random() < 0.25) {
                        fishTimeLeft = Math.max(0, fishTimeLeft - Math.floor(Math.random() * 4));
                        timerEl.textContent = fishTimeLeft;
                        timerEl.style.color = '#ff0000';
                        setTimeout(() => {
                            if (timerEl) timerEl.style.color = '';
                        }, 500);
                    }
                }
                
                // Bugg 3: Input-f칛ltet 칛ndrar v칛rde
                const inputEl = document.getElementById('fishInput');
                if (inputEl && fishPhase === 'counting' && Math.random() < 0.2) {
                    const currentValue = parseInt(inputEl.value) || 0;
                    inputEl.value = Math.max(0, currentValue + Math.floor(Math.random() * 7) - 3);
                    inputEl.style.borderColor = '#ff0000';
                    setTimeout(() => {
                        if (inputEl) inputEl.style.borderColor = '';
                    }, 300);
                }
                
                // Bugg 4: Fiskar 칛ndrar position
                if (arena) {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.3) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        const newTop = Math.random() * 300;
                        randomFish.style.top = newTop + 'px';
                        randomFish.style.transform += ` translateX(${Math.random() * 50 - 25}px)`;
                    }
                }
                
                // Bugg 5: Knappar flyttar sig!
                const submitBtn = document.querySelector('.fish-count-submit');
                if (submitBtn && fishPhase === 'counting' && Math.random() < 0.15) {
                    const randomX = Math.random() * 200 - 100;
                    const randomY = Math.random() * 100 - 50;
                    submitBtn.style.transform = `translate(${randomX}px, ${randomY}px)`;
                    submitBtn.style.transition = 'transform 0.3s';
                    setTimeout(() => {
                        if (submitBtn) {
                            submitBtn.style.transform = '';
                        }
                    }, 2000);
                }
                
                // Bugg 6: Error-meddelanden dyker upp (FLER!)
                if (container && Math.random() < 0.15) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = `
                        position: absolute;
                        top: ${Math.random() * 400}px;
                        left: ${Math.random() * 600}px;
                        color: #ff0000;
                        font-size: 1.3em;
                        font-weight: bold;
                        background: rgba(0, 0, 0, 0.9);
                        padding: 12px 24px;
                        border: 3px solid #ff0000;
                        border-radius: 8px;
                        z-index: 1000;
                        animation: errorFlash 0.5s;
                        pointer-events: none;
                        text-shadow: 0 0 10px #ff0000;
                    `;
                    errorMsg.textContent = errorMessages[errorMessageCount % errorMessages.length];
                    errorMessageCount++;
                    container.appendChild(errorMsg);
                    
                    setTimeout(() => {
                        errorMsg.style.opacity = '0';
                        errorMsg.style.transition = 'opacity 0.8s';
                        setTimeout(() => {
                            if (errorMsg.parentNode) {
                                errorMsg.parentNode.removeChild(errorMsg);
                            }
                        }, 800);
                    }, 2000);
                }
                
                // Bugg 7: Text glitchar (MER!)
                const phaseEl = document.getElementById('fishPhase');
                if (phaseEl && Math.random() < 0.15) {
                    const originalText = phaseEl.textContent;
                    const glitchTexts = ['ERROR...', 'FEL...', 'SYSTEMFEL', 'KRASCHAR...', '404'];
                    phaseEl.textContent = glitchTexts[Math.floor(Math.random() * glitchTexts.length)];
                    phaseEl.style.color = '#ff0000';
                    phaseEl.style.textShadow = '0 0 10px #ff0000';
                    setTimeout(() => {
                        if (phaseEl) {
                            phaseEl.textContent = originalText;
                            phaseEl.style.color = '';
                            phaseEl.style.textShadow = '';
                        }
                    }, 400);
                }
                
                // Bugg 8: Fiskar roterar konstigt (MER!)
                if (arena) {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.3) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        const rotation = Math.random() * 720 - 360; // -360 till 360 grader
                        randomFish.style.transform += ` rotate(${rotation}deg)`;
                    }
                }
                
                // Bugg 9: Input-f칛ltet f칬rsvinner/visas (MER!)
                if (inputEl && fishPhase === 'counting' && Math.random() < 0.12) {
                    inputEl.style.opacity = '0';
                    inputEl.style.pointerEvents = 'none';
                    inputEl.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        if (inputEl) {
                            inputEl.style.opacity = '1';
                            inputEl.style.pointerEvents = 'auto';
                            inputEl.style.transform = 'scale(1)';
                        }
                    }, 600);
                }
                
                // Bugg 10: Fiskar simmar ur bild i alla riktningar (MER KAOS!)
                if (arena && fishPhase === 'showing') {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.3) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        // F친 fiskar att simma snabbt ut ur bild i slumpm칛ssig riktning
                        randomFish.style.animation = 'none';
                        randomFish.style.transition = 'transform 0.8s linear';
                        const directions = [
                            `translateX(calc(100vw + 200px)) translateY(${Math.random() * 200 - 100}px)`, // H칬ger
                            `translateX(calc(-100vw - 200px)) translateY(${Math.random() * 200 - 100}px)`, // V칛nster
                            `translateX(${Math.random() * 200 - 100}px) translateY(calc(100vh + 200px))`, // Ner
                            `translateX(${Math.random() * 200 - 100}px) translateY(calc(-100vh - 200px))`, // Upp
                        ];
                        randomFish.style.transform = directions[Math.floor(Math.random() * directions.length)];
                        setTimeout(() => {
                            if (randomFish.parentNode) {
                                randomFish.style.opacity = '0';
                            }
                        }, 800);
                    }
                }
                
                // Bugg 10b: Fiskar byter riktning mitt i simningen (NY!)
                if (arena && fishPhase === 'showing') {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0 && Math.random() < 0.25) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        const directions = ['swimRight', 'swimLeft', 'swimUp', 'swimDown', 
                                          'swimDiagonal1', 'swimDiagonal2', 'swimDiagonal3', 'swimDiagonal4'];
                        const newDirection = directions[Math.floor(Math.random() * directions.length)];
                        randomFish.style.animationName = newDirection;
                    }
                }
                
                // Bugg 11: Arena glitchar (NY!)
                if (arena && Math.random() < 0.1) {
                    arena.style.filter = 'hue-rotate(180deg)';
                    arena.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        if (arena) {
                            arena.style.filter = '';
                            arena.style.transform = '';
                        }
                    }, 300);
                }
                
                // Bugg 12: Timer blinkar r칬tt (NY!)
                if (timerEl && fishPhase === 'counting' && Math.random() < 0.2) {
                    timerEl.style.animation = 'none';
                    timerEl.style.backgroundColor = '#ff0000';
                    timerEl.style.padding = '10px 20px';
                    timerEl.style.borderRadius = '10px';
                    setTimeout(() => {
                        if (timerEl) {
                            timerEl.style.backgroundColor = '';
                            timerEl.style.padding = '';
                            timerEl.style.borderRadius = '';
                            timerEl.style.animation = 'timerPulse 1s infinite';
                        }
                    }, 400);
                }
                
                // Bugg 13: Fiskar dubbleras (NY!)
                if (arena && fishPhase === 'showing' && Math.random() < 0.08) {
                    const fish = arena.querySelectorAll('.swimming-fish');
                    if (fish.length > 0) {
                        const randomFish = fish[Math.floor(Math.random() * fish.length)];
                        const clone = randomFish.cloneNode(true);
                        clone.style.opacity = '0.5';
                        clone.style.transform += ' scale(0.8)';
                        arena.appendChild(clone);
                        setTimeout(() => {
                            if (clone.parentNode) {
                                clone.parentNode.removeChild(clone);
                            }
                        }, 2000);
                    }
                }
                
                // Bugg 14: Text 칛ndrar f칛rg (NY!)
                const textEl = document.querySelector('.fish-count-text');
                if (textEl && Math.random() < 0.12) {
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
                    textEl.style.color = colors[Math.floor(Math.random() * colors.length)];
                    setTimeout(() => {
                        if (textEl) {
                            textEl.style.color = '';
                        }
                    }, 500);
                }
                
                // Bugg 15: Hela containern skakar (NY!)
                if (container && Math.random() < 0.08) {
                    container.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        if (container) {
                            container.style.animation = '';
                        }
                    }, 500);
                }
            }, 800); // Varje 0.8 sekunder f칬r EXTREMT kaos!
        }

        function showErrorOverlay() {
            // Stoppa buggar
            if (bugInterval) {
                clearInterval(bugInterval);
                bugInterval = null;
            }
            
            // Visa error overlay
            const errorOverlay = document.getElementById('errorOverlay');
            if (errorOverlay) {
                errorOverlay.classList.add('show');
                initErrorGame();
            }
        }

        function initErrorGame() {
            const buttonsContainer = document.getElementById('errorButtons');
            const instruction = document.getElementById('errorInstruction');
            const feedback = document.getElementById('errorFeedback');
            
            if (!buttonsContainer) return;
            
            // 칀terst칛ll spel
            constructionSequence = [1, 2, 3, 4];
            constructionCurrentStep = 0;
            constructionButtons = [];
            
            // Skapa knappar i slumpm칛ssig ordning
            const buttonNumbers = [1, 2, 3, 4];
            // Blanda arrayen
            for (let i = buttonNumbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [buttonNumbers[i], buttonNumbers[j]] = [buttonNumbers[j], buttonNumbers[i]];
            }
            
            buttonsContainer.innerHTML = '';
            feedback.textContent = '';
            feedback.className = 'construction-feedback';
            
            buttonNumbers.forEach((num, index) => {
                const btn = document.createElement('button');
                btn.className = 'construction-btn';
                btn.textContent = num;
                btn.dataset.number = num;
                btn.onclick = () => handleErrorClick(num, btn);
                buttonsContainer.appendChild(btn);
                constructionButtons.push(btn);
            });
            
            instruction.textContent = 'Klicka p친 knapparna i r칛tt ordning: 1  2  3  4';
        }

        function handleErrorClick(number, buttonElement) {
            const expectedNumber = constructionSequence[constructionCurrentStep];
            const feedback = document.getElementById('errorFeedback');
            
            if (number === expectedNumber) {
                // R칛tt!
                buttonElement.classList.add('correct');
                buttonElement.classList.add('completed');
                buttonElement.disabled = true;
                constructionCurrentStep++;
                
                if (constructionCurrentStep === constructionSequence.length) {
                    // Alla steg klara!
                    feedback.textContent = 'Perfekt! Systemet 칛r 친terst칛llt! 游꿀';
                    feedback.className = 'construction-feedback correct';
                    
                    // D칬lj overlay efter 1.5 sekunder och g친 vidare
                    setTimeout(() => {
                        const errorOverlay = document.getElementById('errorOverlay');
                        if (errorOverlay) {
                            errorOverlay.classList.remove('show');
                        }
                        showFinalGiftBox();
                    }, 1500);
                } else {
                    feedback.textContent = `Bra! N칛sta: ${constructionSequence[constructionCurrentStep]}`;
                    feedback.className = 'construction-feedback correct';
                }
            } else {
                // Fel!
                buttonElement.classList.add('wrong');
                feedback.textContent = 'Fel! B칬rja om fr친n b칬rjan.';
                feedback.className = 'construction-feedback wrong';
                
                // 칀terst칛ll alla knappar
                setTimeout(() => {
                    constructionCurrentStep = 0;
                    constructionButtons.forEach(btn => {
                        btn.classList.remove('correct', 'wrong', 'completed');
                        btn.disabled = false;
                    });
                    feedback.textContent = '';
                    feedback.className = 'construction-feedback';
                }, 1000);
            }
        }
        
        function showFishRound(roundIndex) {
            const container = document.getElementById('fishCountContainer');
            if (!container || roundIndex >= fishRounds.length) {
                // Alla rundor klara - visa stort paket!
                showFinalGiftBox();
                return;
            }
            
            const round = fishRounds[roundIndex];
            currentFishRound = roundIndex;
            fishTimeLeft = 15;
            fishAnswered = false;
            fishPhase = 'showing';
            
            container.innerHTML = `
                <div class="fish-count-question">
                    <div class="fish-count-round">Runda ${roundIndex + 1} av ${fishRounds.length}</div>
                    <div class="fish-count-phase" id="fishPhase">Titta p친 fiskarna...</div>
                    <div class="fish-count-text">${round.text}</div>
                    <div class="fish-count-timer" id="fishTimer" style="display: none;"></div>
                    
                    <div class="fish-arena" id="fishArena"></div>
                    
                    <div class="fish-count-input-container" id="fishInputContainer" style="display: none;">
                        <input type="number" class="fish-count-input" id="fishInput" placeholder="Hur m친nga fiskar?" min="0" max="50" autofocus>
                        <button class="fish-count-submit" onclick="submitFishAnswer()">Svara</button>
                    </div>
                    
                    <div class="fish-count-feedback" id="fishFeedback"></div>
                </div>
            `;
            
            // Skapa fiskar som simmar en g친ng (ingen loop)
            // Tiden b칬rjar EFTER att alla fiskar har simmat f칬rbi
            createSwimmingFish(round.count, true, roundIndex);
        }
        
        function startCountingPhase() {
            fishPhase = 'counting';
            fishTimeLeft = 15;
            
            const phaseEl = document.getElementById('fishPhase');
            const timerEl = document.getElementById('fishTimer');
            const inputContainer = document.getElementById('fishInputContainer');
            const arena = document.getElementById('fishArena');
            
            // Stoppa alla fisk-animationer och ta bort dem fr친n sk칛rmen
            if (arena) {
                const allFish = arena.querySelectorAll('.swimming-fish');
                allFish.forEach(fish => {
                    // Stoppa animationen helt
                    fish.style.animation = 'none';
                    fish.style.animationName = 'none';
                    fish.style.animationPlayState = 'paused';
                    fish.style.opacity = '0';
                    fish.style.display = 'none';
                    fish.style.visibility = 'hidden';
                });
                // Rensa arenan helt
                arena.innerHTML = '';
            }
            
            if (phaseEl) phaseEl.textContent = 'R칛kna fiskarna nu!';
            if (timerEl) {
                timerEl.style.display = 'block';
                timerEl.textContent = fishTimeLeft;
            }
            if (inputContainer) inputContainer.style.display = 'flex';
            
            // Starta timer
            startFishTimer();
            
            // Fokusera p친 input
            setTimeout(() => {
                const input = document.getElementById('fishInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitFishAnswer();
                        }
                    });
                }
            }, 100);
        }
        
        function createSwimmingFish(count, shouldSwim = true, roundIndex) {
            const arena = document.getElementById('fishArena');
            if (!arena) return;
            
            // Rensa gamla fiskar
            arena.innerHTML = '';
            
            const arenaRect = arena.getBoundingClientRect();
            let fishFinished = 0;
            const totalFish = count;
            
            for (let i = 0; i < count; i++) {
                const fish = document.createElement('div');
                fish.className = 'swimming-fish';
                fish.textContent = fishEmojis[Math.floor(Math.random() * fishEmojis.length)];
                
                // Slumpm칛ssig startposition (vertikal)
                const startY = Math.random() * (arenaRect.height - 60);
                fish.style.top = startY + 'px';
                
                // Olika storlekar
                const size = 0.8 + Math.random() * 0.4; // 0.8-1.2x
                fish.style.transform = `scale(${size})`;
                
                // Fiskarna simmar i ALLA riktningar - K A O S!
                if (shouldSwim) {
                    // Slumpm칛ssig startposition (kan vara var som helst)
                    const startX = Math.random() * arenaRect.width;
                    const startY = Math.random() * arenaRect.height;
                    fish.style.left = startX + 'px';
                    fish.style.top = startY + 'px';
                    
                    // V칛lj slumpm칛ssig riktning
                    const directions = ['swimRight', 'swimLeft', 'swimUp', 'swimDown', 
                                      'swimDiagonal1', 'swimDiagonal2', 'swimDiagonal3', 'swimDiagonal4'];
                    const direction = directions[Math.floor(Math.random() * directions.length)];
                    
                    // Olika hastigheter och animation-delays
                    const speed = 2 + Math.random() * 3; // 2-5 sekunder (snabbare = mer kaos!)
                    const delay = Math.random() * 2; // 0-2 sekunder delay
                    
                    // S칛tt animation-egenskaperna SEPARAT f칬r att s칛kerst칛lla att det inte loopar
                    fish.style.animationName = direction;
                    fish.style.animationDuration = `${speed}s`;
                    fish.style.animationTimingFunction = 'linear';
                    fish.style.animationDelay = `${delay}s`;
                    fish.style.animationIterationCount = '1'; // BARA EN G칀NG!
                    fish.style.animationFillMode = 'forwards';
                    fish.style.animationPlayState = 'running';
                    
                    // N칛r animationen 칛r klar, r칛kna upp och stoppa animationen
                    const handleAnimationEnd = () => {
                        // Stoppa animationen explicit
                        fish.style.animation = 'none';
                        fish.style.animationName = 'none';
                        fish.style.opacity = '0';
                        fish.style.display = 'none';
                        
                        // Ta bort event listener s친 den inte triggas igen
                        fish.removeEventListener('animationend', handleAnimationEnd);
                        
                        fishFinished++;
                        // N칛r alla fiskar har simmat f칬rbi, starta r칛kningsfasen!
                        if (fishFinished === totalFish) {
                            startCountingPhase();
                        }
                    };
                    
                    fish.addEventListener('animationend', handleAnimationEnd, { once: true });
                }
                
                arena.appendChild(fish);
            }
        }
        
        function startFishTimer() {
            if (fishTimer) {
                clearInterval(fishTimer);
            }
            
            fishTimer = setInterval(() => {
                if (fishPhase !== 'counting') return;
                
                fishTimeLeft--;
                const timerEl = document.getElementById('fishTimer');
                if (timerEl) {
                    timerEl.textContent = fishTimeLeft;
                    
                    if (fishTimeLeft <= 0) {
                        // Tiden 칛r ute!
                        clearInterval(fishTimer);
                        if (!fishAnswered) {
                            const feedbackEl = document.getElementById('fishFeedback');
                            feedbackEl.textContent = `낌勇 Tiden 칛r ute! R칛tt svar var ${fishRounds[currentFishRound].count}`;
                            feedbackEl.className = 'fish-count-feedback timeout';
                            
                            // Disable input
                            const input = document.getElementById('fishInput');
                            const submitBtn = document.querySelector('.fish-count-submit');
                            if (input) input.disabled = true;
                            if (submitBtn) submitBtn.disabled = true;
                            
                            setTimeout(() => {
                                showFishRound(currentFishRound + 1);
                            }, 2000);
                        }
                    }
                }
            }, 1000);
        }
        
        function submitFishAnswer() {
            if (fishAnswered) return;
            
            const input = document.getElementById('fishInput');
            const feedbackEl = document.getElementById('fishFeedback');
            const submitBtn = document.querySelector('.fish-count-submit');
            
            if (!input || !feedbackEl) return;
            
            const answer = parseInt(input.value);
            const correctAnswer = fishRounds[currentFishRound].count;
            
            fishAnswered = true;
            clearInterval(fishTimer);
            
            // Disable input
            input.disabled = true;
            if (submitBtn) submitBtn.disabled = true;
            
            if (answer === correctAnswer) {
                correctFishCount++;
                feedbackEl.textContent = `九 R칛tt! Det var ${correctAnswer} fiskar!`;
                feedbackEl.className = 'fish-count-feedback correct';
            } else {
                feedbackEl.textContent = `仇 Fel! Det var ${correctAnswer} fiskar, inte ${answer || 0}`;
                feedbackEl.className = 'fish-count-feedback wrong';
            }
            
            // G친 vidare efter 2 sekunder
            setTimeout(() => {
                showFishRound(currentFishRound + 1);
            }, 2000);
        }
        
        function showFinalGiftBox() {
            // Stoppa buggar
            if (bugInterval) {
                clearInterval(bugInterval);
                bugInterval = null;
            }
            if (errorOverlayTimeout) {
                clearTimeout(errorOverlayTimeout);
                errorOverlayTimeout = null;
            }
            
            // Alla fr친gor besvarade - visa stort paket f칬r 칬ppning!
            const container = document.getElementById('negationTestContainer');
            if (container) {
                container.innerHTML = '';
                container.style.display = 'none';
            }
            
            // D칬lj fiskr칛kningsspelet
            const fishContainer = document.getElementById('fishCountContainer');
            if (fishContainer) {
                fishContainer.style.display = 'none';
            }
            
            // Visa paketet
            document.getElementById('giftBoxLargeContainer').classList.add('show');
            const giftBox = document.getElementById('giftBoxLarge');
            if (giftBox) {
                giftBox.style.display = 'flex';
            }
            document.getElementById('openInstruction').style.display = 'block';
            document.getElementById('openInstruction').textContent = 'Klicka p친 knappen f칬r att 칬ppna paketet!';
            const openBtn = document.getElementById('openPackageBtn');
            if (openBtn) {
                openBtn.style.display = 'block';
            }
            
            // Reset state f칬r f칛rgsekvens-spel
            sequenceGameStarted = false;
            sequenceLevel = 1;
            sequence = [];
            playerSequence = [];
            colorPositions = [0, 1, 2, 3];
            stopColorEffects();
        }
        
        
        // 칐ppningssekvens: F칛rgsekvens-spel (Simon Says) - MYCKET SV칀RARE!
        let sequenceGameStarted = false;
        let sequenceLevel = 1;
        let sequence = [];
        let playerSequence = [];
        let isShowingSequence = false;
        let isPlayerTurn = false;
        const colors = ['red', 'blue', 'yellow', 'green'];
        const MAX_SEQUENCE_LEVEL = 7; // Fler niv친er!
        let colorPositions = [0, 1, 2, 3]; // Positioner f칬r f칛rgerna
        let movementInterval = null;
        let distractionInterval = null;
        let colorButtonMap = {}; // Mappar f칛rg -> knapp element
        
        function handleOpenPackage() {
            if (!sequenceGameStarted) {
                // Troll-effekter!
                applyTrollEffects();
                
                // Starta f칛rgsekvens-spelet!
                startSequenceGame();
            }
        }

        function handleGiftBoxClick(e) {
            const now = Date.now();
            const timeSinceLastClick = now - lastClickTime;
            const isDoubleClick = timeSinceLastClick < 300;
            lastClickTime = now;
            
            // Troll-effekter varje g친ng man klickar!
            applyTrollEffects();
            
            if (!sequenceGameStarted && isDoubleClick) {
                // Starta f칛rgsekvens-spelet!
                startSequenceGame();
            }
        }
        
        function startSequenceGame() {
            sequenceGameStarted = true;
            sequenceLevel = 1;
            sequence = [];
            playerSequence = [];
            
            document.getElementById('giftBoxLarge').style.display = 'none';
            document.getElementById('openInstruction').style.display = 'none';
            const openBtn = document.getElementById('openPackageBtn');
            if (openBtn) {
                openBtn.style.display = 'none';
            }
            const continueBtn = document.getElementById('continueButton');
            if (continueBtn) {
                continueBtn.style.display = 'none';
            }
            document.getElementById('colorSequenceContainer').classList.add('active');
            
            // S칛tt upp f칛rgknapp-mappning
            setupColorButtonMap();
            
            // Starta kontinuerlig r칬relse
            startColorMovement();
            
            // Starta distraktionsblinkningar
            startDistractionBlinks();
            
            // Starta f칬rsta niv친n
            startSequenceLevel();
        }
        
        function setupColorButtonMap() {
            colorButtonMap = {
                'red': document.getElementById('colorRed'),
                'blue': document.getElementById('colorBlue'),
                'yellow': document.getElementById('colorYellow'),
                'green': document.getElementById('colorGreen')
            };
        }
        
        function startColorMovement() {
            // F칛rgerna kan r칬ra sig lite n칛r det 칛r spelarens tur (men inte byta position automatiskt)
            // Positionbytet sker bara efter sekvensen!
            movementInterval = setInterval(() => {
                if (isPlayerTurn && !isShowingSequence) {
                    // Liten subtil r칬relse, men INTE positionbyte (det sker bara efter sekvensen)
                    const buttons = document.querySelectorAll('.color-button');
                    buttons.forEach(btn => {
                        if (Math.random() < 0.1) { // 10% chans f칬r liten r칬relse
                            btn.classList.add('moving');
                            setTimeout(() => {
                                btn.classList.remove('moving');
                            }, 3000);
                        }
                    });
                }
            }, 3000);
        }
        
        function shuffleColorPositions() {
            // Blanda positionerna - TYDLIG VISUELL ANIMATION!
            const grid = document.querySelector('.color-grid');
            const buttons = Array.from(grid.querySelectorAll('.color-button'));
            
            // Fisher-Yates shuffle av positioner
            const positions = [0, 1, 2, 3];
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }
            
            colorPositions = positions;
            
            // TYDLIG VISUELL FLYTT - knapparna flyttas med stor animation!
            buttons.forEach((btn, index) => {
                const newIndex = colorPositions[index];
                
                // F칬rst: g칬r knappen st칬rre och lite transparent (visar att den flyttas)
                btn.style.transform = 'scale(1.2)';
                btn.style.opacity = '0.7';
                btn.style.zIndex = '10';
                btn.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Flytta position
                btn.style.order = newIndex;
                
                // Efter animation: 친terst칛ll
                setTimeout(() => {
                    btn.style.transform = '';
                    btn.style.opacity = '';
                    btn.style.zIndex = '';
                    btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }, 600);
            });
        }
        
        function startDistractionBlinks() {
            // Distraktionsblinkningar - INTE under sekvensen, bara innan och efter!
            distractionInterval = setInterval(() => {
                // Bara n칛r det INTE 칛r sekvensen som visas
                if (!isShowingSequence) {
                    const buttons = document.querySelectorAll('.color-button');
                    const randomButton = buttons[Math.floor(Math.random() * buttons.length)];
                    
                    // Glitch/blink effekt
                    randomButton.classList.add('distraction');
                    setTimeout(() => {
                        randomButton.classList.remove('distraction');
                    }, 200);
                }
            }, 600 + Math.random() * 800); // Var 0.6-1.4 sekunder
        }
        
        function doGlitchEffect() {
            // Glitch-effekt innan sekvensen b칬rjar
            const buttons = document.querySelectorAll('.color-button');
            let glitchCount = 0;
            const maxGlitches = 3;
            
            const glitchInterval = setInterval(() => {
                buttons.forEach(btn => {
                    if (Math.random() < 0.4) {
                        btn.classList.add('distraction');
                        setTimeout(() => {
                            btn.classList.remove('distraction');
                        }, 150);
                    }
                });
                
                glitchCount++;
                if (glitchCount >= maxGlitches) {
                    clearInterval(glitchInterval);
                }
            }, 200);
        }
        
        function stopColorEffects() {
            if (movementInterval) {
                clearInterval(movementInterval);
                movementInterval = null;
            }
            if (distractionInterval) {
                clearInterval(distractionInterval);
                distractionInterval = null;
            }
        }
        
        function startSequenceLevel() {
            const instruction = document.getElementById('sequenceInstruction');
            const levelDisplay = document.getElementById('sequenceLevel');
            const continueBtn = document.getElementById('continueButton');
            
            if (continueBtn) {
                continueBtn.style.display = 'none';
            }
            
            levelDisplay.textContent = `Niv친 ${sequenceLevel} av ${MAX_SEQUENCE_LEVEL}`;
            instruction.textContent = 'F칬rbereder...';
            
            // L칛gg till en ny f칛rg till sekvensen (bara om sekvensen inte redan 칛r byggd)
            if (sequence.length < sequenceLevel) {
                sequence.push(colors[Math.floor(Math.random() * colors.length)]);
            }
            
            // GLITCH-EFFEKT INNAN!
            doGlitchEffect();
            
            // Visa sekvensen (INGEN positionbyte innan!)
            setTimeout(() => {
                instruction.textContent = 'Titta N O G A p친 sekvensen!';
                isShowingSequence = true;
                isPlayerTurn = false;
                disableAllButtons();
                
                setTimeout(() => {
                    showSequence(0);
                }, 500);
            }, 600);
        }
        
        function showSequence(index) {
            if (index >= sequence.length) {
                // Sekvensen 칛r klar - GLITCH EFFEKT EFTER!
                doGlitchEffect();
                
                // EFTER sekvensen - BYT POSITION P칀 F츿RGERNA! (f칬rvirrande!)
                setTimeout(() => {
                    shuffleColorPositions();
                    
                    // Efter positionbytet, nu 칛r det spelarens tur
                    setTimeout(() => {
                        isShowingSequence = false;
                        isPlayerTurn = true;
                        playerSequence = [];
                        enableAllButtons();
                        
                        const instruction = document.getElementById('sequenceInstruction');
                        instruction.textContent = 'Upprepa sekvensen! (F칛rgerna har flyttat sig!)';
                    }, 700); // Efter positionbytet 칛r klar
                }, 600); // Efter glitch
                return;
            }
            
            const color = sequence[index];
            // Hitta r칛tt knapp baserat p친 f칛rg (inte position!)
            const button = colorButtonMap[color];
            
            if (!button) return;
            
            // Flash-knappen - MYCKET STARKARE OCH TYDLIGARE!
            button.classList.add('flash');
            playColorSound(color);
            
            setTimeout(() => {
                button.classList.remove('flash');
                
                // Paus mellan f칛rgerna
                setTimeout(() => {
                    showSequence(index + 1);
                }, 300);
            }, 600); // L칛ngre flash f칬r att vara tydligare!
        }
        
        function handleColorClick(color) {
            if (!isPlayerTurn || isShowingSequence) return;
            
            // Hitta r칛tt knapp baserat p친 f칛rg (inte position!)
            const button = colorButtonMap[color];
            if (!button) return;
            
            button.classList.add('pressed');
            playColorSound(color);
            
            setTimeout(() => {
                button.classList.remove('pressed');
            }, 200);
            
            playerSequence.push(color);
            
            // Kolla om sekvensen 칛r korrekt s친 l친ngt
            const currentIndex = playerSequence.length - 1;
            if (playerSequence[currentIndex] !== sequence[currentIndex]) {
                // Fel! B칬rja om
                wrongSequence();
                return;
            }
            
            // EFTER att spelaren klickat r칛tt - BYT POSITION P칀 F츿RGERNA! (ibland)
            // Men inte om det var sista f칛rgen i sekvensen
            if (playerSequence.length < sequence.length) {
                // 60% chans att f칛rgerna flyttar sig efter varje klick!
                if (Math.random() < 0.6) {
                    setTimeout(() => {
                        // Byt position p친 en eller flera andra f칛rger (inte den som just klickades)
                        shuffleSomeColors(color);
                    }, 400); // Efter en kort delay
                }
            }
            
            // Om spelaren har klickat hela sekvensen korrekt
            if (playerSequence.length === sequence.length) {
                // Stoppa spelarens tur direkt
                isPlayerTurn = false;
                disableAllButtons();
                
                if (sequenceLevel >= MAX_SEQUENCE_LEVEL) {
                    // Alla niv친er klara!
                    const instruction = document.getElementById('sequenceInstruction');
                    if (instruction) {
                        instruction.textContent = '游꿀 Alla niv친er klara! 游꿀';
                    }
                    stopColorEffects();
                    
                    // G친 direkt till view7 efter en kort f칬rdr칬jning
                    setTimeout(() => {
                        handleContinueAfterSequence();
                    }, 1500);
                } else {
                    // N칛sta niv친
                    sequenceLevel++;
                    playerSequence = [];
                    
                    const instruction = document.getElementById('sequenceInstruction');
                    if (instruction) {
                        instruction.textContent = 'R칛tt! F칬rbereder n칛sta niv친...';
                    }
                    
                    setTimeout(() => {
                        startSequenceLevel();
                    }, 1500);
                }
            }
        }
        
        function shuffleSomeColors(clickedColor) {
            // Byt position p친 1-2 andra f칛rger (inte den som just klickades)
            const otherColors = colors.filter(c => c !== clickedColor);
            const numToShuffle = Math.random() < 0.5 ? 1 : 2; // 1 eller 2 f칛rger
            
            // Blanda positionerna
            const grid = document.querySelector('.color-grid');
            const buttons = Array.from(grid.querySelectorAll('.color-button'));
            
            // V칛lj slumpm칛ssiga f칛rger att flytta (utom den som klickades)
            const colorsToShuffle = [];
            const shuffled = [...otherColors];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            for (let i = 0; i < numToShuffle && i < shuffled.length; i++) {
                colorsToShuffle.push(shuffled[i]);
            }
            
            // Hitta knapparna f칬r dessa f칛rger och byt deras positioner
            const buttonsToMove = colorsToShuffle.map(c => colorButtonMap[c]).filter(b => b);
            
            if (buttonsToMove.length > 0) {
                // Blanda positionerna f칬r dessa knappar
                const currentOrders = buttonsToMove.map(btn => parseInt(btn.style.order) || Array.from(buttons).indexOf(btn));
                const newOrders = [...currentOrders];
                
                // Fisher-Yates shuffle
                for (let i = newOrders.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newOrders[i], newOrders[j]] = [newOrders[j], newOrders[i]];
                }
                
                // Flytta knapparna
                buttonsToMove.forEach((btn, index) => {
                    const newOrder = newOrders[index];
                    btn.style.order = newOrder;
                    btn.style.transform = 'scale(1.15)';
                    btn.style.opacity = '0.8';
                    btn.style.zIndex = '10';
                    btn.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        btn.style.transform = '';
                        btn.style.opacity = '';
                        btn.style.zIndex = '';
                        btn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    }, 500);
                });
            }
        }
        
        function wrongSequence() {
            isPlayerTurn = false;
            disableAllButtons();
            
            const instruction = document.getElementById('sequenceInstruction');
            instruction.textContent = 'Fel! B칬rjar om fr친n b칬rjan...';
            instruction.style.color = '#ff6b6b';
            
            // B칬rja om fr친n niv친 1
            setTimeout(() => {
                sequenceLevel = 1;
                sequence = [];
                playerSequence = [];
                colorPositions = [0, 1, 2, 3]; // 칀terst칛ll positioner
                instruction.style.color = '#ffd700';
                startSequenceLevel();
            }, 2000);
        }
        
        function disableAllButtons() {
            document.querySelectorAll('.color-button').forEach(btn => {
                btn.classList.add('disabled');
            });
        }
        
        function enableAllButtons() {
            document.querySelectorAll('.color-button').forEach(btn => {
                btn.classList.remove('disabled');
            });
        }
        
        function playColorSound(color) {
            // Enkelt ljud f칬r varje f칛rg
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Olika frekvenser f칬r olika f칛rger
            const frequencies = {
                red: 300,
                blue: 400,
                yellow: 500,
                green: 600
            };
            
            oscillator.frequency.value = frequencies[color];
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }
        
        // Setup event listeners f칬r f칛rgknapparna (k칬rs n칛r spelet startar)
        function setupColorButtons() {
            document.getElementById('colorRed').addEventListener('click', () => handleColorClick('red'));
            document.getElementById('colorBlue').addEventListener('click', () => handleColorClick('blue'));
            document.getElementById('colorYellow').addEventListener('click', () => handleColorClick('yellow'));
            document.getElementById('colorGreen').addEventListener('click', () => handleColorClick('green'));
        }
        
        // S칛tt upp event listeners direkt (knapparna finns redan i HTML)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupColorButtons);
        } else {
            setupColorButtons();
        }
        
        function applyTrollEffects() {
            const largeBox = document.getElementById('giftBoxLarge');
            const instruction = document.getElementById('openInstruction');
            
            // Slumpm칛ssiga troll-effekter
            const trollEffect = Math.floor(Math.random() * 6);
            
            switch(trollEffect) {
                case 0:
                    // Paketet r칬r sig
                    const randomX = (Math.random() - 0.5) * 100;
                    const randomY = (Math.random() - 0.5) * 100;
                    largeBox.style.transform = `translate(${randomX}px, ${randomY}px)`;
                    setTimeout(() => {
                        largeBox.style.transform = '';
                    }, 500);
                    break;
                case 1:
                    // Paketet 칛ndrar storlek
                    largeBox.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        largeBox.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            largeBox.style.transform = '';
                        }, 300);
                    }, 300);
                    break;
                case 2:
                    // Falskt "칬ppnar..." meddelande
                    const oldText = instruction.textContent;
                    instruction.textContent = '칐ppnar...';
                    instruction.style.color = '#4caf50';
                    setTimeout(() => {
                        instruction.textContent = oldText;
                        instruction.style.color = '#ffd700';
                    }, 1000);
                    break;
                case 3:
                    // Paketet roterar
                    largeBox.style.transform = 'rotate(180deg)';
                    setTimeout(() => {
                        largeBox.style.transform = 'rotate(0deg)';
                    }, 500);
                    break;
                case 4:
                    // Falskt felmeddelande
                    const oldText2 = instruction.textContent;
                    instruction.textContent = 'Fel! F칬rs칬k igen!';
                    instruction.style.color = '#ff6b6b';
                    setTimeout(() => {
                        instruction.textContent = oldText2;
                        instruction.style.color = '#ffd700';
                    }, 800);
                    break;
                case 5:
                    // Paketet "hoppar"
                    largeBox.style.transform = 'translateY(-30px)';
                    setTimeout(() => {
                        largeBox.style.transform = '';
                    }, 400);
                    break;
            }
        }
        
        function createCornerMarkers() {
            const largeBox = document.getElementById('giftBoxLarge');
            const corners = [
                { position: 'top-left', x: 0, y: 0 },
                { position: 'top-right', x: 100, y: 0 },
                { position: 'bottom-right', x: 100, y: 100 },
                { position: 'bottom-left', x: 0, y: 100 }
            ];
            
            // R칛tt ordning: top-left, bottom-right, top-right, bottom-left
            const correctOrder = [0, 2, 1, 3];
            let currentCornerIndex = 0;
            
            corners.forEach((corner, index) => {
                const marker = document.createElement('div');
                marker.className = 'corner-marker';
                marker.style.position = 'absolute';
                marker.style.left = corner.x + '%';
                marker.style.top = corner.y + '%';
                marker.style.width = '30px';
                marker.style.height = '30px';
                marker.style.border = '2px solid #ffd700';
                marker.style.borderRadius = '50%';
                marker.style.background = 'rgba(255, 215, 0, 0.3)';
                marker.style.cursor = 'pointer';
                marker.style.transform = 'translate(-50%, -50%)';
                marker.dataset.cornerIndex = index;
                marker.onclick = (e) => {
                    e.stopPropagation();
                    if (parseInt(marker.dataset.cornerIndex) === correctOrder[currentCornerIndex]) {
                        // R칛tt h칬rn!
                        marker.style.background = 'rgba(76, 175, 80, 0.5)';
                        currentCornerIndex++;
                        if (currentCornerIndex === 4) {
                            // Alla h칬rn klickade i r칛tt ordning!
                            setTimeout(() => {
                                openGiftBox();
                            }, 500);
                        }
                    } else {
                        // Fel h칬rn - b칬rja om
                        currentCornerIndex = 0;
                        document.querySelectorAll('.corner-marker').forEach(m => {
                            m.style.background = 'rgba(255, 215, 0, 0.3)';
                        });
                    }
                };
                largeBox.appendChild(marker);
            });
        }
        
        function startGiftBoxTrollEffects() {
            // Kontinuerliga troll-effekter var 3-5 sekunder
            giftBoxTrollInterval = setInterval(() => {
                if (giftBoxOpenStep < 3) { // Bara n칛r paketet inte 칛r 칬ppnat
                    const largeBox = document.getElementById('giftBoxLarge');
                    const troll = Math.floor(Math.random() * 4);
                    
                    switch(troll) {
                        case 0:
                            // Paketet "pulsar"
                            largeBox.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                largeBox.style.transform = '';
                            }, 300);
                            break;
                        case 1:
                            // Paketet "skakar"
                            largeBox.style.animation = 'shake 0.5s';
                            setTimeout(() => {
                                largeBox.style.animation = '';
                            }, 500);
                            break;
                        case 2:
                            // Paketet blir lite transparent
                            largeBox.style.opacity = '0.7';
                            setTimeout(() => {
                                largeBox.style.opacity = '1';
                            }, 500);
                            break;
                        case 3:
                            // Paketet "hoppar" lite
                            largeBox.style.transform = 'translateY(-10px)';
                            setTimeout(() => {
                                largeBox.style.transform = '';
                            }, 400);
                            break;
                    }
                }
            }, 3000 + Math.random() * 2000); // Var 3-5 sekunder
        }
        
        function stopGiftBoxTrollEffects() {
            if (giftBoxTrollInterval) {
                clearInterval(giftBoxTrollInterval);
                giftBoxTrollInterval = null;
            }
        }
        
        function updateOpenInstruction() {
            const instruction = document.getElementById('openInstruction');
            if (!sequenceGameStarted) {
                instruction.textContent = 'Dubbelklicka p친 paketet f칬r att b칬rja!';
            }
        }
        
        function showContinueButton() {
            const continueBtn = document.getElementById('continueButton');
            if (continueBtn) {
                continueBtn.style.display = 'block';
                continueBtn.style.animation = 'popupPulse 0.5s ease-out';
            }
        }
        
        function handleContinueAfterSequence() {
            console.log('handleContinueAfterSequence called');
            
            const continueBtn = document.getElementById('continueButton');
            if (continueBtn) {
                continueBtn.style.display = 'none';
                continueBtn.disabled = true; // F칬rhindra dubbelklick
            }
            
            // Se till att f칛rgsekvens-spelet 칛r st칛ngt
            const colorContainer = document.getElementById('colorSequenceContainer');
            if (colorContainer) {
                colorContainer.classList.remove('active');
                colorContainer.style.display = 'none';
                colorContainer.style.visibility = 'hidden';
                colorContainer.style.opacity = '0';
            }
            
            // Stoppa troll-effekter
            stopGiftBoxTrollEffects();
            
            // Stoppa f칛rgr칬relser och distraktionsblinkningar
            stopColorEffects();
            
            // Stoppa popups f칬rst
            stopAnnoyingPopups();
            
            // G친 till view6 (d칛r presentkortet ligger)
            currentLevel = 6;
            localStorage.setItem('escapeRoomLevel', 6);
            updateProgress();
            
            // Anv칛nd en liten f칬rdr칬jning f칬r att s칛kerst칛lla att DOM 칛r redo
            setTimeout(() => {
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
            });
            
            // Show view6 - s칛kerst칛ll att den 칛r synlig
            const view6 = document.getElementById('view6');
            if (view6) {
                view6.classList.add('active');
                view6.style.display = 'block';
                view6.style.visibility = 'visible';
                view6.style.opacity = '1';
            }
            
            // S칛kerst칛ll att final-container 칛r synlig
            const finalContainer = document.querySelector('#view6 .final-container');
            if (finalContainer) {
                finalContainer.style.display = 'flex';
                finalContainer.style.visibility = 'visible';
                finalContainer.style.opacity = '1';
            }
            
            // D칬lj fiskr칛kningsspelet och paketet
            const fishContainer = document.getElementById('fishCountContainer');
            if (fishContainer) {
                fishContainer.style.display = 'none';
            }
            
            const errorOverlay = document.getElementById('errorOverlay');
            if (errorOverlay) {
                errorOverlay.classList.remove('show');
                errorOverlay.style.display = 'none';
            }
            
            const largeBoxContainer = document.getElementById('giftBoxLargeContainer');
            if (largeBoxContainer) {
                largeBoxContainer.classList.remove('show');
                largeBoxContainer.style.display = 'none';
            }
            
            // Visa presentkortet - anv칛nd b친de klass och style f칬r s칛kerhet
            const giftCardContainer = document.getElementById('giftCardContainer');
            if (giftCardContainer) {
                giftCardContainer.classList.add('show');
                giftCardContainer.style.display = 'block';
                giftCardContainer.style.visibility = 'visible';
                giftCardContainer.style.opacity = '1';
            }
            
            // Visa "Vill du b칬rja om?"-fr친gan
            const restartQuestionContainer = document.getElementById('restartQuestionContainer');
            if (restartQuestionContainer) {
                restartQuestionContainer.style.display = 'block';
                restartQuestionContainer.style.visibility = 'visible';
                restartQuestionContainer.style.opacity = '1';
            }
            
            // S칛tt knappen till "Ja" f칬rst
            const restartButton = document.getElementById('restartQuestionButton');
            if (restartButton) {
                restartButton.textContent = 'Ja';
                restartButton.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
                restartButton.onclick = handleRestartQuestionClick;
            }
            
            // Efter 5 sekunder, 칛ndra knappen till "Nej"
            setTimeout(() => {
                const restartButtonAfterDelay = document.getElementById('restartQuestionButton');
                if (restartButtonAfterDelay) {
                    restartButtonAfterDelay.textContent = 'Nej';
                    restartButtonAfterDelay.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
                }
            }, 5000);
            }, 100); // Liten f칬rdr칬jning f칬r att s칛kerst칛lla att DOM 칛r redo
        }
        
        function handleRestartQuestionClick() {
            const restartButton = document.getElementById('restartQuestionButton');
            if (restartButton) {
                const buttonText = restartButton.textContent.trim();
                
                if (buttonText === 'Nej') {
                    // D칬lj "Vill du b칬rja om?"-fr친gan, presentkortet 칛r redan synligt
                    const restartQuestionContainer = document.getElementById('restartQuestionContainer');
                    if (restartQuestionContainer) {
                        restartQuestionContainer.style.display = 'none';
                    }
                    // Presentkortet 칛r redan synligt, s친 vi beh칬ver inte g칬ra n친got mer
                } else {
                    // Om det 칛r "Ja", g칬r ingenting (eller starta om spelet om du vill)
                    // F칬r nu g칬r vi ingenting
                }
            }
        }
        
        function openGiftBox() {
            console.log('openGiftBox called');
            
            // Stoppa troll-effekter
            stopGiftBoxTrollEffects();
            
            // Stoppa f칛rgr칬relser och distraktionsblinkningar
            stopColorEffects();
            
            // Ta bort f칛rgsekvens-spel
            const colorContainer = document.getElementById('colorSequenceContainer');
            if (colorContainer) {
                colorContainer.classList.remove('active');
                colorContainer.style.display = 'none'; // Se till att det 칛r dolt
            }
            
            // D칬lj "Forts칛tt"-knappen om den fortfarande 칛r synlig
            const continueBtn = document.getElementById('continueButton');
            if (continueBtn) {
                continueBtn.style.display = 'none';
            }
            
            // Se till att paketet 칛r synligt f칬rst (f칬r animation)
            const largeBoxContainer = document.getElementById('giftBoxLargeContainer');
            const largeBox = document.getElementById('giftBoxLarge');
            const openBtn = document.getElementById('openPackageBtn');
            const openInstruction = document.getElementById('openInstruction');
            
            if (largeBoxContainer) {
                largeBoxContainer.classList.add('show');
            }
            if (largeBox) {
                largeBox.style.display = 'flex';
                largeBox.classList.add('opening');
            }
            if (openBtn) {
                openBtn.style.display = 'none';
            }
            if (openInstruction) {
                openInstruction.style.display = 'none';
            }
            
            // Efter animation, visa presentkortet
            setTimeout(() => {
                console.log('Showing gift card...');
                if (largeBoxContainer) {
                    largeBoxContainer.classList.remove('show');
                }
                if (largeBox) {
                    largeBox.style.display = 'none';
                }
                
                const giftCardContainer = document.getElementById('giftCardContainer');
                if (giftCardContainer) {
                    giftCardContainer.classList.add('show');
                    giftCardContainer.style.display = 'block'; // Se till att det 칛r synligt
                    console.log('Gift card container shown');
                    
                    // Scrolla till presentkortet om det beh칬vs
                    setTimeout(() => {
                        giftCardContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                } else {
                    console.error('giftCardContainer not found!');
                }
            }, 1500);
        }

        // ============================================
        // ADMIN PANEL
        // ============================================
        function handleTitleClick() {
            titleClickCount++;
            if (titleClickCount >= 7) {
                toggleAdmin();
                titleClickCount = 0;
            }
        }

        function toggleAdmin() {
            adminMode = !adminMode;
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('show', adminMode);
        }

        // Secret test code input
        const SECRET_KEY = 'test123'; // Hemlig kod f칬r att hoppa mellan niv친er

        function showSecretInput() {
            document.getElementById('secretInput').style.display = 'block';
            document.getElementById('secretCodeInput').focus();
        }

        function hideSecretInput() {
            document.getElementById('secretInput').style.display = 'none';
            document.getElementById('secretCodeInput').value = '';
        }

        function checkSecretCode() {
            const input = document.getElementById('secretCodeInput').value;
            if (input === SECRET_KEY) {
                // Visa niv친val-menyn
                document.getElementById('levelSelection').style.display = 'block';
                document.getElementById('secretCodeInput').style.display = 'none';
                document.querySelector('#secretInput button[onclick="checkSecretCode()"]').style.display = 'none';
            } else {
                alert('Fel kod!');
            }
        }

        // Allow Enter key in secret input
        document.addEventListener('DOMContentLoaded', function() {
            const secretInput = document.getElementById('secretCodeInput');
            if (secretInput) {
                secretInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkSecretCode();
                    }
                });
            }
        });

        function goToLevel(level) {
            // Set current level to bypass puzzle checks
            currentLevel = level;
            showView(level);
            if (level === 2) initMemoryGame();
            if (level === 4) initLogicPuzzle();
            if (level === 5) initFishMath();
            if (level === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            if (level === 6) {
                // Se till att paketet 칛r synligt
                setTimeout(() => {
                    showFinalGiftBox();
                }, 100);
            }
            // Update progress
            updateProgress();
            // St칛ng secret input om den 칛r 칬ppen
            hideSecretInput();
        }

        function goToSimonSays() {
            // G친 till niv친 6 f칬rst f칬r att visa paketet
            goToLevel(6);
            // V칛nta lite och starta sedan Simon Says-spelet
            setTimeout(() => {
                const openBtn = document.getElementById('openPackageBtn');
                if (openBtn) {
                    // Simulera klick p친 "칐ppna Paketet"-knappen
                    handleOpenPackage();
                }
            }, 500);
        }
        
        function goToSimonSaysLevel7() {
            // G친 till niv친 6 f칬rst f칬r att visa paketet
            goToLevel(6);
            // V칛nta lite och starta sedan Simon Says-spelet p친 niv친 7
            setTimeout(() => {
                // Starta spelet men hoppa direkt till niv친 7
                startSequenceGameAtLevel(7);
            }, 500);
        }
        
        function startSequenceGameAtLevel(targetLevel) {
            sequenceGameStarted = true;
            sequenceLevel = targetLevel;
            sequence = [];
            playerSequence = [];
            
            document.getElementById('giftBoxLarge').style.display = 'none';
            document.getElementById('openInstruction').style.display = 'none';
            const openBtn = document.getElementById('openPackageBtn');
            if (openBtn) {
                openBtn.style.display = 'none';
            }
            const continueBtn = document.getElementById('continueButton');
            if (continueBtn) {
                continueBtn.style.display = 'none';
            }
            document.getElementById('colorSequenceContainer').classList.add('active');
            
            // S칛tt upp f칛rgknapp-mappning
            setupColorButtonMap();
            
            // Starta kontinuerlig r칬relse
            startColorMovement();
            
            // Starta distraktionsblinkningar
            startDistractionBlinks();
            
            // Bygg upp sekvensen f칬r alla niv친er upp till targetLevel
            for (let i = 1; i <= targetLevel; i++) {
                sequence.push(colors[Math.floor(Math.random() * colors.length)]);
            }
            
            // Starta niv친n (visa sekvensen)
            startSequenceLevel();
        }

        function simulateSimonSaysComplete() {
            console.log('simulateSimonSaysComplete called');
            // St칛ng cheat-menyn f칬rst
            hideSecretInput();
            // Simulera att man har klarat Simon Says - anropa samma funktion som "Forts칛tt"-knappen
            // V칛nta lite s친 att cheat-menyn hinner st칛ngas
            setTimeout(() => {
                handleContinueAfterSequence();
            }, 100);
        }
        
        function goToGiftCard() {
            // G친 direkt till view6 (presentkortet + "Vill du b칬rja om?")
            currentLevel = 6;
            localStorage.setItem('escapeRoomLevel', 6);
            updateProgress();
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
                view.style.display = 'none';
            });
            
            // Show view6
            const view6 = document.getElementById('view6');
            if (view6) {
                view6.classList.add('active');
                view6.style.display = 'block';
            }
            
            // Stoppa popups
            stopAnnoyingPopups();
            
            // D칬lj fiskr칛kningsspelet och paketet
            const fishContainer = document.getElementById('fishCountContainer');
            if (fishContainer) {
                fishContainer.style.display = 'none';
            }
            
            const errorOverlay = document.getElementById('errorOverlay');
            if (errorOverlay) {
                errorOverlay.classList.remove('show');
                errorOverlay.style.display = 'none';
            }
            
            const largeBoxContainer = document.getElementById('giftBoxLargeContainer');
            if (largeBoxContainer) {
                largeBoxContainer.classList.remove('show');
                largeBoxContainer.style.display = 'none';
            }
            
            // Visa presentkortet
            const giftCardContainer = document.getElementById('giftCardContainer');
            if (giftCardContainer) {
                giftCardContainer.classList.add('show');
                giftCardContainer.style.display = 'block';
            }
            
            // Visa "Vill du b칬rja om?"-fr친gan
            const restartQuestionContainer = document.getElementById('restartQuestionContainer');
            if (restartQuestionContainer) {
                restartQuestionContainer.style.display = 'block';
                restartQuestionContainer.style.visibility = 'visible';
                restartQuestionContainer.style.opacity = '1';
            }
            
            // S칛tt knappen till "Ja" f칬rst
            const restartButton = document.getElementById('restartQuestionButton');
            if (restartButton) {
                restartButton.textContent = 'Ja';
                restartButton.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
                restartButton.onclick = handleRestartQuestionClick;
            }
            
            // Efter 5 sekunder, 칛ndra knappen till "Nej"
            setTimeout(() => {
                const restartButtonAfterDelay = document.getElementById('restartQuestionButton');
                if (restartButtonAfterDelay) {
                    restartButtonAfterDelay.textContent = 'Nej';
                    restartButtonAfterDelay.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
                }
            }, 5000);
        }

        function resetProgress() {
            localStorage.removeItem('escapeRoomLevel');
            currentLevel = 0;
            
            // Reset captcha interval flag
            stopCaptchaInterval();
            captchaIntervalStarted = false;
            
            showView(0);
            alert('Progress nollst칛lld!');
        }

        function restartGame() {
            if (confirm('츿r du s칛ker p친 att du vill b칬rja om fr친n b칬rjan? All progress kommer att f칬rsvinna.')) {
                localStorage.removeItem('escapeRoomLevel');
                currentLevel = 0;
                hintStates = {};
                
                // Reset captcha interval flag so it can start again
                stopCaptchaInterval();
                captchaIntervalStarted = false;
                
                // Reset all inputs
                const wordInput = document.getElementById('wordInput');
                if (wordInput) wordInput.value = '';
                
                const cipherInput = document.getElementById('cipherInput');
                if (cipherInput) cipherInput.value = '';
                
                const fishCodeInput = document.getElementById('fishCodeInput');
                if (fishCodeInput) fishCodeInput.value = '';
                
                // Reset all messages
                for (let i = 1; i <= 5; i++) {
                    showMessage('message' + i, '', '');
                }
                
                // Reset hints
                for (let i = 1; i <= 5; i++) {
                    const hintDiv = document.getElementById('hint' + i);
                    if (hintDiv) {
                        hintDiv.classList.remove('show');
                        hintDiv.textContent = '';
                    }
                }
                
                // Reset memory game
                stopMemoryCardSwapping();
                matchedPairs = 0;
                flippedCards = [];
                canFlip = true;
                const memoryGrid = document.getElementById('memoryGrid');
                if (memoryGrid) {
                    memoryGrid.innerHTML = '';
                }
                
                // Reset logic puzzle selects
                const fishers = ['erik', 'lisa', 'olle', 'sara'];
                fishers.forEach(fisher => {
                    const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                    const methodSelect = document.getElementById(`logic-${fisher}-method`);
                    if (fishSelect) fishSelect.value = '';
                    if (methodSelect) methodSelect.value = '';
                });
                
                stopAnnoyingPopups();
                stopCaptchaInterval();
                popupCount = 0;
                fakeLevelCompleteShown = {}; // Reset fake level complete
                if (fakeCountdownInterval) {
                    clearInterval(fakeCountdownInterval);
                    const countdown = document.getElementById('fakeCountdown');
                    if (countdown) countdown.remove();
                }
                backgroundMusicPlaying = false;
                showView(0);
            }
        }

        function showAnswers() {
            const answers = `
FACIT:
Niv친 1: ${CONFIG.wordAnswer}
Niv친 2: Hitta alla par i memory-spelet. Koden 칛r: 2468
Niv친 3: ${CONFIG.cipherAnswer} (ROT16 av "${CONFIG.cipherText}")
Niv친 4: Erik=Lax+Flugfiske, Lisa=Abborre+Spinnfiske, Olle=G칛dda+Grundfiske, Sara=Ruda+Isfiske (Kod: 2468)
Niv친 5: Lax=6, Abborre=6, G칛dda=12, Ruda=9. Summa=33
            `;
            alert(answers);
        }

        // ============================================
        // ANNOYING POPUPS SYSTEM
        // ============================================
        let popupInterval = null;
        let popupCount = 0;
        let nextPopupTimeout = null;
        let isPopupOpen = false;
        
        // ============================================
        // TROLL FEATURES
        // ============================================
        const fakeHintMessages = [
            "T칛nk p친 f칛rgen bl친!",
            "Svaret 칛r 42!",
            "Klicka tre g친nger p친 titeln!",
            "Prova att v칛nda sk칛rmen upp och ner!",
            "Svaret finns i fr친gan!",
            "T칛nk utanf칬r boxen!",
            "Anv칛nd kraften, Luke!",
            "Koden 칛r alltid 0000!",
            "Titta i spegeln!",
            "Svaret 칛r i luften!",
            "Prova att blinka tre g친nger!",
            "Svaret 칛r bakl칛nges!",
            "T칛nk p친 en siffra mellan 1 och 10!",
            "Klicka p친 alla knappar samtidigt!",
            "Svaret 칛r i konsolen (F12)!",
            "Prova att sjunga svaret!",
            "T칛nk positivt!",
            "Svaret 칛r alltid 'test'!",
            "Klicka snabbt 100 g친nger!",
            "Svaret finns i URL:en!",
            "Prova att v칛nda p친 tangentbordet!",
            "T칛nk p친 din favoritf칛rg!",
            "Svaret 칛r samma som fr친gan!",
            "Klicka med v칛nster hand om du 칛r h칬gerh칛nt!",
            "Svaret 칛r det f칬rsta du t칛nker p친!"
        ];
        
        const fakeHintMessagesStep2 = [
            "Hmm, det hj칛lpte inte? Prova igen!",
            "Oj, det var fel ledtr친d. F칬rs칬k 칛nd친!",
            "Bara skojade! Du f친r klura sj칛lv!",
            "Haha, trodde du att jag skulle hj칛lpa dig?",
            "N칛, den ledtr친den var inte s친 bra. Forts칛tt gissa!",
            "Oj, det var en distraktion. Ignorera det!",
            "Haha, bara testade om du lyssnade!",
            "N칛, den hj칛lper inte. Du f친r t칛nka sj칛lv!",
            "Bara skojade igen! Ingen hj칛lp h칛r!",
            "Hmm, det var inte r칛tt ledtr친d. F칬rs칬k 칛nd친!"
        ];
        
        let buttonSwapInterval = null;
        let fakeLevelCompleteShown = {};
        let fakeCountdownInterval = null;
        let fakeCountdownTime = 300; // 5 minutes
        let backgroundMusicPlaying = false;
        let audioContext = null;
        let captchaInterval = null;
        let captchaAttempts = 0;
        let captchaIntervalStarted = false;

        const annoyingMessages = [
            "Har du kollat under s칛ngen?",
            "Vet du vad klockan 칛r?",
            "T칛nk om allt 칛r en dr칬m?",
            "Har du gl칬mt n친got?",
            "Vad 칛r meningen med livet?",
            "Klicka h칛r f칬r gratis pengar!",
            "Systemfel: Kontakta support",
            "Din session har g친tt ut. Logga in igen.",
            "Varning: Virus uppt칛ckt!",
            "Uppdatering kr칛vs. Starta om nu?",
            "Fel 404: Hj칛rnan hittades inte",
            "Har du sett mina nycklar?",
            "Vad 칛r 2+2? (Svara snabbt!)",
            "Du har vunnit en bil! Klicka h칛r!",
            "Systemet har uppt칛ckt misst칛nkt aktivitet.",
            "Vill du spara dina 칛ndringar?",
            "Din dator kommer att st칛ngas av om 5 sekunder...",
            "N친gon f칬rs칬ker hacka ditt konto!",
            "Grattis! Du 칛r anv칛ndare #1,000,000!",
            "Varning: Batteriet 칛r l친gt (0%)"
        ];

        function createAnnoyingPopup(message, isMoving = false, hasClose = true) {
            // Don't create if another popup is already open
            if (isPopupOpen) {
                return;
            }
            
            isPopupOpen = true;
            popupCount++;
            
            // Create overlay to block interaction
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.id = 'popupOverlay' + popupCount;
            overlay.onclick = function(e) {
                // Prevent closing by clicking overlay - must click button
                e.stopPropagation();
            };
            document.body.appendChild(overlay);
            
            const popup = document.createElement('div');
            popup.className = 'annoying-popup' + (isMoving ? ' moving' : '');
            popup.id = 'annoyingPopup' + popupCount;
            
            // Center popup or random position
            if (isMoving) {
                const x = Math.random() * (window.innerWidth - 300);
                const y = Math.random() * (window.innerHeight - 200);
                popup.style.left = x + 'px';
                popup.style.top = y + 'px';
            } else {
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            }
            
            // Create illogical button options
            const buttonOptions = [
                { text: "Ja", action: "close" },
                { text: "Nej", action: "close" },
                { text: "Kanske", action: "close" },
                { text: "Avbryt", action: "close" },
                { text: "Forts칛tt", action: "close" },
                { text: "St칛ng", action: "close" },
                { text: "OK", action: "close" },
                { text: "Acceptera", action: "close" },
                { text: "Avvisa", action: "close" },
                { text: "Ignorera", action: "close" }
            ];
            
            // Random button text (all close the popup, but confusing)
            const buttonText = buttonOptions[Math.floor(Math.random() * buttonOptions.length)].text;
            
            // Sometimes add fake buttons that don't work
            const hasFakeButtons = Math.random() > 0.5;
            let buttonsHTML = '';
            
            if (hasFakeButtons) {
                // Add 2-3 fake buttons and 1 real one
                const fakeButtons = ['St칛ng', 'Avbryt', 'OK', 'Forts칛tt', 'Ignorera'].filter(b => b !== buttonText);
                const shuffled = fakeButtons.sort(() => Math.random() - 0.5).slice(0, 2);
                
                buttonsHTML = `
                    <button onclick="this.style.opacity='0.5'; this.disabled=true; setTimeout(() => { this.style.opacity='1'; this.disabled=false; }, 500);" style="margin: 5px;">${shuffled[0]}</button>
                    <button onclick="this.style.opacity='0.5'; this.disabled=true; setTimeout(() => { this.style.opacity='1'; this.disabled=false; }, 500);" style="margin: 5px;">${shuffled[1]}</button>
                    <button onclick="closeAnnoyingPopup(${popupCount})" style="margin: 5px;">${buttonText}</button>
                `;
            } else {
                buttonsHTML = `<button onclick="closeAnnoyingPopup(${popupCount})" style="margin: 5px;">${buttonText}</button>`;
            }
            
            popup.innerHTML = `
                ${hasClose ? '<button class="close-btn" onclick="closeAnnoyingPopup(' + popupCount + ')">칑</button>' : ''}
                <div style="margin-bottom: 15px;">${message}</div>
                <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                    ${buttonsHTML}
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Make it move if isMoving
            if (isMoving) {
                let moveInterval = setInterval(() => {
                    if (!document.getElementById('annoyingPopup' + popupCount)) {
                        clearInterval(moveInterval);
                        return;
                    }
                    const newX = Math.random() * (window.innerWidth - 300);
                    const newY = Math.random() * (window.innerHeight - 200);
                    popup.style.left = newX + 'px';
                    popup.style.top = newY + 'px';
                }, 1000);
                
                // Keep moving indefinitely until closed
            }
            
            // NO AUTO-CLOSE - user must click to close
        }

        function closeAnnoyingPopup(id) {
            const popup = document.getElementById('annoyingPopup' + id);
            const overlay = document.getElementById('popupOverlay' + id);
            
            if (popup) {
                // Cleanup event listeners
                if (popup._cleanup) {
                    popup._cleanup();
                }
                
                popup.style.animation = 'popupPulse 0.3s ease-out reverse';
                setTimeout(() => {
                    popup.remove();
                    if (overlay) overlay.remove();
                    isPopupOpen = false;
                    
                    // Schedule next popup after 60 seconds (1 minute)
                    if (nextPopupTimeout) {
                        clearTimeout(nextPopupTimeout);
                    }
                    nextPopupTimeout = setTimeout(() => {
                        if (currentLevel > 0 && currentLevel < 6 && !isPopupOpen) {
                            const isMoving = Math.random() > 0.7;
                            const message = annoyingMessages[Math.floor(Math.random() * annoyingMessages.length)];
                            createAnnoyingPopup(message, isMoving, true);
                        }
                    }, 60000); // 60 seconds = 1 minute
                }, 300);
            } else if (overlay) {
                overlay.remove();
                isPopupOpen = false;
            }
        }

        function showRestartTrollPopup() {
            // Don't create if another popup is already open
            if (isPopupOpen) {
                return;
            }
            
            // Check if popup has already been shown (bara visa EN g친ng totalt)
            const hasBeenShown = localStorage.getItem('restartTrollPopupShown') === 'true';
            if (hasBeenShown) {
                return; // Visa inte popupen om den redan har visats
            }
            
            // Check how many times popup has been shown (f칬r att veta om det 칛r f칬rsta eller andra g친ngen)
            const popupCount = parseInt(localStorage.getItem('restartTrollPopupCount') || '0');
            const isFirstTime = popupCount === 0;
            
            // Increment counter
            localStorage.setItem('restartTrollPopupCount', (popupCount + 1).toString());
            
            isPopupOpen = true;
            
            // Create overlay to block interaction
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.id = 'popupOverlayTroll';
            overlay.onclick = function(e) {
                e.stopPropagation();
            };
            document.body.appendChild(overlay);
            
            const popup = document.createElement('div');
            popup.className = 'annoying-popup moving';
            popup.id = 'annoyingPopupTroll';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '20000';
            
            // F칬rsta g친ngen: tv친 "Ja"-knappar (troll)
            // Andra g친ngen: "Ja" och "Nej" (riktig valm칬jlighet)
            let buttonsHTML = '';
            if (isFirstTime) {
                // F칬rsta g친ngen: tv친 "Ja"
                buttonsHTML = `
                    <button onclick="handleTrollRestart()" style="font-size: 1.1em; padding: 15px 30px;">Ja</button>
                    <button onclick="handleTrollRestart()" style="font-size: 1.1em; padding: 15px 30px;">Ja</button>
                `;
            } else {
                // Andra g친ngen: "Ja" och "Nej"
                buttonsHTML = `
                    <button onclick="handleTrollRestart()" style="font-size: 1.1em; padding: 15px 30px;">Ja</button>
                    <button onclick="handleTrollRestartCancel()" style="font-size: 1.1em; padding: 15px 30px;">Nej</button>
                `;
            }
            
            popup.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 1.2em;">
                    <strong>Vill du b칬rja om fr친n b칬rjan?</strong>
                </div>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                    ${buttonsHTML}
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Make it move around
            let moveCount = 0;
            const moveInterval = setInterval(() => {
                moveCount++;
                const newX = 50 + (Math.random() - 0.5) * 20; // 40-60%
                const newY = 50 + (Math.random() - 0.5) * 20; // 40-60%
                popup.style.left = newX + '%';
                popup.style.top = newY + '%';
                
                if (moveCount > 20) {
                    clearInterval(moveInterval);
                }
            }, 500);
        }

        function handleTrollRestart() {
            // Actually restart the game!
            const popup = document.getElementById('annoyingPopupTroll');
            const overlay = document.getElementById('popupOverlayTroll');
            if (popup) {
                popup.remove();
            }
            if (overlay) {
                overlay.remove();
            }
            
            isPopupOpen = false;
            
            // Markera att popupen har visats s친 den inte visas igen
            localStorage.setItem('restartTrollPopupShown', 'true');
            
            // Reset everything and restart
            localStorage.removeItem('escapeRoomLevel');
            // INTE reset restartTrollPopupCount eller restartTrollPopupShown - popupen ska bara visas EN g친ng totalt
            currentLevel = 0;
            hintStates = {};
            popupCount = 0;
            
            // Reset all inputs
            const wordInput = document.getElementById('wordInput');
            if (wordInput) wordInput.value = '';
            
            const cipherInput = document.getElementById('cipherInput');
            if (cipherInput) cipherInput.value = '';
            
            const fishCodeInput = document.getElementById('fishCodeInput');
            if (fishCodeInput) fishCodeInput.value = '';
            
            // Reset all messages
            for (let i = 1; i <= 5; i++) {
                showMessage('message' + i, '', '');
            }
            
            // Reset hints
            for (let i = 1; i <= 5; i++) {
                const hintDiv = document.getElementById('hint' + i);
                if (hintDiv) {
                    hintDiv.classList.remove('show');
                    hintDiv.textContent = '';
                }
            }
            
            // Reset memory game
            matchedPairs = 0;
            flippedCards = [];
            canFlip = true;
            const memoryGrid = document.getElementById('memoryGrid');
            if (memoryGrid) {
                memoryGrid.innerHTML = '';
            }
            
            // Reset logic puzzle selects
            const fishers = ['erik', 'lisa', 'olle', 'sara'];
            fishers.forEach(fisher => {
                const fishSelect = document.getElementById(`logic-${fisher}-fish`);
                const methodSelect = document.getElementById(`logic-${fisher}-method`);
                if (fishSelect) fishSelect.value = '';
                if (methodSelect) methodSelect.value = '';
            });
            
            // Stop all popups
            stopAnnoyingPopups();
            
            // Go back to start
            showView(0);
        }

        function handleTrollRestartCancel() {
            // St칛ng popupen utan att starta om - l친t anv칛ndaren forts칛tta
            const popup = document.getElementById('annoyingPopupTroll');
            const overlay = document.getElementById('popupOverlayTroll');
            if (popup) {
                popup.remove();
            }
            if (overlay) {
                overlay.remove();
            }
            
            isPopupOpen = false;
            // Forts칛tt med spelet - g칬r ingenting mer
        }

        function startAnnoyingPopups() {
            // Stop any existing interval
            if (popupInterval) {
                clearInterval(popupInterval);
            }
            
            // Clear any pending popup timeout
            if (nextPopupTimeout) {
                clearTimeout(nextPopupTimeout);
            }
            
            // Show first popup immediately (only if no popup is open)
            if (currentLevel > 0 && currentLevel < 6 && !isPopupOpen) {
                const isMoving = Math.random() > 0.7; // 30% chance of moving popup
                const message = annoyingMessages[Math.floor(Math.random() * annoyingMessages.length)];
                createAnnoyingPopup(message, isMoving, true);
            }
            
            // Don't use interval anymore - popups are scheduled when previous one closes
        }

        function stopAnnoyingPopups() {
            if (popupInterval) {
                clearInterval(popupInterval);
                popupInterval = null;
            }
            stopCaptchaInterval();
            // Close all existing popups
            document.querySelectorAll('.annoying-popup').forEach(popup => popup.remove());
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showMessage(elementId, message, type) {
            const elem = document.getElementById(elementId);
            if (!message) {
                elem.innerHTML = '';
                elem.className = 'message';
                return;
            }
            elem.innerHTML = message;
            elem.className = 'message ' + type;
        }

        function createSnowflakes() {
            const container = document.getElementById('snowflakes');
            const flakes = ['仇', '仇', '仇'];
            
            for (let i = 0; i < 50; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = flakes[Math.floor(Math.random() * flakes.length)];
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.animationDelay = Math.random() * 2 + 's';
                flake.style.opacity = Math.random() * 0.5 + 0.3;
                container.appendChild(flake);
            }
        }

        // ============================================
        // FAKE LOADING SCREEN
        // ============================================
        function showFakeLoadingScreen() {
            const loadingScreen = document.getElementById('fakeLoadingScreen');
            const loadingBar = document.getElementById('fakeLoadingBar');
            const loadingText = document.getElementById('fakeLoadingText');
            const loadingButton = document.getElementById('fakeLoadingButton');
            
            loadingScreen.style.display = 'flex';
            
            let progress = 0;
            let goingWrong = false;
            
            const loadingInterval = setInterval(() => {
                if (progress < 100) {
                    if (Math.random() < 0.3 && progress > 30 && progress < 90) {
                        // Go backwards sometimes
                        progress = Math.max(0, progress - Math.random() * 20);
                        goingWrong = true;
                        loadingBar.classList.add('going-wrong');
                        loadingText.textContent = '칀terst칛ller...';
                    } else {
                        progress += Math.random() * 15;
                        progress = Math.min(100, progress);
                        goingWrong = false;
                        loadingBar.classList.remove('going-wrong');
                        
                        const messages = [
                            'Initierar system...',
                            'Laddar komponenter...',
                            'Verifierar data...',
                            'Kontrollerar anslutning...',
                            'S칛kerhetskontroll...',
                            'N칛stan klar...',
                            'Finaliserar...'
                        ];
                        loadingText.textContent = messages[Math.floor(Math.random() * messages.length)];
                    }
                    
                    loadingBar.style.width = progress + '%';
                } else {
                    clearInterval(loadingInterval);
                    loadingText.textContent = 'Laddning klar!';
                    loadingButton.style.display = 'block';
                }
            }, 300);
        }
        
        function skipFakeLoading() {
            document.getElementById('fakeLoadingScreen').classList.remove('show');
            
            // Now do the real init
            const savedLevel = localStorage.getItem('escapeRoomLevel');
            if (savedLevel) {
                currentLevel = parseInt(savedLevel);
            }
            
            document.getElementById('title').addEventListener('click', handleTitleClick);
            showView(currentLevel);
            updateProgress();
            
            if (currentLevel === 2) initMemoryGame();
            if (currentLevel === 4) initLogicPuzzle();
            if (currentLevel === 5) initFishMath();
            if (currentLevel === 3) {
                document.getElementById('cipherText').textContent = CONFIG.cipherText;
            }
            
            createSnowflakes();
            startBackgroundMusic();
            setupClickSounds();
            startFakeCountdown();
            startFakeSavingMessages();
        }
        
        // ============================================
        // FAKE COUNTDOWN
        // ============================================
        function startFakeCountdown() {
            // Create countdown element
            const countdown = document.createElement('div');
            countdown.className = 'fake-countdown';
            countdown.id = 'fakeCountdown';
            countdown.textContent = 'Tid kvar: 5:00';
            document.body.appendChild(countdown);
            
            let time = 300; // 5 minutes
            fakeCountdownInterval = setInterval(() => {
                time--;
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                countdown.textContent = `Tid kvar: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (time <= 0) {
                    time = 300; // Reset
                }
            }, 1000);
        }
        
        // ============================================
        // FAKE SAVING MESSAGES
        // ============================================
        function startFakeSavingMessages() {
            setInterval(() => {
                if (currentLevel > 0 && currentLevel < 6 && Math.random() < 0.15) {
                    showFakeSavingMessage();
                }
            }, 20000 + Math.random() * 30000); // Every 20-50 seconds
        }
        
        function showFakeSavingMessage() {
            const savingMsg = document.createElement('div');
            savingMsg.className = 'fake-saving-message show';
            savingMsg.textContent = 'Sparar... var god v칛nta';
            document.body.appendChild(savingMsg);
            
            // Never actually save, just show the message
            setTimeout(() => {
                savingMsg.remove();
            }, 5000);
        }
        
        // ============================================
        // AUDIO FUNCTIONS
        // ============================================
        function setupClickSounds() {
            // Create audio context for generating sounds
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio not supported');
                return;
            }
            
            // Add click sounds to all buttons
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && Math.random() < 0.3) {
                    playRandomClickSound();
                }
            });
        }
        
        function playRandomClickSound() {
            if (!audioContext) return;
            
            const sounds = ['beep', 'boop', 'plop', 'ping', 'pop'];
            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Different frequencies for different sounds
            const frequencies = {
                'beep': 440,
                'boop': 330,
                'plop': 220,
                'ping': 880,
                'pop': 550
            };
            
            oscillator.frequency.value = frequencies[sound] || 440;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        function startBackgroundMusic() {
            if (backgroundMusicPlaying) return;
            
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                
                // Christmas melody: "Jingle Bells" simplified
                // Notes: E E E, E E E, E G C D E
                const melody = [
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 400 }, // E (long)
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 329.63, duration: 400 }, // E (long)
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 392.00, duration: 200 }, // G
                    { freq: 261.63, duration: 200 }, // C
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 329.63, duration: 600 }, // E (long)
                    // Rest
                    { freq: 0, duration: 200 },
                    // Repeat with variation
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 400 }, // D (long)
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 293.66, duration: 400 }, // D (long)
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 329.63, duration: 200 }, // E
                    { freq: 293.66, duration: 200 }, // D
                    { freq: 246.94, duration: 200 }, // B
                    { freq: 261.63, duration: 600 }, // C (long)
                ];
                
                let melodyIndex = 0;
                
                function playNote() {
                    if (!backgroundMusicPlaying || !audioContext) return;
                    
                    const note = melody[melodyIndex];
                    
                    if (note.freq > 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = note.freq;
                        oscillator.type = 'triangle'; // Softer sound
                        
                        gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.duration / 1000);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + note.duration / 1000);
                    }
                    
                    melodyIndex = (melodyIndex + 1) % melody.length;
                    
                    setTimeout(playNote, note.duration);
                }
                
                backgroundMusicPlaying = true;
                playNote();
            } catch (e) {
                console.log('Background music not supported');
            }
        }
        
        // ============================================
        // FAKE CAPTCHA
        // ============================================
        let correctCaptchaBoxIndex = -1; // Spara vilken ruta som 칛r korrekt
        
        function showFakeCaptcha() {
            const captcha = document.getElementById('fakeCaptcha');
            const grid = document.getElementById('fakeCaptchaGrid');
            grid.innerHTML = '';
            
            // Create 9 boxes with emoji "images" (no actual traffic lights)
            const emojis = ['游뚱', '游꺕', '游', '驕勇', '救', '游깿', '游꾻', '仇勇', '游꾸'];
            
            // Blanda emojis slumpm칛ssigt
            const shuffledEmojis = [...emojis].sort(() => Math.random() - 0.5);
            
            // V칛lj en slumpm칛ssig korrekt ruta (inte alltid den h칬gra)
            correctCaptchaBoxIndex = Math.floor(Math.random() * 9);
            
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'fake-captcha-image';
                box.dataset.index = i;
                box.textContent = shuffledEmojis[i];
                box.onclick = function() {
                    this.classList.toggle('selected');
                };
                grid.appendChild(box);
            }
            
            captcha.style.display = 'flex';
            captchaAttempts = 0;
        }
        
        function checkFakeCaptcha() {
            const selected = document.querySelectorAll('.fake-captcha-image.selected');
            const message = document.getElementById('fakeCaptchaMessage');
            captchaAttempts++;
            
            // Always fail first 2 attempts, then allow to proceed
            if (captchaAttempts < 3) {
                message.textContent = 'Felaktig verifiering. F칬rs칬k igen.';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    document.querySelectorAll('.fake-captcha-image').forEach(box => {
                        box.classList.remove('selected');
                    });
                    message.textContent = '';
                }, 2000);
            } else {
                // After 3 attempts, allow to proceed
                message.textContent = 'Verifiering lyckades!';
                message.style.color = '#4caf50';
                
                setTimeout(() => {
                    document.getElementById('fakeCaptcha').style.display = 'none';
                    message.textContent = '';
                    message.style.color = '#ff6b6b';
                }, 1500);
            }
        }
        
        function startCaptchaInterval() {
            // Only start once, not every time we switch levels
            if (captchaIntervalStarted) {
                return;
            }
            
            captchaIntervalStarted = true;
            
            // Show captcha immediately (first time only, after loading screen)
            setTimeout(() => {
                if (currentLevel > 0 && currentLevel < 6) {
                    showFakeCaptcha();
                }
            }, 2000);
            
            // Then show every 3 minutes (180000 ms)
            captchaInterval = setInterval(() => {
                if (currentLevel > 0 && currentLevel < 6) {
                    showFakeCaptcha();
                }
            }, 180000); // 3 minutes
        }
        
        function stopCaptchaInterval() {
            if (captchaInterval) {
                clearInterval(captchaInterval);
                captchaInterval = null;
            }
            // Don't reset captchaIntervalStarted here - we want it to stay stopped
        }

        // ============================================
        // START GAME
        // ============================================
        init();
    </script>
</body>
</html>


